
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>restapi.common_types &#8212; restapi  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for restapi.common_types</h1><div class="highlight"><pre>
<span></span><span class="c1"># look for arcpy access, otherwise use open source version</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">from</span> <span class="nn">.rest_utils</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.decorator</span> <span class="k">import</span> <span class="n">decorator</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">munch</span> <span class="k">import</span> <span class="n">munchify</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">.six.moves</span> <span class="k">import</span> <span class="n">urllib</span><span class="p">,</span> <span class="n">zip_longest</span>

<span class="n">__opensource__</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="force_open_source"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.force_open_source">[docs]</a><span class="k">def</span> <span class="nf">force_open_source</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function can be used to explicitly use open source mode, even if arcpy is </span>
<span class="sd">            available.</span>

<span class="sd">    Arg:</span>
<span class="sd">        force: Optional boolean, when True will force restapi to use open </span>
<span class="sd">            source mode. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s1">&#39;__opensource__&#39;</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.open_restapi</span> <span class="k">import</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">GeometryCollection</span><span class="p">,</span> <span class="n">exportReplica</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> \
        <span class="n">partHandler</span><span class="p">,</span> <span class="n">find_ws_type</span><span class="p">,</span> <span class="n">SHP_FTYPES</span><span class="p">,</span> <span class="n">GeocodeHandler</span><span class="p">,</span> <span class="n">Geocoder</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;GeometryCollection&#39;</span><span class="p">,</span> <span class="s1">&#39;exportReplica&#39;</span><span class="p">,</span> <span class="s1">&#39;partHandler&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;find_ws_type&#39;</span><span class="p">,</span> <span class="s1">&#39;SHP_FTYPES&#39;</span><span class="p">,</span> <span class="s1">&#39;GeocodeHandler&#39;</span><span class="p">,</span> <span class="s1">&#39;Geocoder&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">PACKAGE_NAME</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">PACKAGE_NAME</span><span class="p">],</span> <span class="s1">&#39;exportFeatureSet&#39;</span><span class="p">,</span> <span class="n">exportFeatureSet_os</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s1">&#39;exportFeatureSet&#39;</span><span class="p">,</span> <span class="n">exportFeatureSet_os</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.arc_restapi</span> <span class="k">import</span>  <span class="n">Geometry</span><span class="p">,</span> <span class="n">GeometryCollection</span><span class="p">,</span>  <span class="n">find_ws_type</span><span class="p">,</span> <span class="n">GeocodeHandler</span><span class="p">,</span> <span class="n">Geocoder</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;GeometryCollection&#39;</span><span class="p">,</span> <span class="s1">&#39;find_ws_type&#39;</span><span class="p">,</span> <span class="s1">&#39;GeocodeHandler&#39;</span><span class="p">,</span> <span class="s1">&#39;Geocoder&#39;</span><span class="p">]:</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">PACKAGE_NAME</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">f</span><span class="p">,</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">PACKAGE_NAME</span><span class="p">],</span> <span class="s1">&#39;exportFeatureSet&#39;</span><span class="p">,</span> <span class="n">exportFeatureSet_arcpy</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s1">&#39;exportFeatureSet&#39;</span><span class="p">,</span> <span class="n">exportFeatureSet_arcpy</span><span class="p">)</span></div>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># can explicitly choose to use open source</span>
    <span class="k">if</span> <span class="n">FORCE_OPEN_SOURCE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;you have chosen to explicitly use the open source version.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ImportError</span>

    <span class="kn">import</span> <span class="nn">arcpy</span>
    <span class="kn">from</span> <span class="nn">.arc_restapi</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">has_arcpy</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">except</span><span class="p">:</span>
    <span class="c1"># using global is throwing a warning???</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="s1">&#39;__opensource__&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No Arcpy found, some limitations in functionality may apply.&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">.open_restapi</span> <span class="k">import</span> <span class="o">*</span>
    <span class="n">has_arcpy</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">class</span> <span class="nc">Callable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;No Access to arcpy!&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Recursively raise not implemented error for any calls to arcpy:</span>

<span class="sd">                arcpy.management.AddField(...)</span>

<span class="sd">            or:</span>

<span class="sd">                arcpy.AddField_management(...)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">Callable</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">class</span> <span class="nc">ArcpyPlaceholder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Callable</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">arcpy</span> <span class="o">=</span> <span class="n">ArcpyPlaceholder</span><span class="p">()</span>

<span class="n">USE_GEOMETRY_PASSTHROUGH</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#can be set to false to not use @geometry_passthrough</span>

<div class="viewcode-block" id="geometry_passthrough"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.geometry_passthrough">[docs]</a><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">geometry_passthrough</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to return a single geometry if a single geometry was returned</span>
<span class="sd">        in a GeometryCollection(), otherwise returns the full GeometryCollection().</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        func: Function to decorate.</span>
<span class="sd">        *args: Args to pass into function.</span>
<span class="sd">        **kwargs: Keyword args to pass into function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gc</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">USE_GEOMETRY_PASSTHROUGH</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gc</span>
    <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="getFeatureExtent"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.getFeatureExtent">[docs]</a><span class="k">def</span> <span class="nf">getFeatureExtent</span><span class="p">(</span><span class="n">in_features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the extent for a FeatureSet() or GeometryCollection(), must be convertible</span>
<span class="sd">    to a GeometryCollection().</span>

<span class="sd">    Arg:</span>
<span class="sd">        in_features: Input features (Feature|FeatureSet|GeometryCollection|json).</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        An envelope json structure (extent).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">GeometryCollection</span><span class="p">):</span>
        <span class="n">in_features</span> <span class="o">=</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="n">in_features</span><span class="p">)</span>

    <span class="n">extents</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">envelopeAsJSON</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">in_features</span><span class="p">)]</span>
    <span class="n">full_extent</span> <span class="o">=</span> <span class="p">{</span><span class="n">SPATIAL_REFERENCE</span><span class="p">:</span> <span class="n">extents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SPATIAL_REFERENCE</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">{</span><span class="n">XMIN</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span> <span class="n">YMIN</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span> <span class="n">XMAX</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span> <span class="n">YMAX</span><span class="p">:</span> <span class="nb">max</span><span class="p">}</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="n">full_extent</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">extents</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">full_extent</span><span class="p">)</span></div>

<div class="viewcode-block" id="unqualify_fields"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.unqualify_fields">[docs]</a><span class="k">def</span> <span class="nf">unqualify_fields</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes fully qualified field names from a feature set.</span>

<span class="sd">    Arg:</span>
<span class="sd">        fs: restapi.FeatureSet() object or JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

    <span class="n">clean_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">clean</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">clean_fields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">clean</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
        <span class="n">feature_copy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">attributes</span><span class="p">):</span>
            <span class="n">feature_copy</span><span class="p">[</span><span class="n">clean_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">feature_copy</span><span class="p">)</span></div>

<div class="viewcode-block" id="exportFeatureSet_arcpy"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.exportFeatureSet_arcpy">[docs]</a><span class="k">def</span> <span class="nf">exportFeatureSet_arcpy</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="n">include_domains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qualified_fieldnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">append_features</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports FeatureSet (JSON result)  to shapefile or feature class.</span>

<span class="sd">        Args:</span>
<span class="sd">            feature_set: JSON response obtained from a query or FeatureSet() object.</span>
<span class="sd">            out_fc: Output feature class or shapefile.  If the output exists, </span>
<span class="sd">                features are appended at the end.</span>
<span class="sd">                (unless append_features is set to False)</span>
<span class="sd">            include_domains: Optional boolean, if True, will manually create the </span>
<span class="sd">                feature class and add domains to GDB if output is in a geodatabase.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            qualified_fieldnames: Optional boolean, default is False, in situations </span>
<span class="sd">                where there are table joins, there are qualified table names such as </span>
<span class="sd">                [&quot;table1.Field_from_tab1&quot;, &quot;table2.Field_from_tab2&quot;]. By setting </span>
<span class="sd">                this to False, exported fields would be: </span>
<span class="sd">                [&quot;Field_from_tab1&quot;, &quot;Field_from_tab2&quot;].</span>
<span class="sd">            append_features: Optional boolean to append features if the output </span>
<span class="sd">                features already exist.  Set to False to overwrite features.</span>

<span class="sd">        At minimum, feature set must contain these keys:</span>
<span class="sd">            [u&#39;features&#39;, u&#39;fields&#39;, u&#39;spatialReference&#39;, u&#39;geometryType&#39;]</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            A feature class.</span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="k">if</span> <span class="n">__opensource__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exportFeatureSet_os</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">out_fc</span> <span class="o">=</span> <span class="n">validate_name</span><span class="p">(</span><span class="n">out_fc</span><span class="p">)</span>
        <span class="c1"># validate features input (should be list or dict, preferably list)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
            <span class="n">feature_set</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">feature_set</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">qualified_fieldnames</span><span class="p">:</span>
            <span class="n">unqualify_fields</span><span class="p">(</span><span class="n">feature_set</span><span class="p">)</span>

        <span class="c1"># find workspace type and path</span>
        <span class="n">ws</span><span class="p">,</span> <span class="n">wsType</span> <span class="o">=</span> <span class="n">find_ws_type</span><span class="p">(</span><span class="n">out_fc</span><span class="p">)</span>
        <span class="n">isShp</span> <span class="o">=</span> <span class="n">wsType</span> <span class="o">==</span> <span class="s1">&#39;FileSystem&#39;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;in_memory\restapi_%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span> <span class="c1">#if isShp else None</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">out_fc</span>
        <span class="n">gp</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">geoprocessing</span><span class="o">.</span><span class="n">_base</span><span class="o">.</span><span class="n">Geoprocessor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hasGeom</span> <span class="o">=</span> <span class="n">GEOMETRY</span> <span class="ow">in</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not check geometry!&#39;</span><span class="p">)</span>
            <span class="n">hasGeom</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># try converting JSON features from arcpy, seems very fragile...</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="ow">or</span> <span class="p">(</span><span class="n">exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">append_features</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">out_fc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isShp</span><span class="p">:</span>
                <span class="n">out_fc</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arcpy_fs</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">fromEsriJson</span><span class="p">(</span><span class="n">feature_set</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span> <span class="c1">#arcpy.FeatureSet from JSON string</span>
                    <span class="n">arcpy_fs</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_fc</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tmp_json_file</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">arcpy</span><span class="o">.</span><span class="n">conversion</span><span class="o">.</span><span class="n">JSONToFeatures</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">)</span> <span class="c1">#this tool is very buggy :(</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># manually add records with insert cursor</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;arcpy conversion failed, manually writing features...&#39;</span><span class="p">)</span>
                <span class="n">create_empty_schema</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">)</span>
                <span class="n">append_feature_set</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">feature_set</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># append rows</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">fromEsriJson</span><span class="p">(</span><span class="n">feature_set</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;from esri json exception: &#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">tmp_fs</span> <span class="o">=</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tmp_json_file</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">arcpy</span><span class="o">.</span><span class="n">conversion</span><span class="o">.</span><span class="n">JSONToFeatures</span><span class="p">(</span><span class="n">tmp_fs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="s1">&#39;NO_TEST&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;arcpy conversion failed, manually appending features&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">append_feature_set</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">feature_set</span><span class="p">,</span> <span class="n">Cursor</span><span class="p">)</span>

        <span class="c1"># copy in_memory fc to shapefile</span>
        <span class="k">if</span> <span class="n">isShp</span> <span class="ow">and</span> <span class="n">original</span> <span class="o">!=</span> <span class="n">out_fc</span><span class="p">:</span>
            <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CopyFeatures</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
                <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="c1"># add domains</span>
        <span class="k">if</span> <span class="n">include_domains</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isShp</span><span class="p">:</span>
            <span class="n">add_domains_from_feature_set</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">feature_set</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Appended </span><span class="si">{}</span><span class="s1"> features to &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature_set</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">original</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">original</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">original</span></div>


<div class="viewcode-block" id="exportFeatureSet_os"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.exportFeatureSet_os">[docs]</a><span class="k">def</span> <span class="nf">exportFeatureSet_os</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="n">outSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports features (JSON result) to shapefile or feature class.</span>

<span class="sd">        Args:</span>
<span class="sd">            out_fc: Output feature class or shapefile.</span>
<span class="sd">            feature_set: JSON response (feature set) obtained from a query.</span>
<span class="sd">            outSR: Optional output spatial reference.  If none set, will default</span>
<span class="sd">                to SR of result_query feature set. Defaults to None.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Feature class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="kn">import</span> <span class="nn">shp_helper</span>
        <span class="kn">from</span> <span class="nn">.shapefile</span> <span class="k">import</span> <span class="n">shapefile</span>
        <span class="n">out_fc</span> <span class="o">=</span> <span class="n">validate_name</span><span class="p">(</span><span class="n">out_fc</span><span class="p">)</span>
        <span class="c1"># validate features input (should be list or dict, preferably list)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
            <span class="n">feature_set</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">feature_set</span><span class="p">)</span>

        <span class="c1"># make new shapefile</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">fields</span>
        <span class="n">this_sr</span> <span class="o">=</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outSR</span><span class="p">:</span>
            <span class="n">outSR</span> <span class="o">=</span> <span class="n">this_sr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this_sr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outSR</span> <span class="o">!=</span> <span class="n">this_sr</span><span class="p">:</span>
                    <span class="c1"># do not change without reprojecting...</span>
                    <span class="n">outSR</span> <span class="o">=</span> <span class="n">this_sr</span>

        <span class="n">g_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">GEOMETRY_TYPE</span><span class="p">)</span>

        <span class="c1"># add all fields</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">shp_helper</span><span class="o">.</span><span class="n">ShpWriter</span><span class="p">(</span><span class="n">G_DICT</span><span class="p">[</span><span class="n">g_type</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">out_fc</span><span class="p">)</span>
        <span class="n">field_map</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fld</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">OID</span><span class="p">,</span> <span class="n">SHAPE</span><span class="p">]</span> <span class="o">+</span> <span class="n">SKIP_FIELDS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;shape_&#39;</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="s1">&#39;shape.&#39;</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="s1">&#39;(shape)&#39;</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="s1">&#39;objectid&#39;</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fid&#39;</span><span class="p">]):</span>

                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
                    <span class="n">field_type</span> <span class="o">=</span> <span class="n">SHP_FTYPES</span><span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
                    <span class="n">field_length</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;50&quot;</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_type</span><span class="p">,</span> <span class="n">field_length</span><span class="p">)</span>
                    <span class="n">field_map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>

        <span class="c1"># search cursor to write rows</span>
        <span class="n">s_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fl</span> <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">fl</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_map</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">feature_set</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">feat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_map</span><span class="p">]]</span>
            <span class="n">w</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="n">feat</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span><span class="o">.</span><span class="n">asShape</span><span class="p">(),</span> <span class="n">row</span><span class="p">)</span>

        <span class="n">w</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_fc</span><span class="p">))</span>

        <span class="c1"># write projection file</span>
        <span class="n">project</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">outSR</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_fc</span></div>

<span class="k">if</span> <span class="n">has_arcpy</span><span class="p">:</span>
    <span class="n">exportFeatureSet</span> <span class="o">=</span> <span class="n">exportFeatureSet_arcpy</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">exportFeatureSet</span> <span class="o">=</span> <span class="n">exportFeatureSet_os</span>

<div class="viewcode-block" id="exportGeometryCollection"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.exportGeometryCollection">[docs]</a><span class="k">def</span> <span class="nf">exportGeometryCollection</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns and exports a geometry collection to shapefile or feature class.</span>

<span class="sd">    Args:</span>
<span class="sd">        gc: GeometryCollection() object.</span>
<span class="sd">        output: Output data set (will be geometry only).</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: &quot;Input is not a GeometryCollection!&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span> 

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">):</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GeometryCollection</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input is not a GeometryCollection!&#39;</span><span class="p">)</span>

    <span class="n">fs_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WKID</span><span class="p">:</span> <span class="n">gc</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">}</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">GEOMETRY_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">geometryType</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">DISPLAY_FIELD_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">FIELD_ALIASES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">OBJECTID</span><span class="p">:</span> <span class="n">OBJECTID</span><span class="p">}</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">FIELDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">NAME</span><span class="p">:</span> <span class="n">OBJECTID</span><span class="p">,</span>
                        <span class="n">TYPE</span><span class="p">:</span> <span class="n">OID</span><span class="p">,</span>
                        <span class="n">ALIAS</span><span class="p">:</span> <span class="n">OBJECTID</span><span class="p">}]</span>
    <span class="n">fs_dict</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">ATTRIBUTES</span><span class="p">:</span> <span class="p">{</span><span class="n">OBJECTID</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">},</span> <span class="n">GEOMETRY</span><span class="p">:</span><span class="n">ft</span><span class="o">.</span><span class="n">json</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ft</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gc</span><span class="p">)]</span>

    <span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">fs_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exportFeatureSet</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="featureIterator"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.featureIterator">[docs]</a><span class="k">def</span> <span class="nf">featureIterator</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">):</span>
    	<span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
    		<span class="k">yield</span> <span class="n">Feature</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span></div>

<span class="n">FeatureSet</span><span class="o">.</span><span class="fm">__iter__</span> <span class="o">=</span> <span class="n">featureIterator</span>

<div class="viewcode-block" id="Cursor"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Cursor">[docs]</a><span class="k">class</span> <span class="nc">Cursor</span><span class="p">(</span><span class="n">FeatureSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle Cursor object.&quot;&quot;&quot;</span>
    <span class="n">json</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fieldOrder</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Cursor.BaseRow"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Cursor.BaseRow">[docs]</a>    <span class="k">class</span> <span class="nc">BaseRow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to handle Row object.</span>
<span class="sd">        </span>
<span class="sd">        Attributes:</span>
<span class="sd">            feature: A feature JSON object.</span>
<span class="sd">            spatialReference: A spatial reference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">spatialReference</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Row object for Cursor.</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                feature: Features JSON object.</span>
<span class="sd">                spatialReference: A spatial reference.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">Feature</span><span class="p">)</span> <span class="k">else</span> <span class="n">feature</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span> <span class="o">=</span> <span class="n">spatialReference</span>

<div class="viewcode-block" id="Cursor.BaseRow.get"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Cursor.BaseRow.get">[docs]</a>        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Gets/returns an attribute by field name.</span>

<span class="sd">            Arg:</span>
<span class="sd">                field: Name of field for which to get the value.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></div></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_set</span><span class="p">,</span> <span class="n">fieldOrder</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Cursor object for a feature set.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            feature_set: Feature set as json or restapi.FeatureSet() object.</span>
<span class="sd">            fieldOrder: Optional, list of order of fields for cursor row returns. </span>
<span class="sd">                To explicitly specify and OBJECTID field or Shape (geometry field), </span>
<span class="sd">                you must use the field tokens &#39;OID@&#39; and &#39;SHAPE@&#39; respectively.</span>
<span class="sd">                Defaults to [].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
            <span class="n">feature_set</span> <span class="o">=</span> <span class="n">feature_set</span><span class="o">.</span><span class="n">json</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cursor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">feature_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldOrder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__validateOrderBy</span><span class="p">(</span><span class="n">fieldOrder</span><span class="p">)</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">class</span> <span class="nc">Row</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">BaseRow</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Class to handle Row object.&quot;&quot;&quot;</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns a restapi Geometry() object.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">GEOMETRY</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
                    <span class="n">gd</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">)}</span>
                    <span class="k">if</span> <span class="n">SPATIAL_REFERENCE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gd</span><span class="p">:</span>
                        <span class="n">gd</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">spatialReference</span>
                    <span class="k">return</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">gd</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">oid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the OID for row.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns values as tuple.&quot;&quot;&quot;</span>
                <span class="c1"># fix date format in milliseconds to datetime.datetime()</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">field_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">date_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mil_to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">long_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">OID_TOKEN</span><span class="p">:</span>
                            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oid</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="n">SHAPE_TOKEN</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">:</span>
                                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">asShape</span><span class="p">())</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#null Geometry</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Allows for getting a field value by index.</span>
<span class="sd">                </span>
<span class="sd">                Arg:</span>
<span class="sd">                    i: Index to get value from.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># expose Row object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__Row</span> <span class="o">=</span> <span class="n">Row</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the names of any date fields within feature set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DATE_FIELD</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">long_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Field names of type Long Integer, need to know this for use with</span>
<span class="sd">            arcpy.da.InsertCursor() as the values need to be cast to long.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The names of the Long Integer fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">LONG_FIELD</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">field_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets and returns the field names for feature set.&quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldOrder</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">OID_TOKEN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="n">SHAPE_TOKEN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShapeFieldName</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ShapeFieldName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">names</span>

<div class="viewcode-block" id="Cursor.get_rows"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Cursor.get_rows">[docs]</a>    <span class="k">def</span> <span class="nf">get_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns row objects.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createRow</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cursor.rows"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Cursor.rows">[docs]</a>    <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns Cursor.rows() as generator.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createRow</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="Cursor.getRow"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Cursor.getRow">[docs]</a>    <span class="k">def</span> <span class="nf">getRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns row object at index.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_createRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_toJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Casts row to JSON.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">ft</span> <span class="o">=</span> <span class="p">{</span><span class="n">ATTRIBUTES</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShapeFieldName</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">SHAPE_TOKEN</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_fields</span><span class="p">:</span>
                        <span class="n">ft</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_to_mil</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span>
                    <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_fields</span><span class="p">:</span>
                        <span class="n">ft</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ft</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">geom</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">):</span>
                        <span class="n">ft</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">json</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">SPATIAL_REFERENCE</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ft</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">SPATIAL_REFERENCE</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">Feature</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BaseRow</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">feature</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Feature</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">row</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Feature</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns Cursor.rows().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_createRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">spatialReference</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a row based off of the feature and spatial reference.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Row</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">spatialReference</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validateOrderBy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixes &quot;fieldOrder&quot; input fields, accepts esri field tokens too (&quot;SHAPE@&quot;, &quot;OID@&quot;).</span>

<span class="sd">        Arg:</span>
<span class="sd">            fields: List or comma delimited field list.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The list of the fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span> <span class="ow">or</span> <span class="n">fields</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ShapeFieldName&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShapeFieldName</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHAPE_TOKEN</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;OIDFieldName&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">OID_TOKEN</span>

        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonReplica"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.JsonReplica">[docs]</a><span class="k">class</span> <span class="nc">JsonReplica</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a JSON replica.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        json: JSON object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON form input JSON.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLiteReplica"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.SQLiteReplica">[docs]</a><span class="k">class</span> <span class="nc">SQLiteReplica</span><span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a replica stored as a SQLite database.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Represents a replica stored as a SQLite database, this should ALWAYS</span>
<span class="sd">        be used with a context manager.  For example:</span>

<span class="sd">            with SQLiteReplica(r&#39;C:\TEMP\replica.geodatabase&#39;) as con:</span>
<span class="sd">                print(con.list_tables())</span>
<span class="sd">                # do other stuff</span>

<span class="sd">        Arg:</span>
<span class="sd">            path: Full path to .geodatabase file (SQLite database).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">path</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SQLiteReplica</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isClosed</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="SQLiteReplica.execute"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.SQLiteReplica.execute">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes an SQL query.  This method must be used via a &quot;with&quot; statement</span>
<span class="sd">        to ensure the cursor connection is closed.</span>

<span class="sd">        Arg:</span>
<span class="sd">            sql: SQL statement to use.</span>

<span class="sd">        &gt;&gt;&gt; with restapi.SQLiteReplica(r&#39;C:\Temp\test.geodatabase&#39;) as db:</span>
<span class="sd">        &gt;&gt;&gt;     # now do a cursor using with statement</span>
<span class="sd">        &gt;&gt;&gt;     with db.execute(&#39;SELECT * FROM Some_Table&#39;) as cur:</span>
<span class="sd">        &gt;&gt;&gt;         for row in cur.fetchall():</span>
<span class="sd">        &gt;&gt;&gt;             print(row)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLiteReplica.list_tables"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.SQLiteReplica.list_tables">[docs]</a>    <span class="k">def</span> <span class="nf">list_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_esri</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of tables found within sqlite table.</span>

<span class="sd">        Arg:</span>
<span class="sd">            filter_esri -- Optional boolean, filters out all the esri specific </span>
<span class="sd">                tables (GDB_*, ST_*), default is True. If False, all tables will be listed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select name from sqlite_master where type = &#39;table&#39;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filter_esri</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;st_&#39;</span><span class="p">),</span>
                                                     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GDB_&#39;</span><span class="p">),</span>
                                                     <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sqlite_&#39;</span><span class="p">)])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]</span></div>

<div class="viewcode-block" id="SQLiteReplica.list_fields"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.SQLiteReplica.list_fields">[docs]</a>    <span class="k">def</span> <span class="nf">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists fields within a table, returns a list of tuples with the following </span>
<span class="sd">            attributes:</span>

<span class="sd">        cid         name        type        notnull     dflt_value  pk</span>
<span class="sd">        ----------  ----------  ----------  ----------  ----------  ----------</span>
<span class="sd">        0           id          integer     99                      1</span>
<span class="sd">        1           name                    0                       0</span>

<span class="sd">        Arg:</span>
<span class="sd">            table_name: Name of table to get field list from.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA table_info(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="SQLiteReplica.exportToGDB"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.SQLiteReplica.exportToGDB">[docs]</a>    <span class="k">def</span> <span class="nf">exportToGDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_gdb_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports the sqlite database (.geodatabase file) to a File Geodatabase, </span>
<span class="sd">            requires access to arcpy. Warning:  All cursor connections must be </span>
<span class="sd">            closed before running this operation!  If there are open cursors, </span>
<span class="sd">            this can lock down the database.</span>

<span class="sd">        Arg:</span>
<span class="sd">            out_gdb_path: Full path to new file geodatabase. </span>
<span class="sd">                (ex: r&quot;C:\Temp\replica.gdb&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_arcpy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;no access to arcpy!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arcpy</span><span class="o">.</span><span class="n">conversion</span><span class="p">,</span> <span class="n">COPY_RUNTIME_GDB_TO_FILE_GDB</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;arcpy.conversion.</span><span class="si">{}</span><span class="s1"> tool not available!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COPY_RUNTIME_GDB_TO_FILE_GDB</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">out_gdb_path</span><span class="p">):</span>
            <span class="n">out_gdb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_gdb_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_gdb_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gdb&#39;</span><span class="p">):</span>
            <span class="n">out_gdb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_gdb_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.gdb&#39;</span>
        <span class="k">return</span> <span class="n">arcpy</span><span class="o">.</span><span class="n">conversion</span><span class="o">.</span><span class="n">CopyRuntimeGdbToFileGdb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">out_gdb_path</span><span class="p">)</span><span class="o">.</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__safe_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes connection and removes temporary .geodatabase file&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isClosed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">TEMP_DIR</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaned up temporary sqlite database&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__safe_cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__safe_cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArcServer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer">[docs]</a><span class="k">class</span> <span class="nc">ArcServer</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle ArcGIS Server Connection.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        service_cache: List of service cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ArcServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">referer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="ArcServer.getService"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.getService">[docs]</a>    <span class="k">def</span> <span class="nf">getService</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_wildcard</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return Service Object (MapService, FeatureService, GPService, etc).</span>
<span class="sd">        This method supports wildcards.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name_or_wildcard: Service name or wildcard used to grab service name.</span>
<span class="sd">                (ex: &quot;moun_webmap_rest/mapserver&quot; or &quot;*moun*mapserver&quot;)</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: &#39;restapi does not support &quot;{}&quot; services!&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_url</span><span class="p">(</span><span class="n">name_or_wildcard</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full_path</span><span class="p">:</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;MapServer&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MapService</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;FeatureServer&#39;</span><span class="p">:</span>
                 <span class="k">return</span> <span class="n">FeatureService</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;GPServer&#39;</span><span class="p">:</span>
                 <span class="k">return</span> <span class="n">GPService</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;ImageServer&#39;</span><span class="p">:</span>
                 <span class="k">return</span> <span class="n">ImageService</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;GeocodeServer&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Geocoder</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;restapi does not support &quot;</span><span class="si">{}</span><span class="s1">&quot; services!&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapServices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of all MapServer objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_services</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;MapServer&#39;</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">featureServices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of all FeatureServer objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_services</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;FeatureServer&#39;</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imageServices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of all ImageServer objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_services</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ImageServer&#39;</span><span class="p">)]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gpServices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of all GPServer objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_services</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;GPServer&#39;</span><span class="p">)]</span>

<div class="viewcode-block" id="ArcServer.folder"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.folder">[docs]</a>    <span class="k">def</span> <span class="nf">folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a restapi.Folder() object.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name: Name of folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Folder</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ur</span><span class="p">,</span> <span class="n">name</span><span class="p">]),</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArcServer.list_services"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.list_services">[docs]</a>    <span class="k">def</span> <span class="nf">list_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filterer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all services.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_services</span><span class="p">(</span><span class="n">filterer</span><span class="p">))</span></div>

<div class="viewcode-block" id="ArcServer.iter_services"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.iter_services">[docs]</a>    <span class="k">def</span> <span class="nf">iter_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filterer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a generator for all services</span>

<span class="sd">        Arg:</span>
<span class="sd">            token: Optional token to handle security (only required if security is enabled).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="n">full_service_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">NAME</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">TYPE</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_service_url</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">full_service_url</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">serv</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="n">SERVICES</span><span class="p">]:</span>
                <span class="n">full_service_url</span> <span class="o">=</span>  <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">serv</span><span class="p">[</span><span class="n">NAME</span><span class="p">],</span> <span class="n">serv</span><span class="p">[</span><span class="n">TYPE</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_service_url</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">full_service_url</span></div>

<div class="viewcode-block" id="ArcServer.get_service_url"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.get_service_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_service_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wildcard</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">_list</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return a service url.</span>

<span class="sd">        Args:</span>
<span class="sd">            wildcard: Wildcard used to grab service name (ex &quot;moun*featureserver&quot;).</span>
<span class="sd">            _list: Default is false.  If true, will return a list of all services</span>
<span class="sd">                matching the wildcard.  If false, first match is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_services</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">wildcard</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wildcard</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_list</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">wildcard</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">wildcard</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_list</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="k">if</span> <span class="n">wildcard</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wildcard</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">s</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; not found in services&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wildcard</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="ArcServer.get_folders"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.get_folders">[docs]</a>    <span class="k">def</span> <span class="nf">get_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get and return folder objects.&quot;&quot;&quot;</span>
        <span class="n">folder_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span>
            <span class="n">folder_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">folder</span><span class="p">])</span>
            <span class="n">folder_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Folder</span><span class="p">(</span><span class="n">folder_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">folder_objects</span></div>

<div class="viewcode-block" id="ArcServer.walk"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ArcServer.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to walk through ArcGIS REST Services. ArcGIS Server only </span>
<span class="sd">            supports single folder heiarchy, meaning that there cannot be </span>
<span class="sd">            subdirectories within folders.</span>

<span class="sd">        Will return tuple of the root folder and services from the topdown.</span>
<span class="sd">        (root, services) example:</span>

<span class="sd">        ags = restapi.ArcServer(url, username, password)</span>
<span class="sd">        for root, folders, services in ags.walk():</span>
<span class="sd">            print(root)</span>
<span class="sd">            print(services)</span>
<span class="sd">            print(&#39;\n\n&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
            <span class="n">qualified_service</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="n">NAME</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">TYPE</span><span class="p">]])</span>
            <span class="n">full_service_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">qualified_service</span><span class="p">])</span>
            <span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qualified_service</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_service_url</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folders</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
            <span class="n">endpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">serv</span> <span class="ow">in</span> <span class="n">endpt</span><span class="p">[</span><span class="n">SERVICES</span><span class="p">]:</span>
                <span class="n">qualified_service</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">serv</span><span class="p">[</span><span class="n">NAME</span><span class="p">],</span> <span class="n">serv</span><span class="p">[</span><span class="n">TYPE</span><span class="p">]])</span>
                <span class="n">full_service_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">qualified_service</span><span class="p">])</span>
                <span class="n">services</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qualified_service</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_service_url</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an generator for services.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_services</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns number of services.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;ArcServer: &quot;</span><span class="si">{}</span><span class="s1">&quot; (&quot;</span><span class="si">{}</span><span class="s1">&quot;)&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span></div>

<div class="viewcode-block" id="Portal"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Portal">[docs]</a><span class="k">class</span> <span class="nc">Portal</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles the Portal</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        self.url: URL for site.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_elevated_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets login credentials for portal.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            url: The URL.</span>
<span class="sd">            usr: Username to login with. Defaults to &#39;&#39;.</span>
<span class="sd">            pw: Password to login with. Defaults to &#39;&#39;.</span>
<span class="sd">            token: Token for the URL. Defaults to &#39;&#39;.</span>
<span class="sd">            proxy: Optional arg for proxy. Defaults to None.</span>
<span class="sd">            referer: Optional, defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">get_portal_base</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/rest/portals/self&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;URL FOR INIT: &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Portal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">referer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">portalUrl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_portal_base</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def services_url(self):</span>
    <span class="c1">#     return self.portalUrl + &#39;/servers&#39;</span>

<div class="viewcode-block" id="Portal.getItem"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Portal.getItem">[docs]</a>    <span class="k">def</span> <span class="nf">getItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemId</span><span class="p">):</span>
        <span class="n">item_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">portalUrl</span> <span class="o">+</span> <span class="s1">&#39;/rest/content/items/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itemId</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">item_url</span><span class="p">,</span> <span class="p">{</span><span class="n">TOKEN</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)})</span>

        <span class="k">return</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Portal.fromItem"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.Portal.fromItem">[docs]</a>    <span class="k">def</span> <span class="nf">fromItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">type</span>  <span class="o">==</span> <span class="s1">&#39;Feature Service&#39;</span><span class="p">:</span>
            <span class="n">services_base</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/rest/services/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/rest/services&#39;</span>
            <span class="n">elevated_token</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">services_base</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elevated_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elevated_token</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">generate_elevated_portal_token</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_elevated_token</span> <span class="o">=</span> <span class="n">token</span>

            <span class="k">return</span> <span class="n">FeatureService</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">url</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MapServiceLayer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer">[docs]</a><span class="k">class</span> <span class="nc">MapServiceLayer</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">,</span> <span class="n">SpatialReferenceMixin</span><span class="p">,</span> <span class="n">FieldsMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle advanced layer properties.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_fix_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fixes input fields, accepts esri field tokens too (&quot;SHAPE@&quot;, &quot;OID@&quot;), internal</span>
<span class="sd">                method used for cursors.</span>

<span class="sd">        Arg:</span>
<span class="sd">            fields: List or comma delimited field list.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Concatenated string of the elements in the list of fields, </span>
<span class="sd">                unless fields == &#39;*&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fields</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">all_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_fields</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">SHAPE_TOKEN</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ShapeFieldName</span><span class="p">:</span>
                            <span class="n">field_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ShapeFieldName</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">OID_TOKEN</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">:</span>
                            <span class="n">field_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_fields</span><span class="p">:</span>
                        <span class="n">field_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_server_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_response</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a reformatted server response.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            server_response: Server response to a request.</span>
<span class="sd">            records: Optional arg for records. Defaults to None.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Either a GeoJSONFeatureSet or FeatureSet of the server response. </span>
<span class="sd">                Can also return JSON of server response.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set fields to full field definition of the layer</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server_response</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
            <span class="n">server_response</span> <span class="o">=</span> <span class="n">munchify</span><span class="p">(</span><span class="n">server_response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
        <span class="n">flds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldLookup</span>
        <span class="k">if</span> <span class="n">FIELDS</span> <span class="ow">in</span> <span class="n">server_response</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">fld</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">server_response</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
                <span class="n">server_response</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FEATURE_LAYER</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FIELDS</span><span class="p">,</span> <span class="n">GEOMETRY_TYPE</span><span class="p">,</span> <span class="n">SPATIAL_REFERENCE</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server_response</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">SPATIAL_REFERENCE</span><span class="p">:</span>
                        <span class="n">server_response</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">SPATIAL_REFERENCE</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">server_response</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TABLE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">FIELDS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server_response</span><span class="p">:</span>
                <span class="n">server_response</span><span class="p">[</span><span class="n">FIELDS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FIELDS</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">server_response</span><span class="p">,</span> <span class="p">[</span><span class="n">FIELDS</span><span class="p">,</span> <span class="n">FEATURES</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">records</span><span class="p">:</span>
                <span class="n">server_response</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_response</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">][:</span><span class="n">records</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">GeoJSONFeatureSet</span><span class="p">(</span><span class="n">server_response</span><span class="p">)</span> <span class="k">if</span> <span class="n">server_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">FEATURE_COLLECTION</span> <span class="k">else</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">server_response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">server_response</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">server_response</span><span class="p">[:</span><span class="n">records</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">server_response</span>

    <span class="k">def</span> <span class="nf">_validate_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">f</span><span class="o">=</span><span class="n">JSON</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries layer and gets response as JSON.</span>

<span class="sd">        Args:</span>
<span class="sd">            fields: Optional arg for fields to return. Default is &quot;*&quot; to </span>
<span class="sd">                return all fields.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            add_params: Optional extra parameters to add to query string passed </span>
<span class="sd">                as dict. Defaults to {}.</span>
<span class="sd">            f: Optional return format, default is JSON.  (html|json|kmz)</span>
<span class="sd">            kwargs: Optional extra parameters to add to query string passed as </span>
<span class="sd">                key word arguments, will override add_params***.</span>

<span class="sd">        # default params for all queries</span>
<span class="sd">        params = {&#39;returnGeometry&#39; : &#39;true&#39;, &#39;outFields&#39; : fields,</span>
<span class="sd">                  &#39;where&#39;: where, &#39;f&#39; : &#39;json&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># default params</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">RETURN_GEOMETRY</span> <span class="p">:</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">WHERE</span><span class="p">:</span> <span class="n">where</span><span class="p">,</span> <span class="n">F</span> <span class="p">:</span> <span class="n">f</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">add_params</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">RESULT_RECORD_COUNT</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compatible_with_version</span><span class="p">(</span><span class="s1">&#39;10.3&#39;</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">RESULT_RECORD_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">RESULT_RECORD_COUNT</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MAX_RECORD_COUNT</span><span class="p">)])</span>

        <span class="c1"># check for tokens (only shape and oid)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FIX FIELDS OUTPUT: &#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="n">OUT_FIELDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span>

        <span class="c1"># geometry validation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FEATURE_LAYER</span> <span class="ow">and</span> <span class="n">GEOMETRY</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRY</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">SPATIAL_REL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">SPATIAL_REL</span><span class="p">]</span> <span class="o">=</span> <span class="n">ESRI_INTERSECT</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">IN_SR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">geom</span><span class="o">.</span><span class="n">getSR</span><span class="p">():</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">IN_SR</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">GEOMETRY_TYPE</span><span class="p">)</span> <span class="ow">and</span> <span class="n">GEOMETRY_TYPE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">GEOMETRY_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">GEOMETRY_TYPE</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TABLE</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="n">RETURN_GEOMETRY</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">params</span>

<div class="viewcode-block" id="MapServiceLayer.iter_queries"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.iter_queries">[docs]</a>    <span class="k">def</span> <span class="nf">iter_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">max_recs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator to form where clauses to query all records.  Will iterate </span>
<span class="sd">                through &quot;chunks&quot; of OID&#39;s until all records have been returned </span>
<span class="sd">                (grouped by maxRecordCount).</span>

<span class="sd">        *Thanks to Wayne Whitley for the brilliant idea to use izip_longest()</span>



<span class="sd">        Args:</span>
<span class="sd">            where: Optional where clause for OID selection.</span>
<span class="sd">            max_recs: Optional maximum amount of records returned for all </span>
<span class="sd">                queries for OID fetch. Defaults to None.</span>
<span class="sd">            chunk_size: Optional size of chunks for each iteration of query </span>
<span class="sd">                iterator. Defaults to None.</span>
<span class="sd">            add_params: Optional dictionary with any additional params you want </span>
<span class="sd">                to add (can also use **kwargs). Defaults to {}.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">add_params</span><span class="p">[</span><span class="n">RETURN_IDS_ONLY</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span>

        <span class="c1"># get oids</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="n">add_params</span><span class="p">)</span>
        <span class="n">oids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OBJECT_IDS</span><span class="p">,</span> <span class="p">[]))[:</span><span class="n">max_recs</span><span class="p">]</span>
        <span class="n">oid_name</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OID_FIELD_NAME</span><span class="p">,</span> <span class="n">OBJECTID</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;total records: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oids</span><span class="p">)))</span>

        <span class="c1"># set returnIdsOnly to False</span>
        <span class="n">add_params</span><span class="p">[</span><span class="n">RETURN_IDS_ONLY</span><span class="p">]</span> <span class="o">=</span> <span class="n">FALSE</span>

        <span class="c1"># iterate through groups to form queries</span>
        <span class="c1"># overwrite max_recs here with transfer limit from service</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">and</span> <span class="n">chunk_size</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MAX_RECORD_COUNT</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
            <span class="n">max_recs</span> <span class="o">=</span> <span class="n">chunk_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MAX_RECORD_COUNT</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">oids</span><span class="p">),)</span> <span class="o">*</span> <span class="n">max_recs</span><span class="p">):</span>
            <span class="n">theRange</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">each</span><span class="p">))</span> <span class="c1"># do not want to remove OID &quot;0&quot;</span>
            <span class="k">if</span> <span class="n">theRange</span><span class="p">:</span>
                <span class="n">_min</span><span class="p">,</span> <span class="n">_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">theRange</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">theRange</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">each</span>
                <span class="k">yield</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> &gt;= </span><span class="si">{1}</span><span class="s1"> and </span><span class="si">{0}</span><span class="s1"> &lt;= </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oid_name</span><span class="p">,</span> <span class="n">_min</span><span class="p">,</span> <span class="n">_max</span><span class="p">)</span></div>


<div class="viewcode-block" id="MapServiceLayer.query"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fetch_in_chunks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">JSON</span><span class="p">,</span> <span class="n">kmz</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries layer and gets response as JSON.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fields: Optional fields to return. Default is &quot;*&quot; to return all fields.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1:1&#39;.</span>
<span class="sd">            add_params: Extra parameters to add to query string passed as dict.</span>
<span class="sd">            records: Number of records to return.  Default is None to return all</span>
<span class="sd">                records within bounds of max record count unless exceed_limit is True.</span>
<span class="sd">            exceed_limit: Option to get all records in layer.  This option may be time consuming</span>
<span class="sd">                because the ArcGIS REST API uses default maxRecordCount of 1000, so queries</span>
<span class="sd">                must be performed in chunks to get all records.  This is only </span>
<span class="sd">                supported with JSON output. Default is False</span>
<span class="sd">            fetch_in_chunks: Option to return a generator with a FeatureSet in </span>
<span class="sd">                chunks of each query group.  Use this to avoid memory errors when </span>
<span class="sd">                fetching many features. Defaults to False</span>
<span class="sd">            f: Return format, default is JSON.  (html|json|kmz)</span>
<span class="sd">            kmz: Optional full path to output kmz file.  Only used if output </span>
<span class="sd">                format is &quot;kmz&quot;. Defaults to &#39;&#39;.</span>
<span class="sd">            kwargs: Optional extra parameters to add to query string passed as key word arguments,</span>
<span class="sd">                will override add_params***.</span>

<span class="sd">        # default params for all queries</span>
<span class="sd">        params: {&#39;returnGeometry&#39; : &#39;true&#39;, &#39;outFields&#39; : fields,</span>
<span class="sd">        &#39;where&#39;: where, &#39;f&#39; : &#39;json&#39;}</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Response as JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">add_params</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># create kmz file if requested (does not support exceed_limit parameter)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;kmz&#39;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">r</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;zlib_codec&#39;</span>

            <span class="c1"># write kmz using codecs</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kmz</span><span class="p">:</span>
                <span class="n">kmz</span> <span class="o">=</span> <span class="n">validate_name</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.kmz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
            <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">kmz</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;creating kmz&#39;</span><span class="p">)</span>
<span class="c1">##            with open(kmz, &#39;wb&#39;) as f:</span>
<span class="c1">##                shutil.copyfileobj(r.raw, f)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kmz</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">kmz</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">server_response</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">exceed_limit</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">where2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_queries</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">max_recs</span><span class="o">=</span><span class="n">records</span><span class="p">)):</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">where</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">where2</span><span class="p">]))</span> <span class="c1">#remove default</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">WHERE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">server_response</span> <span class="o">=</span> <span class="n">resp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">server_response</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span> <span class="o">+=</span> <span class="n">resp</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">server_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_server_response</span><span class="p">(</span><span class="n">server_response</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceLayer.query_in_chunks"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.query_in_chunks">[docs]</a>    <span class="k">def</span> <span class="nf">query_in_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries a layer in chunks and returns a generator.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fields: Optional fields to return. Default is &quot;*&quot; to return all fields.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            add_params: Optional extra parameters to add to query string passed as dict.</span>
<span class="sd">            records: Optional number of records to return.  Default is None to </span>
<span class="sd">                return all. Records within bounds of max record count unless </span>
<span class="sd">                exceed_limit is True.</span>
<span class="sd">            kwargs: Optional extra parameters to add to query string passed as key word arguments,</span>
<span class="sd">                will override add_params***.</span>

<span class="sd">        # default params for all queries</span>
<span class="sd">        params : {&#39;returnGeometry&#39; : &#39;true&#39;, &#39;outFields&#39; : fields,</span>
<span class="sd">        &#39;where&#39;: where, &#39;f&#39; : &#39;json&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">add_params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">where2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_queries</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">max_recs</span><span class="o">=</span><span class="n">records</span><span class="p">):</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">where</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">where2</span><span class="p">]))</span> <span class="c1">#remove default</span>
            <span class="n">params</span><span class="p">[</span><span class="n">WHERE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FIELDS: &#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">))</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_server_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span></div>


<div class="viewcode-block" id="MapServiceLayer.query_related_records"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.query_related_records">[docs]</a>    <span class="k">def</span> <span class="nf">query_related_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectIds</span><span class="p">,</span> <span class="n">relationshipId</span><span class="p">,</span> <span class="n">outFields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">definitionExpression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returnGeometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries related records.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            objectIds: List of object ids for related records.</span>
<span class="sd">            relationshipId: ID of relationship.</span>
<span class="sd">            outFields: Optional output fields for related features. Defaults to &#39;*&#39;.</span>
<span class="sd">            definitionExpression: Optional def query for output related records. </span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            returnGeometry: Option to return Geometry. Defaults to None.</span>
<span class="sd">            outSR: Optional output spatial reference, defaults to None.</span>
<span class="sd">            kwargs: Optional key word args for REST API.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: &#39;This Resource does not have any relationships!&#39;</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The related records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RELATIONSHIPS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This Resource does not have any relationships!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objectIds</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">objectIds</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">objectIds</span><span class="p">))</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/queryRelatedRecords&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">OBJECT_IDS</span><span class="p">:</span> <span class="n">objectIds</span><span class="p">,</span>
            <span class="n">RELATIONSHIP_ID</span><span class="p">:</span> <span class="n">relationshipId</span><span class="p">,</span>
            <span class="n">OUT_FIELDS</span><span class="p">:</span> <span class="n">outFields</span><span class="p">,</span>
            <span class="n">DEFINITION_EXPRESSION</span><span class="p">:</span> <span class="n">definitionExpression</span><span class="p">,</span>
            <span class="n">RETURN_GEOMETRY</span><span class="p">:</span> <span class="n">returnGeometry</span><span class="p">,</span>
            <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">RelatedRecords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="MapServiceLayer.select_by_location"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.select_by_location">[docs]</a>    <span class="k">def</span> <span class="nf">select_by_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">geometryType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spatialRel</span><span class="o">=</span><span class="n">ESRI_INTERSECT</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">ESRI_METER</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects features by location of a geometry, returns a feature set.</span>
<span class="sd">    </span>
<span class="sd">        Args:</span>
<span class="sd">            geometry: Geometry as JSON.</span>
<span class="sd">            geometryType: Optional type of geometry object, this can be gleaned</span>
<span class="sd">                 automatically from the geometry input. Defaults to &#39;&#39;.</span>
<span class="sd">            inSR: Optional input spatial reference. Defaults to &#39;&#39;.</span>
<span class="sd">            spatialRel: Optional spatial relationship applied on the input geometry </span>
<span class="sd">                when performing the query operation. Defaults to ESRI_INTERSECT.</span>
<span class="sd">            distance: Optional distance for search. Defaults to 0.</span>
<span class="sd">            units: Optional units for distance, only used if distance &gt; 0.</span>
<span class="sd">            add_params: Optional dict containing any other options that will be </span>
<span class="sd">                added to the query. Defaults to {}.</span>
<span class="sd">            kwargs: Optional keyword args to add to the query.</span>
<span class="sd">        </span>
<span class="sd">        Spatial Relationships:</span>
<span class="sd">            esriSpatialRelIntersects | esriSpatialRelContains | esriSpatialRelCrosses | esriSpatialRelEnvelopeIntersects | esriSpatialRelIndexIntersects</span>
<span class="sd">            | esriSpatialRelOverlaps | esriSpatialRelTouches | esriSpatialRelWithin | esriSpatialRelRelation</span>
<span class="sd">        </span>
<span class="sd">        Unit Options:</span>
<span class="sd">            esriSRUnit_Meter | esriSRUnit_StatuteMile | esriSRUnit_Foot | esriSRUnit_Kilometer | esriSRUnit_NauticalMile | esriSRUnit_USNauticalMile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">geometryType</span><span class="p">:</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geometryType</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inSR</span><span class="p">:</span>
            <span class="n">inSR</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                  <span class="n">GEOMETRY_TYPE</span><span class="p">:</span> <span class="n">geometryType</span><span class="p">,</span>
                  <span class="n">SPATIAL_REL</span><span class="p">:</span> <span class="n">spatialRel</span><span class="p">,</span>
                  <span class="n">IN_SR</span><span class="p">:</span> <span class="n">inSR</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">distance</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">DISTANCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span>
            <span class="n">params</span><span class="p">[</span><span class="n">UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span>

        <span class="c1"># add additional params</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">add_params</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># add kwargs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">add_params</span><span class="o">=</span><span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="MapServiceLayer.layer_to_kmz"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.layer_to_kmz">[docs]</a>    <span class="k">def</span> <span class="nf">layer_to_kmz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_kmz</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flds</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Method to create kmz from query.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            out_kmz: Optional output kmz file path, if none specified will be saved on Desktop. Defaults to &#39;&#39;.</span>
<span class="sd">            flds: Optional list of fields for fc. If none specified, all fields </span>
<span class="sd">                are returned. Defaults to &#39;*&#39;. Supports fields in list [] or comma </span>
<span class="sd">                separated string &quot;field1,field2,..&quot;</span>
<span class="sd">            where: Optional where clause, defaults to &#39;1=1&#39;.</span>
<span class="sd">            params: Optional dictionary of parameters for query, Defaults to {}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">flds</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">ret_form</span><span class="o">=</span><span class="s1">&#39;kmz&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">kmz</span><span class="o">=</span><span class="n">out_kmz</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceLayer.getOIDs"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.getOIDs">[docs]</a>    <span class="k">def</span> <span class="nf">getOIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">max_recs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of OIDs from feature layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            where: Optional where clause for OID selection. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            max_recs: Optional maximimum number of records to return </span>
<span class="sd">                (maxRecordCount does not apply). Defaults to None.</span>
<span class="sd">            **kwargs: Optional key word arguments to further limit query (i.e. add geometry interesect).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">RETURN_IDS_ONLY</span><span class="p">:</span><span class="n">TRUE</span><span class="p">,</span>
             <span class="n">RETURN_GEOMETRY</span><span class="p">:</span> <span class="n">FALSE</span><span class="p">,</span>
             <span class="n">OUT_FIELDS</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>

        <span class="c1"># add kwargs if specified</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="n">p</span><span class="p">)[</span><span class="n">OBJECT_IDS</span><span class="p">])[:</span><span class="n">max_recs</span><span class="p">]</span></div>

<div class="viewcode-block" id="MapServiceLayer.getCount"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.getCount">[docs]</a>    <span class="k">def</span> <span class="nf">getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns count of features, can use optional query and **kwargs to filter.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            where: Optional where clause, defaults to &#39;*&#39;.</span>
<span class="sd">            kwargs: Optional keyword arguments for query operation. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOIDs</span><span class="p">(</span><span class="n">where</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="MapServiceLayer.attachments"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.attachments">[docs]</a>    <span class="k">def</span> <span class="nf">attachments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries attachments for an OBJECTDID.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            oid: Object ID.</span>
<span class="sd">            gdbVersion: Optional Geodatabase version to query, defaults to &#39;&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: &#39;Layer &quot;{}&quot; does not support attachments!&#39;</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Attachments for OID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttachments</span><span class="p">:</span>
            <span class="n">query_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">/attachments&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">oid</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">)</span>

            <span class="n">add_tok</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
                <span class="n">add_tok</span> <span class="o">=</span> <span class="s1">&#39;?token=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">token</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ATTACHMENT_INFOS</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attInfo</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="n">ATTACHMENT_INFOS</span><span class="p">]:</span>
                    <span class="n">att_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">attInfo</span><span class="p">[</span><span class="n">ID</span><span class="p">])</span>
                    <span class="n">attInfo</span><span class="p">[</span><span class="n">URL</span><span class="p">]</span> <span class="o">=</span> <span class="n">att_url</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span><span class="p">:</span>
                        <span class="n">attInfo</span><span class="p">[</span><span class="n">URL_WITH_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span><span class="p">,</span> <span class="n">att_url</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attInfo</span><span class="p">[</span><span class="n">URL_WITH_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">att_url</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;?token=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">ATTACHMENT_INFOS</span><span class="p">]:</span>
                    <span class="n">keys</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">ATTACHMENT_INFOS</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

                <span class="n">props</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;contentType&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;urlWithToken&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>

                <span class="k">class</span> <span class="nc">Attachment</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Attachment&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">props</span><span class="p">))):</span>
                    <span class="sd">&quot;&quot;&quot;Class to handle Attachment object.&quot;&quot;&quot;</span>
                    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
                    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Attachment</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NAME</span><span class="p">):</span>
                            <span class="k">return</span> <span class="s1">&#39;&lt;Attachment ID: </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="s1">&#39;&lt;Attachment&gt; ?&#39;</span>

                    <span class="k">def</span> <span class="nf">blob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Returns a string of the chunks in the response.&quot;&quot;&quot;</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">URL_WITH_TOKEN</span><span class="p">),</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">):</span>
                            <span class="n">b</span> <span class="o">+=</span> <span class="n">chunk</span>
                        <span class="k">return</span> <span class="n">b</span>

                    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_path</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="sd">&quot;&quot;&quot;Downloads the attachment to specified path.</span>
<span class="sd">                        </span>
<span class="sd">                        Args:</span>
<span class="sd">                            out_path: Output path for attachment.</span>
<span class="sd">                            name: Optional name for output file.  If left blank, </span>
<span class="sd">                                will be same as attachment.</span>
<span class="sd">                            verbose: Optional boolean, if true will print sucessful </span>
<span class="sd">                                download message. Defaults to True.</span>
<span class="sd">                        </span>
<span class="sd">                        Returns:</span>
<span class="sd">                            The path to the downloaded attachment.</span>
<span class="sd">                        &quot;&quot;&quot;</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                            <span class="n">out_file</span> <span class="o">=</span> <span class="n">assign_unique_name</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

                        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">URL_WITH_TOKEN</span><span class="p">),</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">):</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;downloaded attachment &quot;</span><span class="si">{}</span><span class="s1">&quot; to &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">out_path</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">out_file</span>

                <span class="k">return</span> <span class="p">[</span><span class="n">Attachment</span><span class="p">(</span><span class="o">**</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="n">ATTACHMENT_INFOS</span><span class="p">]]</span>

            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Layer &quot;</span><span class="si">{}</span><span class="s1">&quot; does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="MapServiceLayer.cursor"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.cursor">[docs]</a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs Cursor on layer, helper method that calls Cursor Object.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fields: Optional fields to return. Default is &quot;*&quot; to return all fields.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            add_params: Optional extra parameters to add to query string passed</span>
<span class="sd">                as dict. Defaults to {}.</span>
<span class="sd">            records: Optional number of records to return.  Default is None to </span>
<span class="sd">                return all. records within bounds of max record count unless </span>
<span class="sd">                exceed_limit is True.</span>
<span class="sd">            exceed_limit: Optional boolean to get all records in layer.  This </span>
<span class="sd">                option may be time consuming because the ArcGIS REST API uses </span>
<span class="sd">                default maxRecordCount of 1000, so queries must be performed in </span>
<span class="sd">                chunks to get all records.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cur_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">cur_fields</span><span class="p">,</span> <span class="n">add_params</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Cursor</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceLayer.export_layer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.export_layer">[docs]</a>    <span class="k">def</span> <span class="nf">export_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">include_domains</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_attachments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qualified_fieldnames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to export a feature class or shapefile from a service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            out_fc: Full path to output feature class.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            params: Optional dictionary of parameters for query. Defaults to {}.</span>
<span class="sd">            fields: Optional list of fields for fc. If none specified, all fields </span>
<span class="sd">                are returned. Defaults to &#39;*&#39;. Supports fields in list [] or comma </span>
<span class="sd">                separated string &quot;field1,field2,..&quot;.</span>
<span class="sd">            records: Optional number of records to return. Default is None, will </span>
<span class="sd">                return maxRecordCount.</span>
<span class="sd">            exceed_limit: Optional boolean to get all records.  If True, will </span>
<span class="sd">                recursively query REST endpoint until all records have been </span>
<span class="sd">                gathered. Default is False.</span>
<span class="sd">            sr: Optional output spatial refrence (WKID). Defaults to None.</span>
<span class="sd">            include_domains: Optional boolean, if True, will manually create </span>
<span class="sd">                the feature class and add domains to GDB if output is in a </span>
<span class="sd">                geodatabase. Default is False.</span>
<span class="sd">            include_attachments: Optional boolean, if True, will export features </span>
<span class="sd">                with attachments.  This argument is ignored when the &quot;out_fc&quot; param </span>
<span class="sd">                is not a feature class, or the ObjectID field is not included in </span>
<span class="sd">                &quot;fields&quot; param or if there is no access to arcpy. Defaults to False.</span>
<span class="sd">            qualified_fieldnames: Optional boolean to keep qualified field names, </span>
<span class="sd">                default is False.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A feature class or shapefile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FEATURE_LAYER</span><span class="p">,</span> <span class="n">TABLE</span><span class="p">):</span>

            <span class="c1"># make new feature class</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sr</span><span class="p">:</span>
                <span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">OUT_SR</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr</span>

            <span class="k">if</span> <span class="n">exceed_limit</span><span class="p">:</span>

                <span class="c1"># download in chunks</span>
                <span class="n">isShp</span> <span class="o">=</span> <span class="n">out_fc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.shp&#39;</span><span class="p">)</span>
                <span class="n">orig</span> <span class="o">=</span> <span class="n">out_fc</span>
                <span class="n">doesExceed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">isShp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">returnCountOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxRecordCount</span><span class="p">:</span>
                        <span class="n">doesExceed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">out_fc</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;in_memory\restapi_chunk_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">orig</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_in_chunks</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="n">exportFeatureSet</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="n">include_domains</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">isShp</span> <span class="ow">and</span> <span class="n">include_domains</span><span class="p">:</span>
                    <span class="n">add_domains_from_feature_set</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">has_arcpy</span> <span class="ow">and</span> <span class="n">isShp</span> <span class="ow">and</span> <span class="n">doesExceed</span><span class="p">:</span>
                    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">CopyFeatures</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>
                    <span class="n">arcpy</span><span class="o">.</span><span class="n">management</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">out_fc</span><span class="p">)</span>
                    <span class="n">out_fc</span> <span class="o">=</span> <span class="n">orig</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fetched all records&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">out_fc</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># do query to get feature set</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c1"># get any domain info</span>
                <span class="n">f_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fs</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">f_dict</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DOMAIN</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">exportFeatureSet</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">out_fc</span><span class="p">,</span> <span class="n">include_domains</span><span class="p">)</span>

<span class="c1">##            if has_arcpy and all([include_attachments, self.hasAttachments, fs.OIDFieldName])::</span>
<span class="c1">##                export_attachments()</span>
<span class="c1">##</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Layer: &quot;</span><span class="si">{}</span><span class="s1">&quot; is not a Feature Layer!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>


<div class="viewcode-block" id="MapServiceLayer.clip"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceLayer.clip">[docs]</a>    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">out_sr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">envelope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method for spatial Query, exports geometry that intersect polygon or</span>
<span class="sd">                envelope features.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            poly: Polygon (or other) features used for spatial query.</span>
<span class="sd">            output: Full path to output feature class.</span>
<span class="sd">            fields: Optional list of fields for fc. If none specified, all fields are returned.</span>
<span class="sd">                Supports fields in list [] or comma separated string </span>
<span class="sd">                &quot;field1,field2,..&quot;. Defaults to &#39;*&#39;.</span>
<span class="sd">            out_sr: Optional output spatial refrence (WKID). Defaults to &#39;&#39;.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;&#39;.</span>
<span class="sd">            envelope: Optional boolean, if True, the polygon features bounding </span>
<span class="sd">                box will be used. This option can be used if the feature has </span>
<span class="sd">                many vertices or to check against the full extent of the feature </span>
<span class="sd">                class. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">in_geom</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">envelope</span><span class="p">:</span>
            <span class="n">geojson</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">envelopeAsJSON</span><span class="p">()</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">ESRI_ENVELOPE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geojson</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">geometryType</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_sr</span><span class="p">:</span>
            <span class="n">out_sr</span> <span class="o">=</span> <span class="n">sr</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">GEOMETRY_TYPE</span><span class="p">:</span> <span class="n">geometryType</span><span class="p">,</span>
             <span class="n">RETURN_GEOMETRY</span><span class="p">:</span> <span class="n">TRUE</span><span class="p">,</span>
             <span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geojson</span><span class="p">,</span>
             <span class="n">IN_SR</span> <span class="p">:</span> <span class="n">sr</span><span class="p">,</span>
             <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">out_sr</span><span class="p">,</span>
             <span class="n">SPATIAL_REL</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SPATIAL_REL</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ESRI_INTERSECT</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_layer</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="n">out_sr</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with service name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1">: &quot;</span><span class="si">{}</span><span class="s1">&quot; (id: </span><span class="si">{}</span><span class="s1">)&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceTable"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceTable">[docs]</a><span class="k">class</span> <span class="nc">MapServiceTable</span><span class="p">(</span><span class="n">MapServiceLayer</span><span class="p">):</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="MapServiceTable.export_table"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceTable.export_table">[docs]</a>    <span class="k">def</span> <span class="nf">export_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to export a feature class or shapefile from a service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            out_fc: Full path to output feature class.</span>
<span class="sd">            where: Optional where clause.</span>
<span class="sd">            params: Optional dictionary of parameters for query.</span>
<span class="sd">            fields: List of fields for fc. If none specified, all fields are </span>
<span class="sd">                returned. Supports fields in list [] or comma separated string </span>
<span class="sd">                &quot;field1,field2,..&quot;.</span>
<span class="sd">            records: Optional number of records to return. Default is none, will </span>
<span class="sd">                return maxRecordCount</span>
<span class="sd">            exceed_limit: Optional boolean to get all records.  If true, will </span>
<span class="sd">                recursively query REST endpoint until all records have been </span>
<span class="sd">                gathered. Default is False.</span>
<span class="sd">            sr: Optional output spatial refrence (WKID)</span>
<span class="sd">            include_domains: Optional boolean, if True, will manually create the </span>
<span class="sd">                feature class and add domains to GDB if output is in a geodatabase.</span>
<span class="sd">            include_attachments: Optional boolean, if True, will export features </span>
<span class="sd">                with attachments.  This argument is ignored when the &quot;out_fc&quot; param </span>
<span class="sd">                is not a feature class, or the ObjectID field is not included in </span>
<span class="sd">                &quot;fields&quot; param or if there is no access to arcpy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_layer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceTable.clip"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceTable.clip">[docs]</a>    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;Tabular Data cannot be clipped!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceTable.select_by_location"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceTable.select_by_location">[docs]</a>    <span class="k">def</span> <span class="nf">select_by_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;Select By Location not supported for tabular data!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapServiceTable.layer_to_kmz"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapServiceTable.layer_to_kmz">[docs]</a>    <span class="k">def</span> <span class="nf">layer_to_kmz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;Tabular Data cannot be converted to KMZ!&#39;</span><span class="p">)</span></div></div>

<span class="c1"># LEGACY SUPPORT</span>
<span class="n">MapServiceLayer</span><span class="o">.</span><span class="n">layer_to_fc</span> <span class="o">=</span> <span class="n">MapServiceLayer</span><span class="o">.</span><span class="n">export_layer</span>

<div class="viewcode-block" id="MapService"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService">[docs]</a><span class="k">class</span> <span class="nc">MapService</span><span class="p">(</span><span class="n">BaseService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles map services.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="MapService.getLayerIdByName"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.getLayerIdByName">[docs]</a>    <span class="k">def</span> <span class="nf">getLayerIdByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp_lyr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a mapservice layer ID by layer name from a service (returns an integer).</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name of layer from which to grab ID.</span>
<span class="sd">            grp_lyr: Optional boolean, default is False, does not return layer ID </span>
<span class="sd">                for group layers. Set to true to search for group layers too.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">all_layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">fix_encoding</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NAME</span><span class="p">)),</span> <span class="n">fix_encoding</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">SUB_LAYER_IDS</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">grp_lyr</span> <span class="ow">and</span> <span class="n">layer</span><span class="p">[</span><span class="n">SUB_LAYER_IDS</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">layer</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">grp_lyr</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">layer</span><span class="p">[</span><span class="n">SUB_LAYER_IDS</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">layer</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">layer</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tab</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">fix_encoding</span><span class="p">(</span><span class="n">tab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NAME</span><span class="p">)),</span> <span class="n">fix_encoding</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">tab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Layer found matching &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MapService.get_layer_url"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.get_layer_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_layer_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">grp_lyr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the fully qualified path to a layer url by pattern match on name,</span>
<span class="sd">                will return the first match.</span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name of layer from which to grab ID.</span>
<span class="sd">            grp_lyr: Optional boolean, default is false, does not return layer </span>
<span class="sd">                ID for group layers. Set to true to search for group layers too.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLayerIdByName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">grp_lyr</span><span class="p">))])</span></div>

<div class="viewcode-block" id="MapService.list_layers"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.list_layers">[docs]</a>    <span class="k">def</span> <span class="nf">list_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return a list of layer names in a MapService.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fix_encoding</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">]</span></div>

<div class="viewcode-block" id="MapService.list_tables"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.list_tables">[docs]</a>    <span class="k">def</span> <span class="nf">list_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return a list of layer names in a MapService.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">]</span></div>

<div class="viewcode-block" id="MapService.getNameFromId"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.getNameFromId">[docs]</a>    <span class="k">def</span> <span class="nf">getNameFromId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lyrID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get layer name from ID.</span>

<span class="sd">        Arg:</span>
<span class="sd">            lyrID: ID of layer for which to get name.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Layer name.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">fix_encoding</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">lyrID</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="MapService.export"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imageSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bboxSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">urlOnly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports a map image.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            out_image: Full path to output image.</span>
<span class="sd">            imageSR: Optional spatial reference for exported image. Defaults to None.</span>
<span class="sd">            bbox: Optional bounding box as comma separated string. Defaults to None.</span>
<span class="sd">            bboxSR: Optional spatial reference for bounding box. Defaults to None.</span>
<span class="sd">            size: Optional comma separated string for the size of image in pixels. </span>
<span class="sd">                It is advised not to use this arg and let this method generate </span>
<span class="sd">                it automatically. Defaults to None.</span>
<span class="sd">            dpi: Optional output resolution, default is 96.</span>
<span class="sd">            format: Optional image format, default is png8.</span>
<span class="sd">            transparent: Optional boolean to support transparency in exported </span>
<span class="sd">                image, default is True.</span>
<span class="sd">            kwargs: Any additional keyword arguments for export operation </span>
<span class="sd">                (must be supported by REST API).</span>
<span class="sd">            </span>
<span class="sd">        Keyword Arguments can be found here:</span>
<span class="sd">            http://resources.arcgis.com/en/help/arcgisrest:api/index.html#/Export_Map/02r3000000v7000000/</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/export&#39;</span>
        <span class="c1"># defaults if params not specified</span>
        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">]))]))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bbox</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;it is a geometry object&#39;</span><span class="p">)</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">):</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">bbox</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">envelope</span><span class="p">()</span>
            <span class="n">bboxSR</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">spatialReference</span>
            <span class="n">envJson</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">envelopeAsJSON</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">envJson</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XMAX</span><span class="p">)</span> <span class="o">-</span> <span class="n">envJson</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XMIN</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">envJson</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">YMAX</span><span class="p">)</span> <span class="o">-</span> <span class="n">envJson</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">YMIN</span><span class="p">))]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set size from geometry object: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bbox</span><span class="p">:</span>
            <span class="n">ie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialExtent</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">ie</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ie</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ie</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ie</span><span class="o">.</span><span class="n">ymax</span><span class="p">]))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">xmax</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">ymax</span><span class="p">))]))</span>

            <span class="n">bboxSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">imageSR</span><span class="p">:</span>
            <span class="n">imageSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span>

        <span class="c1"># initial params</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">FORMAT</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span>
          <span class="n">F</span><span class="p">:</span> <span class="n">IMAGE</span><span class="p">,</span>
          <span class="n">IMAGE_SR</span><span class="p">:</span> <span class="n">imageSR</span><span class="p">,</span>
          <span class="n">BBOX_SR</span><span class="p">:</span> <span class="n">bboxSR</span><span class="p">,</span>
          <span class="n">BBOX</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
          <span class="n">TRANSPARENT</span><span class="p">:</span> <span class="n">transparent</span><span class="p">,</span>
          <span class="n">DPI</span><span class="p">:</span> <span class="n">dpi</span><span class="p">,</span>
          <span class="n">SIZE</span><span class="p">:</span> <span class="n">size</span>
        <span class="p">}</span>

        <span class="c1"># add additional params from **kwargs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">urlOnly</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
            <span class="k">return</span> <span class="n">query_url</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># do post</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">ret_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># save image</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_image</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="MapService.layer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.layer">[docs]</a>    <span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return a layer object with advanced properties by name.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name_or_id: Layer name (supports wildcard syntax*) or id </span>
<span class="sd">                (must be of type &lt;int&gt;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># reference by id directly</span>
            <span class="k">return</span> <span class="n">MapServiceLayer</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">)]),</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="n">layer_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layer_url</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">layer_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MapServiceLayer</span><span class="p">(</span><span class="n">layer_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Layer &quot;</span><span class="si">{0}</span><span class="s1">&quot; not found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="MapService.table"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.table">[docs]</a>    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return a layer object with advanced properties by name.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name_or_id: Table name (supports wildcard syntax*) or id (must be of type &lt;int&gt;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># reference by id directly</span>
            <span class="k">return</span> <span class="n">MapServiceTable</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">)]),</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="n">layer_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layer_url</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">layer_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MapServiceTable</span><span class="p">(</span><span class="n">layer_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Table &quot;</span><span class="si">{0}</span><span class="s1">&quot; not found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="MapService.cursor"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.cursor">[docs]</a>    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cursor object to handle queries to rest endpoints.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layer_name: Name of layer in map service.</span>
<span class="sd">            fields: Option to limit fields returned.  All are returned by </span>
<span class="sd">                default, &#39;*&#39;.</span>
<span class="sd">            where: Optional where clause for cursor, &#39;1=1&#39;.</span>
<span class="sd">            records: Optional number of records to return </span>
<span class="sd">                (within bounds of max record count). Defaults to None.</span>
<span class="sd">            add_params: Optional boolean to add additional search parameters. </span>
<span class="sd">                Defaults to {}.</span>
<span class="sd">            exceed_limit: Optional boolean to get all records in layer. </span>
<span class="sd">                Defaults to False. This option may be time consuming because the </span>
<span class="sd">                ArcGIS REST API uses default maxRecordCount of 1000, so queries</span>
<span class="sd">                must be performed in chunks to get all records.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lyr</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">add_params</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapService.export_layer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.export_layer">[docs]</a>    <span class="k">def</span> <span class="nf">export_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span>  <span class="n">out_fc</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span>
                    <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to export a feature class from a service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layer_name: Name of map service layer to export to fc.</span>
<span class="sd">            out_fc: Full path to output feature class.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            params: Optional dictionary of parameters for query. Defaults to {}.</span>
<span class="sd">            fields: Optional list of fields for fc. If none specified, all fields </span>
<span class="sd">                are returned. Supports fields in list [] or comma separated string </span>
<span class="sd">                &quot;field1,field2,..&quot;. Defaults to &#39;*&#39;.</span>
<span class="sd">            records: Optional number of records to return. Default is none, </span>
<span class="sd">                will return maxRecordCount.</span>
<span class="sd">            exceed_limit: Optional boolean to get all records.  If true, will </span>
<span class="sd">                recursively query REST endpoint until all records have been gathered. </span>
<span class="sd">                Default is False.</span>
<span class="sd">            sr: Optional output spatial refrence (WKID). Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">lyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span>
        <span class="n">lyr</span><span class="o">.</span><span class="n">layer_to_fc</span><span class="p">(</span><span class="n">out_fc</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span><span class="n">records</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapService.layer_to_kmz"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.layer_to_kmz">[docs]</a>    <span class="k">def</span> <span class="nf">layer_to_kmz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">out_kmz</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flds</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Method to create kmz from query.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layer_name: Name of map service layer to export to fc.</span>
<span class="sd">            out_kmz: Optional output kmz file path, if none specified will be saved</span>
<span class="sd">                on Desktop. Defaults to &#39;&#39;.</span>
<span class="sd">            flds: Optional list of fields for fc. If none specified, all fields are returned.</span>
<span class="sd">                Supports fields in list [] or comma separated string </span>
<span class="sd">                &quot;field1,field2,..&quot;. Defaults to &#39;*&#39;.</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            params: Optional dictionary of parameters for query, defaults to {}.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span>
        <span class="n">lyr</span><span class="o">.</span><span class="n">layer_to_kmz</span><span class="p">(</span><span class="n">flds</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">kmz</span><span class="o">=</span><span class="n">out_kmz</span><span class="p">)</span></div>

<div class="viewcode-block" id="MapService.clip"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.MapService.clip">[docs]</a>    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">out_sr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">envelope</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method for spatial Query, exports geometry that intersect polygon or</span>
<span class="sd">                envelope features.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layer_name: Name of map service layer to export to fc.</span>
<span class="sd">            poly: Polygon (or other) features used for spatial query.</span>
<span class="sd">            output: Full path to output feature class.</span>
<span class="sd">            fields: Optional list of fields for fc. If none specified, all fields are </span>
<span class="sd">                returned. Supports fields in list [] or comma separated string </span>
<span class="sd">                &quot;field1,field2,..&quot;</span>
<span class="sd">            sr: Optional output spatial refrence (WKID)</span>
<span class="sd">            where: Optional where clause. Defaults to &#39;&#39;.</span>
<span class="sd">            envelope: Optional boolean, if true, the polygon features bounding </span>
<span class="sd">                box will be used.  This option can be used if the feature has </span>
<span class="sd">                many vertices or to check against the full extent of the feature </span>
<span class="sd">                class.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            A clip of the layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lyr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">out_sr</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">envelope</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lyr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">lyr</span></div>

<span class="c1"># Legacy support</span>
<span class="n">MapService</span><span class="o">.</span><span class="n">layer_to_fc</span> <span class="o">=</span> <span class="n">MapService</span><span class="o">.</span><span class="n">export_layer</span>

<div class="viewcode-block" id="FeatureService"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService">[docs]</a><span class="k">class</span> <span class="nc">FeatureService</span><span class="p">(</span><span class="n">MapService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle Feature Service.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: Image service url.</span>
<span class="sd">    (below args only required if security is enabled):</span>
<span class="sd">        usr: Username credentials for ArcGIS Server.</span>
<span class="sd">        pw: Password credentials for ArcGIS Server.</span>
<span class="sd">        token: Token to handle security (alternative to usr and pw).</span>
<span class="sd">        proxy: Option to use proxy page to handle security, need to provide</span>
<span class="sd">            full path to proxy url.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">replicas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of replica objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syncEnabled</span><span class="p">:</span>
            <span class="n">reps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/replicas&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">namedTuple</span><span class="p">(</span><span class="s1">&#39;Replica&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="FeatureService.query"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">LAYER_DEFS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">LAYER_DEFS</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([{</span> <span class="s1">&#39;layerId&#39;</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">])</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/query&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fs</span><span class="p">:</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">fs</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FEATURES</span><span class="p">,</span> <span class="p">[])),</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LAYERS</span><span class="p">,</span> <span class="p">{}))))</span></div>
                

<div class="viewcode-block" id="FeatureService.layer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.layer">[docs]</a>    <span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_or_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to return a layer object with advanced properties by name.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name: Layer name (supports wildcard syntax*) or layer id (int).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># reference by id directly</span>
            <span class="k">return</span> <span class="n">FeatureLayer</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">)]),</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>

        <span class="n">layer_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_layer_url</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">layer_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FeatureLayer</span><span class="p">(</span><span class="n">layer_path</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Layer &quot;</span><span class="si">{0}</span><span class="s1">&quot; not found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_or_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureService.layer_to_kmz"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.layer_to_kmz">[docs]</a>    <span class="k">def</span> <span class="nf">layer_to_kmz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">out_kmz</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flds</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Method to create kmz from query.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layer_name: Name of map service layer to export to fc.</span>
<span class="sd">            out_kmz: Optional output kmz file path, if none specified will be saved on Desktop</span>
<span class="sd">            flds: Optional list of fields for fc. If none specified, all fields </span>
<span class="sd">                are returned. Supports fields in list [] or comma separated </span>
<span class="sd">                string &quot;field1,field2,..&quot;. Default is &#39;*&#39;.</span>
<span class="sd">            where: Optional where clause.</span>
<span class="sd">            params: Optional dictionary of parameters for query.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span>
        <span class="n">lyr</span><span class="o">.</span><span class="n">layer_to_kmz</span><span class="p">(</span><span class="n">flds</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">kmz</span><span class="o">=</span><span class="n">out_kmz</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeatureService.createReplica"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.createReplica">[docs]</a>    <span class="k">def</span> <span class="nf">createReplica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">replicaName</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">geometryType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">replicaSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dataFormat</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">returnReplicaObject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Queries attachments, returns a JSON object.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            layers: List of layers to create replicas for (valid inputs below).</span>
<span class="sd">            replicaName: Name of replica.</span>
<span class="sd">            geometry: Optional geometry to query features, if none supplied, </span>
<span class="sd">                will grab all features. Defaults to &#39;&#39;.</span>
<span class="sd">            geometryType: Optional type of geometry. Defaults to &#39;&#39;.</span>
<span class="sd">            inSR: Optional innput spatial reference for geometry. Defaults to &#39;&#39;.</span>
<span class="sd">            replicaSR: Optional output spatial reference for replica data.</span>
<span class="sd">                Defaults to &#39;&#39;.</span>
<span class="sd">            dataFormat: Optional output format for replica (sqlite|json).</span>
<span class="sd">                Defaults to &#39;json&#39;.</span>
<span class="sd">            **kwargs: Optional keyword arguments for createReplica request.</span>
<span class="sd">            returnReplicaObject : Special optional arg to return replica as an </span>
<span class="sd">                object (restapi.SQLiteReplica|restapi.JsonReplica) based on the </span>
<span class="sd">                dataFormat of the replica.  If the data format is sqlite and this </span>
<span class="sd">                parameter is False, the data will need to be fetched quickly because </span>
<span class="sd">                the server will automatically clean out the directory. The default cleanup </span>
<span class="sd">                for a sqlite file is 10 minutes. This option is set to True</span>
<span class="sd">                by default.  It is recommended to set this option to True if </span>
<span class="sd">                the output dataFormat is &quot;sqlite&quot;.</span>
<span class="sd">        </span>
<span class="sd">        Documentation on Server Directory Cleaning:</span>
<span class="sd">        http://server.arcgis.com/en/server/latest/administer/linux/aboutserver:directories.htm</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SYNC_ENABLED</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">syncEnabled</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;FeatureService &quot;</span><span class="si">{}</span><span class="s1">&quot; does not support Sync!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>

        <span class="c1"># validate layers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layers</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="n">layers</span><span class="p">)):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">layers</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">),</span> <span class="n">layers</span><span class="p">)):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                                 <span class="ow">in</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">]])))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">geometry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geometryType</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialExtent</span>
            <span class="n">inSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialExtent</span><span class="o">.</span><span class="n">spatialReference</span>
            <span class="n">geometry</span><span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span><span class="n">ext</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span><span class="n">ext</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span><span class="n">ext</span><span class="o">.</span><span class="n">ymax</span><span class="p">]))</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">ESRI_ENVELOPE</span>
            <span class="n">inSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span>
            <span class="n">useGeometry</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">useGeometry</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">geometry</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
            <span class="n">inSR</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geometryType</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">replicaSR</span><span class="p">:</span>
            <span class="n">replicaSR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span>

        <span class="n">validated</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">REPLICA_NAME</span><span class="p">:</span> <span class="n">replicaName</span><span class="p">,</span>
                   <span class="n">LAYERS</span><span class="p">:</span> <span class="n">layers</span><span class="p">,</span>
                   <span class="n">LAYER_QUERIES</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                   <span class="n">GEOMETRY_TYPE</span><span class="p">:</span> <span class="n">geometryType</span><span class="p">,</span>
                   <span class="n">IN_SR</span><span class="p">:</span> <span class="n">inSR</span><span class="p">,</span>
                   <span class="n">REPLICA_SR</span><span class="p">:</span>	<span class="n">replicaSR</span><span class="p">,</span>
                   <span class="n">TRANSPORT_TYPE</span><span class="p">:</span> <span class="n">TRANSPORT_TYPE_URL</span><span class="p">,</span>
                   <span class="n">RETURN_ATTACHMENTS</span><span class="p">:</span>	<span class="n">TRUE</span><span class="p">,</span>
                   <span class="n">RETURN_ATTACHMENTS_DATA_BY_URL</span><span class="p">:</span> <span class="n">TRUE</span><span class="p">,</span>
                   <span class="n">ASYNC</span><span class="p">:</span>	<span class="n">FALSE</span><span class="p">,</span>
                   <span class="n">F</span><span class="p">:</span> <span class="n">PJSON</span><span class="p">,</span>
                   <span class="n">DATA_FORMAT</span><span class="p">:</span> <span class="n">dataFormat</span><span class="p">,</span>
                   <span class="n">REPLICA_OPTIONS</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">SYNC_MODEL</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">LAYER_QUERIES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">USE_GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="n">useGeometry</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syncCapabilities</span><span class="o">.</span><span class="n">supportsPerReplicaSync</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="n">SYNC_MODEL</span><span class="p">]</span> <span class="o">=</span> <span class="n">PER_REPLICA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="n">SYNC_MODEL</span><span class="p">]</span> <span class="o">=</span> <span class="n">PER_LAYER</span>

        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="n">ASYNC</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">syncCapabilities</span><span class="o">.</span><span class="n">supportsAsync</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/createReplica&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="p">)</span>
            <span class="k">while</span> <span class="n">STATUS_URL</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="n">ASYNC</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/createReplica&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">returnReplicaObject</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchReplica</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">st</span></div>

<div class="viewcode-block" id="FeatureService.fetchReplica"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.fetchReplica">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fetchReplica</span><span class="p">(</span><span class="n">rep_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetches and returns a replica from a server resource.  This can be a </span>
<span class="sd">                url or a dictionary/JSON object with a &quot;URL&quot; key.  Based on the </span>
<span class="sd">                file name of the replica, this will return either a </span>
<span class="sd">                restapi.SQLiteReplica() or restapi.JsonReplica() object.  The </span>
<span class="sd">                two valid file name extensions are &quot;.json&quot; (restapi.JsonReplica) </span>
<span class="sd">                or &quot;.geodatabase&quot; (restapi.SQLiteReplica).</span>
<span class="sd">        </span>
<span class="sd">        Arg:</span>
<span class="sd">            rep_url : url or JSON object that contains url to replica file on server.</span>
<span class="sd">            </span>
<span class="sd">        If the file is sqlite, it is highly recommended to use a with statement to</span>
<span class="sd">        work with the restapi.SQLiteReplica object so the connection is automatically</span>
<span class="sd">        closed and the file is cleaned from disk.  Example:</span>

<span class="sd">            &gt;&gt;&gt; url = &#39;http://someserver.com/arcgis/rest/directories/TEST/SomeService_MapServer/_ags_data{B7893BA273C164D96B7BEE588627B3EBC}.geodatabase&#39;</span>
<span class="sd">            &gt;&gt;&gt; with FeatureService.fetchReplica(url) as replica:</span>
<span class="sd">            &gt;&gt;&gt;     # this is a restapi.SQLiteReplica() object</span>
<span class="sd">            &gt;&gt;&gt;     # list tables in database</span>
<span class="sd">            &gt;&gt;&gt;     print(replica.list_tables())</span>
<span class="sd">            &gt;&gt;&gt;     # export to file geodatabase &lt; requires arcpy access</span>
<span class="sd">            &gt;&gt;&gt;     replica.exportToGDB(r&#39;C\Temp\replica.gdb&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rep_url</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">rep_url</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL_UPPER</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rep_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.geodatabase&#39;</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rep_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">rep_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMP_DIR</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SQLiteReplica</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">rep_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonReplica</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FeatureService.replicaInfo"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.replicaInfo">[docs]</a>    <span class="k">def</span> <span class="nf">replicaInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicaID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets replica information.</span>

<span class="sd">        Arg:</span>
<span class="sd">            replicaID: ID of replica.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            A named tuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/replicas/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">replicaID</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namedTuple</span><span class="p">(</span><span class="s1">&#39;ReplicaInfo&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureService.syncReplica"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.syncReplica">[docs]</a>    <span class="k">def</span> <span class="nf">syncReplica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicaID</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Synchronize a replica.  Must be called to sync edits before a fresh </span>
<span class="sd">                replica can be obtained next time createReplica is called.  </span>
<span class="sd">                Replicas are snapshots in time of the first time the user creates </span>
<span class="sd">                a replica, and will not be reloaded until synchronization has </span>
<span class="sd">                occured. A new version is created for each subsequent replica, </span>
<span class="sd">                but it is cached data.</span>

<span class="sd">        It is also recommended to unregister a replica</span>
<span class="sd">        AFTER sync has occured.  Alternatively, setting the &quot;closeReplica&quot; keyword</span>
<span class="sd">        argument to True will unregister the replica after sync.</span>

<span class="sd">        More info can be found here:</span>
<span class="sd">            http://server.arcgis.com/en/server/latest/publish-services/windows/prepare-data-for-offline-use.htm</span>

<span class="sd">        and here for key word argument parameters:</span>
<span class="sd">            http://resources.arcgis.com/en/help/arcgis-rest-api/index.html#/Synchronize_Replica/02r3000000vv000000/</span>

<span class="sd">        Arg:</span>
<span class="sd">            replicaID: ID of replica.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/synchronizeReplica&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">REPLICA_ID</span><span class="p">:</span> <span class="n">replicaID</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeatureService.unRegisterReplica"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureService.unRegisterReplica">[docs]</a>    <span class="k">def</span> <span class="nf">unRegisterReplica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicaID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unregisters a replica on the feature service.</span>

<span class="sd">        Arg:</span>
<span class="sd">            replicaID: The ID of the replica registered with the service.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/unRegisterReplica&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">REPLICA_ID</span><span class="p">:</span> <span class="n">replicaID</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="FeatureLayer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer">[docs]</a><span class="k">class</span> <span class="nc">FeatureLayer</span><span class="p">(</span><span class="n">MapServiceLayer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle Feature Service Layer.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with url and login credentials.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            url: Feature service layer url.</span>
<span class="sd">        (below args only required if security is enabled):</span>
<span class="sd">            usr: Username credentials for ArcGIS Server. Defaults to &#39;&#39;.</span>
<span class="sd">            pw: Password credentials for ArcGIS Server. Defaults to &#39;&#39;.</span>
<span class="sd">            token: Token to handle security (alternative to usr and pw) Default is &#39;&#39;.</span>
<span class="sd">            proxy: Option to use proxy page to handle security, need to provide</span>
<span class="sd">                full path to proxy url. Defaults to None.</span>
<span class="sd">            referer: Option to add Referer Header if required by proxy, this parameter</span>
<span class="sd">                is ignored if no proxy is specified. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">FeatureLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">referer</span><span class="p">)</span>

        <span class="c1"># store list of EditResult() objects to track changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editResults</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="FeatureLayer.updateCursor"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.updateCursor">[docs]</a>    <span class="k">def</span> <span class="nf">updateCursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">add_params</span><span class="o">=</span><span class="p">{},</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useGlobalIds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates features in layer using a cursor, the applyEdits() method is </span>
<span class="sd">                automatically called when used in a &quot;with&quot; statement and auto_save is True.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fields: Optional fields to return. Default is &quot;*&quot; to return all </span>
<span class="sd">                fields.</span>
<span class="sd">            where: Optional where clause, defaults to &#39;1=1&#39;.</span>
<span class="sd">            add_params: Optional extra parameters to add to query string passed </span>
<span class="sd">                as dict. Defaults to {}.</span>
<span class="sd">            records: Optional number of records to return.  Default is None to return all</span>
<span class="sd">                records within bounds of max record count unless exceed_limit is True.</span>
<span class="sd">            exceed_limit: option to get all records in layer. This option may be time consuming</span>
<span class="sd">                because the ArcGIS REST API uses default maxRecordCount of 1000, so queries</span>
<span class="sd">                must be performed in chunks to get all records.</span>
<span class="sd">            auto_save: Optional boolean arg to automatically apply edits when </span>
<span class="sd">                using with statement, if True, will apply edits on the __exit__ </span>
<span class="sd">                method. Defaults to True.</span>
<span class="sd">            useGlobalIds: (added at 10.4) Optional parameter which is false by </span>
<span class="sd">                default. Requires the layer&#39;s supportsApplyEditsWithGlobalIds </span>
<span class="sd">                property to be true.  When set to true, the features and attachments </span>
<span class="sd">                in the adds, updates, deletes, and attachments parameters are </span>
<span class="sd">                identified by their globalIds. When true, the service adds the </span>
<span class="sd">                new features and attachments while preserving the globalIds </span>
<span class="sd">                submitted in the payload. If the globalId of a feature </span>
<span class="sd">                (or an attachment) collides with a preexisting feature </span>
<span class="sd">                (or an attachment), that feature and/or attachment add fails. </span>
<span class="sd">                Other adds, updates, or deletes are attempted if rollbackOnFailure</span>
<span class="sd">                is false. If rollbackOnFailure is true, the whole operation </span>
<span class="sd">                fails and rolls back on any failure including a globalId collision.</span>
<span class="sd">                When useGlobalIds is true, updates and deletes are identified by </span>
<span class="sd">                each feature or attachment globalId rather than their objectId </span>
<span class="sd">                or attachmentId.</span>
<span class="sd">            kwargs: Any additional keyword arguments supported by the applyEdits method of the REST API, see</span>
<span class="sd">            http://resources.arcgis.com/en/help/arcgis:restapi/index.html#/Apply_Edits_Feature_Service_Layer/02r3000000r6000000/</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">class</span> <span class="nc">UpdateCursor</span><span class="p">(</span><span class="n">Cursor</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Class that updates a cursor.&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">feature_set</span><span class="p">,</span> <span class="n">fieldOrder</span><span class="o">=</span><span class="p">[],</span> <span class="n">auto_save</span><span class="o">=</span><span class="n">auto_save</span><span class="p">,</span> <span class="n">useGlobalIds</span><span class="o">=</span><span class="n">useGlobalIds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Inits class with cursor parameters.</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    feature_set: Feature set as json or restapi.FeatureSet() object.</span>
<span class="sd">                    fieldOrder: List of order of fields for cursor row returns. </span>
<span class="sd">                        Defaults to [].</span>
<span class="sd">                    auto_save: Optional boolean, determines whether autosave is enabled or not.</span>
<span class="sd">                    useGlobalIds: Optional boolean, when set to true, the features </span>
<span class="sd">                        and attachments in the adds, updates, deletes, and </span>
<span class="sd">                        attachments parameters are identified by their globalIds. </span>
<span class="sd">                &quot;&quot;&quot;</span>
                
                <span class="nb">super</span><span class="p">(</span><span class="n">UpdateCursor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">feature_set</span><span class="p">,</span> <span class="n">fieldOrder</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">useGlobalIds</span> <span class="o">=</span> <span class="n">useGlobalIds</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deletes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_feature_lookup_by_oid</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">ft</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">ft</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ft</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attachments</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">ADDS</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="n">UPDATES</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="n">DELETES</span><span class="p">:</span> <span class="p">[]</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span><span class="p">(</span><span class="s1">&#39;feature_set&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;auto_save&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                    <span class="n">ft</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ft</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">has_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OID_FIELD_NAME</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OID_FIELD_NAME</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">has_globalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD_NAME</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD_NAME</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">canEditByGlobalId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">all</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">useGlobalIds</span><span class="p">,</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">canUseGlobalIdsForEditing</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">has_globalid</span><span class="p">,</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD_NAME</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_names</span>
                <span class="p">])</span>

            <span class="k">def</span> <span class="nf">_find_by_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Gets a feature by its OID.</span>
<span class="sd">                </span>
<span class="sd">                Arg:</span>
<span class="sd">                    oid: Object ID.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span> <span class="o">==</span> <span class="n">oid</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ft</span>

            <span class="k">def</span> <span class="nf">_find_index_by_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Gets the index of a Feature by it&#39;s OID.</span>
<span class="sd">                </span>
<span class="sd">                Arg:</span>
<span class="sd">                    oid: Object ID.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_lookup_by_oid</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
                <span class="c1"># for i, ft in enumerate(self.features):</span>
                <span class="c1">#     if self._get_oid(ft) == oid:</span>
                <span class="c1">#         return i</span>

            <span class="k">def</span> <span class="nf">_replace_feature_with_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Replaces a feature with OID with another Feature.</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    oid: Object ID.</span>
<span class="sd">                    feature: The input feature.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toJson</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">oid</span><span class="p">:</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">layer</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">]</span> <span class="o">=</span> <span class="n">oid</span>
                <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_index_by_oid</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>
                <span class="c1"># for i, ft in enumerate(self.features):</span>
                <span class="c1">#     if self._get_oid(ft) == oid:</span>
                <span class="c1">#         self.features[i] = feature</span>

            <span class="k">def</span> <span class="nf">_find_by_globalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">globalid</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns a feature by its GlobalId.</span>
<span class="sd">                </span>
<span class="sd">                Arg:</span>
<span class="sd">                    globalid: The Global ID.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_globalid</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span> <span class="o">==</span> <span class="n">globalid</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ft</span>

            <span class="k">def</span> <span class="nf">_find_index_by_globalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">globalid</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the index of a Feature by it&#39;s GlobalId.</span>
<span class="sd">                </span>
<span class="sd">                Arg:</span>
<span class="sd">                    globalid: The Global ID.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_globalid</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span> <span class="o">==</span> <span class="n">globalid</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">i</span>

            <span class="k">def</span> <span class="nf">_replace_feature_with_globalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">globalid</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Replaces a feature with GlobalId with another Feature.</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    globalid: The Global ID.</span>
<span class="sd">                    feature: The input feature.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toJson</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_globalid</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">globalid</span><span class="p">:</span>
                    <span class="n">feature</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">layer</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">]</span> <span class="o">=</span> <span class="n">globalid</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_globalid</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span> <span class="o">==</span> <span class="n">globalid</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>

            <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_save</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">applyEdits</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns Cursor.rows() as generator.&quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_createRow</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_get_oid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the oid of a row.</span>
<span class="sd">                </span>
<span class="sd">                Arg:</span>
<span class="sd">                    row: The row to find the oid of.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">row</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toJson</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">def</span> <span class="nf">_get_globalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the global ID of a row.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">row</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toJson</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GlobalIdFieldName</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD_NAME</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">def</span> <span class="nf">_get_row_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Returns the appropriate row identifier (OBJECTID or GlobalID).&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canEditByGlobalId</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_globalid</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">addAttachment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_or_oid</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Adds an attachment.</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    row_or_oid: Row returned from cursor or an OID/GlobalId.</span>
<span class="sd">                    attachment: Full path to attachment.</span>

<span class="sd">                Raises:</span>
<span class="sd">                    NotImplemented: &#39;{} does not support attachments!&#39;</span>
<span class="sd">                    ValueError: &#39;No OID field found! In order to add attachments, </span>
<span class="sd">                        make sure the OID field is returned in the query.&#39;</span>
<span class="sd">                    ValueError: &#39;No valid OID or GlobalId found to add attachment!&#39;</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_oid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No OID field found! In order to add attachments, make sure the OID field is returned in the query.&#39;</span><span class="p">)</span>
<span class="c1">##                # cannot get this to work :(</span>
<span class="c1">##                if layer.canApplyEditsWithAttachments:</span>
<span class="c1">##                    att_key = DATA</span>
<span class="c1">##                    if isinstance(attachment, six.string_types) and attachment.startswith(&#39;{&#39;):</span>
<span class="c1">##                        # this is an upload id?</span>
<span class="c1">##                        att_key = UPLOAD_ID</span>
<span class="c1">##                    att = {</span>
<span class="c1">##                        PARENT_GLOBALID: self._get_globalid(row_or_oid),</span>
<span class="c1">##                        att_key: attachment</span>
<span class="c1">##                    }</span>
<span class="c1">##                    self._attachments[ADDS].append(att)</span>
<span class="c1">##                    return</span>

                <span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">row_or_oid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">layer</span><span class="o">.</span><span class="n">addAttachment</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid OID or GlobalId found to add attachment!&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">updateAttachment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_or_oid</span><span class="p">,</span> <span class="n">attachmentId</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Updates an attachment.</span>

<span class="sd">                Args:</span>
<span class="sd">                    row_or_oid: Row returned from cursor or an OID/GlobalId</span>
<span class="sd">                    attachment: Full path to attachment</span>
<span class="sd">                    attachmentId: ID of the attachment.</span>
<span class="sd">                </span>
<span class="sd">                Raises:</span>
<span class="sd">                    ValueError: &#39;No OID field found! In order to add attachments, </span>
<span class="sd">                        make sure the OID field is returned in the query.&#39;</span>
<span class="sd">                    ValueError: &#39;No valid OID or GlobalId found to add attachment!&#39;</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_oid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No OID field found! In order to add attachments, make sure the OID field is returned in the query.&#39;</span><span class="p">)</span>
<span class="c1">##                # cannot get this to work :(</span>
<span class="c1">##                if layer.canApplyEditsWithAttachments:</span>
<span class="c1">##                    att_key = DATA</span>
<span class="c1">##                    if isinstance(attachment, six.string_types) and attachment.startswith(&#39;{&#39;):</span>
<span class="c1">##                        # this is an upload id?</span>
<span class="c1">##                        att_key = UPLOAD_ID</span>
<span class="c1">##                    att = {</span>
<span class="c1">##                        PARENT_GLOBALID: self._get_globalid(row_or_oid),</span>
<span class="c1">##                        GLOBALID_CAMEL: attachmentId,</span>
<span class="c1">##                        att_key: attachment</span>
<span class="c1">##                    }</span>
<span class="c1">##                    self._attachments[UPDATES].append(att)</span>
<span class="c1">##                    return</span>

                <span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">row_or_oid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">layer</span><span class="o">.</span><span class="n">updateAttachment</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">attachmentId</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid OID or GlobalId found to add attachment!&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">deleteAttachments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_or_oid</span><span class="p">,</span> <span class="n">attachmentIds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Deletes an attachment.</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    row_or_oid: Row returned from cursor or an OID/GlobalId.</span>
<span class="sd">                    attachment: Full path to attachment.</span>
<span class="sd">                    attachmentIds: ID&#39;s for the attachment.</span>
<span class="sd">                </span>
<span class="sd">                Raises:</span>
<span class="sd">                    ValueError: &#39;No OID field found! In order to add attachments, </span>
<span class="sd">                        make sure the OID field is returned in the query.&#39;</span>
<span class="sd">                    ValueError: &#39;No valid OID or GlobalId found to add attachment!&#39;</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_oid</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No OID field found! In order to add attachments, make sure the OID field is returned in the query.&#39;</span><span class="p">)</span>

                <span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">row_or_oid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">oid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">layer</span><span class="o">.</span><span class="n">deleteAttachments</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">attachmentIds</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No valid OID or GlobalId found to add attachment!&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">updateRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Updates the feature with values from updated row.  If not used </span>
<span class="sd">                        in context of a &quot;with&quot; statement, updates will have to be </span>
<span class="sd">                        applied manually after all edits are made using the </span>
<span class="sd">                        UpdateCursor.applyEdits() method.  When used in the </span>
<span class="sd">                        context of a &quot;with&quot; statement, edits are automatically </span>
<span class="sd">                        applied on __exit__.</span>

<span class="sd">                Arg:</span>
<span class="sd">                    row: List/tuple/Feature/Row that has been updated.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toJson</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canEditByGlobalId</span><span class="p">:</span>
                    <span class="n">globalid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_globalid</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replace_feature_with_globalid</span><span class="p">(</span><span class="n">globalid</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replace_feature_with_oid</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">deleteRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Deletes the row.</span>

<span class="sd">                Arg:</span>
<span class="sd">                    row: List/tuple/Feature/Row that has been updated.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="n">oid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_oid</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_by_oid</span><span class="p">(</span><span class="n">oid</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">oid</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_deletes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">applyEdits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Applies edits to a layer.&quot;&quot;&quot;</span>
                <span class="n">attCount</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">atts</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">atts</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attachments</span><span class="p">)])</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_oid</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_globalid</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">canUseGlobalIdsForEditing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGlobalIds</span><span class="p">))</span> \
                <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_updates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deletes</span><span class="p">,</span> <span class="n">attCount</span><span class="p">]):</span>
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">UPDATES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updates</span><span class="p">,</span> <span class="n">DELETES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deletes</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">canApplyEditsWithAttachments</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attachments</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">ATTACHMENTS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attachments</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">):</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">canUseGlobalIdsForEditing</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">USE_GLOBALIDS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGlobalIds</span>
                    <span class="k">return</span> <span class="n">layer</span><span class="o">.</span><span class="n">applyEdits</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_oid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">has_globalid</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">canUseGlobalIdsForEditing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">useGlobalIds</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Missing OID or GlobalId Field in Data!&#39;</span><span class="p">)</span>

        <span class="n">cur_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">cur_fields</span><span class="p">,</span> <span class="n">add_params</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">exceed_limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">UpdateCursor</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeatureLayer.insertCursor"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.insertCursor">[docs]</a>    <span class="k">def</span> <span class="nf">insertCursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[],</span> <span class="n">template_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts new features into layer using a cursor, , the applyEdits() </span>
<span class="sd">                method is automatically called when used in a &quot;with&quot; statement </span>
<span class="sd">                and auto_save is True.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fields: List of fields for cursor.</span>
<span class="sd">            template_name: Optional name of template from type. Defaults to None.</span>
<span class="sd">            auto_save: Optional boolean, automatically apply edits when using </span>
<span class="sd">                with statement, if True, will apply edits on the __exit__ method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GLOBALID</span><span class="p">,</span> <span class="n">OID</span><span class="p">)]</span>
        <span class="k">class</span> <span class="nc">InsertCursor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Class that inserts cursor.&quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_adds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_geometry</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">FEATURE_LAYER</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHAPE_TOKEN</span><span class="p">,</span> <span class="n">OID_TOKEN</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">OIDFieldName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">template_name</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prototype</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="p">{</span><span class="n">ATTRIBUTES</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">NULL</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">}}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="p">{</span><span class="n">ATTRIBUTES</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">NULL</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">}}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_geometry</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="n">NULL</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">geometry_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">SHAPE_TOKEN</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">geometry_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">shapeFieldName</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">geometry_index</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">def</span> <span class="nf">insertRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Inserts a row into the InsertCursor._adds cache.</span>
<span class="sd">                </span>
<span class="sd">                Args:</span>
<span class="sd">                    row: List/tuple/dict/Feature/Row that has been updated.</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">)}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="n">SHAPE_TOKEN</span><span class="p">:</span>
                                <span class="n">feature</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">json</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">date_to_mil</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">feature</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_adds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">Feature</span><span class="p">):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">json</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">GEOMETRY</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_geometry</span><span class="p">:</span>
                        <span class="n">feature</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">])</span><span class="o">.</span><span class="n">json</span>
                    <span class="k">if</span> <span class="n">ATTRIBUTES</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">date_to_mil</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">feature</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">date_to_mil</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">feature</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="n">SHAPE_TOKEN</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_geometry</span><span class="p">:</span>
                                <span class="n">feature</span><span class="p">[</span><span class="n">GEOMETRY</span><span class="p">]</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">json</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_adds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="k">def</span> <span class="nf">applyEdits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Applies the edits to the layer.&quot;&quot;&quot;</span>
                <span class="k">return</span> <span class="n">layer</span><span class="o">.</span><span class="n">applyEdits</span><span class="p">(</span><span class="n">adds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_adds</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span>

            <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">auto_save</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">applyEdits</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">InsertCursor</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">auto_save</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">canUseGlobalIdsForEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Will be true if the layer supports applying edits where globalid values</span>
<span class="sd">                provided by the client are used. In order for supportsApplyEditsWithGlobalIds</span>
<span class="sd">                to be true, layers must have a globalid column and have </span>
<span class="sd">                isDataVersioned as false. Layers with hasAttachments as true </span>
<span class="sd">                additionally require attachments with globalids</span>
<span class="sd">                and attachments related to features via the features globalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compatible_with_version</span><span class="p">(</span><span class="mf">10.4</span><span class="p">),</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SUPPORTS_APPLY_EDITS_WITH_GLOBALIDS</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SUPPORTS_APPLY_EDITS_WITH_GLOBALIDS</span><span class="p">)</span>
        <span class="p">])</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">canApplyEditsWithAttachments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience property to check if attachments can be edited in</span>
<span class="sd">        applyEdits() method.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compatible_with_version</span><span class="p">(</span><span class="mf">10.4</span><span class="p">),</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">),</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HAS_ATTACHMENTS</span><span class="p">)</span>
            <span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="FeatureLayer.guess_content_type"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.guess_content_type">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">guess_content_type</span><span class="p">(</span><span class="n">attachment</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># use mimetypes to guess &quot;content_type&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
                <span class="n">known</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">types_map</span>
                <span class="n">common</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">common_types</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">attachment</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">known</span><span class="p">:</span>
                    <span class="n">content_type</span> <span class="o">=</span> <span class="n">known</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
                    <span class="n">content_type</span> <span class="o">=</span> <span class="n">common</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">content_type</span></div>

<div class="viewcode-block" id="FeatureLayer.get_template"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a template by name.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name: Optional arg for name of template. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NAME</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TYPES</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">type_names</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TYPES</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NAME</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">t</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TYPES</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="FeatureLayer.addFeatures"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.addFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">addFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rollbackOnFailure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds new features to feature service layer.</span>

<span class="sd">        Args:</span>
<span class="sd">            features: Esri JSON representation of features.</span>
<span class="sd">            gdbVersion: Optional arg for geodatabase version, defaults to &#39;&#39;.</span>
<span class="sd">            rollbackOnFailure: Optional boolean that determines if feature is </span>
<span class="sd">                rolled back if method fails. Defaults to True.</span>

<span class="sd">        ex:</span>
<span class="sd">        adds = [{&quot;geometry&quot;:</span>
<span class="sd">                     {&quot;x&quot;:-10350208.415443439,</span>
<span class="sd">                      &quot;y&quot;:5663994.806146532,</span>
<span class="sd">                      &quot;spatialReference&quot;:</span>
<span class="sd">                          {&quot;wkid&quot;:102100}},</span>
<span class="sd">                 &quot;attributes&quot;:</span>
<span class="sd">                     {&quot;Utility_Type&quot;:2,&quot;Five_Yr_Plan&quot;:&quot;No&quot;,&quot;Rating&quot;:None,&quot;Inspection_Date&quot;:1429885595000}}]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">add_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/addFeatures&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">FEATURES</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
                  <span class="n">GDB_VERSION</span><span class="p">:</span> <span class="n">gdbVersion</span><span class="p">,</span>
                  <span class="n">ROLLBACK_ON_FAILURE</span><span class="p">:</span> <span class="n">rollbackOnFailure</span><span class="p">,</span>
                  <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>

        <span class="c1"># add features</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.updateFeatures"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.updateFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">updateFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rollbackOnFailure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates features in feature service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            features: Features to be updated (JSON).</span>
<span class="sd">            Args:*</span>
<span class="sd">            gdbVersion: Optional geodatabase version to apply edits. Defaults to &#39;&#39;.</span>
<span class="sd">            rollbackOnFailure: Optional boolean, specifies if the edits should be</span>
<span class="sd">                applied only if all submitted edits succeed</span>
<span class="sd">        </span>
<span class="sd">        # example syntax</span>
<span class="sd">        updates = [{&quot;geometry&quot;:</span>
<span class="sd">            {&quot;x&quot;::10350208.415443439,</span>
<span class="sd">            &quot;y&quot;:5663994.806146532,</span>
<span class="sd">            &quot;spatialReference&quot;:</span>
<span class="sd">            {&quot;wkid&quot;:102100}},</span>
<span class="sd">            &quot;attributes&quot;:</span>
<span class="sd">            {&quot;Five_Yr_Plan&quot;:&quot;Yes&quot;,&quot;Rating&quot;:90,&quot;OBJECTID&quot;:1}}] #only fields that were changed!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">update_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/updateFeatures&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">FEATURES</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
                  <span class="n">GDB_VERSION</span><span class="p">:</span> <span class="n">gdbVersion</span><span class="p">,</span>
                  <span class="n">ROLLBACK_ON_FAILURE</span><span class="p">:</span> <span class="n">rollbackOnFailure</span><span class="p">,</span>
                  <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>

        <span class="c1"># update features</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reques</span><span class="p">(</span><span class="n">update_url</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.deleteFeatures"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.deleteFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">deleteFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oids</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">geometryType</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                       <span class="n">spatialRel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rollbackOnFailure</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes features based on list of OIDs.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            oids: Optional list of oids or comma separated values. Defaults to &#39;&#39;.</span>
<span class="sd">            where: Optional where clause for features to be deleted.  All selected </span>
<span class="sd">                features will be deleted. Defaults to &#39;&#39;.</span>
<span class="sd">            geometry: Optional geometry JSON object used to delete features. </span>
<span class="sd">                Defaults to &#39;&#39;.</span>
<span class="sd">            geometryType: Optional type of geometry. Defaults to &#39;&#39;.</span>
<span class="sd">            spatialRel: Optional spatial relationship.  Defaults to &#39;&#39;.</span>
<span class="sd">            inSR: Optional input spatial reference for geometry. Defaults to &#39;&#39;.</span>
<span class="sd">            gdbVersion: Optional geodatabase version to apply edits. Defaults to &#39;&#39;.</span>
<span class="sd">            rollbackOnFailure: Optional specify if the edits should be applied </span>
<span class="sd">                only if all submitted edits succeed. Defaults to True.</span>
<span class="sd">        </span>
<span class="sd">        oids format example:</span>
<span class="sd">            oids = [1, 2, 3] # list</span>
<span class="sd">            oids = &quot;1, 2, 4&quot; # as string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">geometryType</span><span class="p">:</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">ESRI_ENVELOPE</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spatialRel</span><span class="p">:</span>
            <span class="n">spatialRel</span> <span class="o">=</span> <span class="n">ESRI_INTERSECT</span>

        <span class="n">del_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/deleteFeatures&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">oids</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">oids</span><span class="p">))</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">OBJECT_IDS</span><span class="p">:</span> <span class="n">oids</span><span class="p">,</span>
                  <span class="n">WHERE</span><span class="p">:</span> <span class="n">where</span><span class="p">,</span>
                  <span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
                  <span class="n">GEOMETRY_TYPE</span><span class="p">:</span> <span class="n">geometryType</span><span class="p">,</span>
                  <span class="n">SPATIAL_REL</span><span class="p">:</span> <span class="n">spatialRel</span><span class="p">,</span>
                  <span class="n">GDB_VERSION</span><span class="p">:</span> <span class="n">gdbVersion</span><span class="p">,</span>
                  <span class="n">ROLLBACK_ON_FAILURE</span><span class="p">:</span> <span class="n">rollbackOnFailure</span><span class="p">,</span>
                  <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>

        <span class="c1"># delete features</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">del_url</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.applyEdits"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.applyEdits">[docs]</a>    <span class="k">def</span> <span class="nf">applyEdits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deletes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attachments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rollbackOnFailure</span><span class="o">=</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">useGlobalIds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies edits on a feature service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            adds: Optional features to add (JSON). Defaults to None.</span>
<span class="sd">            updates: Optional features to be updated (JSON). Defaults to None.</span>
<span class="sd">            deletes: Optional oids to be deleted </span>
<span class="sd">                (list, tuple, or comma separated string). Defaults to None.</span>
<span class="sd">            attachments: Optional attachments to be added, updated or deleted </span>
<span class="sd">                (added at version 10.4). Attachments in this instance must use </span>
<span class="sd">                global IDs and the layer&#39;s &quot;supportsApplyEditsWithGlobalIds&quot; must </span>
<span class="sd">                be true. Defaults to None.</span>
<span class="sd">            gdbVersion: Optional geodatabase version to apply edits.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            rollbackOnFailure: Optional boolean to specify if the edits should be </span>
<span class="sd">                applied only if all submitted edits succeed. Defaults to True.</span>
<span class="sd">            useGlobalIds: (added at 10.4) Optional parameter which is false by </span>
<span class="sd">                default. Requires the layer&#39;s supportsApplyEditsWithGlobalIds </span>
<span class="sd">                property to be true.  When set to true, the features and </span>
<span class="sd">                attachments in the adds, updates, deletes, and attachments </span>
<span class="sd">                parameters are identified by their globalIds. When true, the </span>
<span class="sd">                service adds the new features and attachments while preserving </span>
<span class="sd">                the globalIds submitted in the payload. If the globalId of a feature</span>
<span class="sd">                (or an attachment) collides with a preexisting feature </span>
<span class="sd">                (or an attachment), that feature and/or attachment add fails.</span>
<span class="sd">                Other adds, updates, or deletes are attempted if rollbackOnFailure</span>
<span class="sd">                is false. If rollbackOnFailure is true, the whole operation </span>
<span class="sd">                fails and rolls back on any failure including a globalId collision.</span>
<span class="sd">                When useGlobalIds is true, updates and deletes are identified by </span>
<span class="sd">                each feature or attachment globalId rather than their objectId or </span>
<span class="sd">                attachmentId.</span>
<span class="sd">            kwargs: Any additional keyword arguments supported by the applyEdits </span>
<span class="sd">                method of the REST API, see</span>
<span class="sd">                http://resources.arcgis.com/en/help/arcgis:restapi/index.html#/Apply_Edits_Feature_Service_Layer/02r3000000r6000000/</span>
<span class="sd">            </span>
<span class="sd">            attachments example (supported only in 10.4 and above):</span>
<span class="sd">            {</span>
<span class="sd">            &quot;adds&quot;: [{</span>
<span class="sd">            &quot;globalId&quot;: &quot;{55E85F98:FBDD4129:9F0B848DD40BD911}&quot;,</span>
<span class="sd">            &quot;parentGlobalId&quot;: &quot;{02041AEF:41744d81:8A98D7AC5B9F4C2F}&quot;,</span>
<span class="sd">            &quot;contentType&quot;: &quot;image/pjpeg&quot;,</span>
<span class="sd">            &quot;name&quot;: &quot;Pothole.jpg&quot;,</span>
<span class="sd">            &quot;uploadId&quot;: &quot;{DD1D0A30:CD6E4ad7:A516C2468FD95E5E}&quot;</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">            &quot;globalId&quot;: &quot;{3373EE9A:461941B7:918BDB54575465BB}&quot;,</span>
<span class="sd">            &quot;parentGlobalId&quot;: &quot;{6FA4AA68:76D84856:971DB91468FCF7B7}&quot;,</span>
<span class="sd">            &quot;contentType&quot;: &quot;image/pjpeg&quot;,</span>
<span class="sd">            &quot;name&quot;: &quot;Debree.jpg&quot;,</span>
<span class="sd">            &quot;data&quot;: &quot;&lt;base 64 encoded data&gt;&quot;</span>
<span class="sd">            }</span>
<span class="sd">            ],</span>
<span class="sd">            &quot;updates&quot;: [{</span>
<span class="sd">            &quot;globalId&quot;: &quot;{8FDD9AEF:E05E440A:94261D7F301E1EBA}&quot;,</span>
<span class="sd">            &quot;contentType&quot;: &quot;image/pjpeg&quot;,</span>
<span class="sd">            &quot;name&quot;: &quot;IllegalParking.jpg&quot;,</span>
<span class="sd">            &quot;uploadId&quot;: &quot;{57860BE4:3B8544DD:A0E7BE252AC79061}&quot;</span>
<span class="sd">            }],</span>
<span class="sd">            &quot;deletes&quot;: [</span>
<span class="sd">            &quot;{95059311:741C4596:88EFC437C50F7C00}&quot;,</span>
<span class="sd">            &quot; {18F43B1C:27544D05:BCB0C4643C331C29}&quot;</span>
<span class="sd">            ]</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">edits_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/applyEdits&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adds</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
            <span class="n">adds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">adds</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">RestapiEncoder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adds</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">adds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">adds</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">RestapiEncoder</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">updates</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">RestapiEncoder</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">RestapiEncoder</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deletes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">deletes</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">deletes</span><span class="p">))</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">ADDS</span><span class="p">:</span> <span class="n">adds</span><span class="p">,</span>
                  <span class="n">UPDATES</span><span class="p">:</span> <span class="n">updates</span><span class="p">,</span>
                  <span class="n">DELETES</span><span class="p">:</span> <span class="n">deletes</span><span class="p">,</span>
                  <span class="n">GDB_VERSION</span><span class="p">:</span> <span class="n">gdbVersion</span><span class="p">,</span>
                  <span class="n">ROLLBACK_ON_FAILURE</span><span class="p">:</span> <span class="n">rollbackOnFailure</span><span class="p">,</span>
                  <span class="n">USE_GLOBALIDS</span><span class="p">:</span> <span class="n">useGlobalIds</span>
        <span class="p">}</span>

        <span class="c1"># handle attachment edits (added at version 10.4) cannot get this to work :(</span>
<span class="c1">##        if self.canApplyEditsWithAttachments and isinstance(attachments, dict):</span>
<span class="c1">##            for edit_type in (ADDS, UPDATES):</span>
<span class="c1">##                if edit_type in attachments:</span>
<span class="c1">##                    for att in attachments[edit_type]:</span>
<span class="c1">##                        if att.get(DATA) and os.path.isfile(att.get(DATA)):</span>
<span class="c1">##                            # multipart encoded files</span>
<span class="c1">##                            ct = self.guess_content_type(att.get(DATA))</span>
<span class="c1">##                            if CONTENT_TYPE not in att:</span>
<span class="c1">##                                att[CONTENT_TYPE] = ct</span>
<span class="c1">##                            if NAME not in att:</span>
<span class="c1">##                                att[NAME] = os.path.basename(att.get(DATA))</span>
<span class="c1">##                            with open(att.get(DATA), &#39;rb&#39;) as f:</span>
<span class="c1">##                                att[DATA] = &#39;data:{};base64,&#39;.format(ct) + base64.b64encode(f.read())</span>
<span class="c1">##                                print(att[DATA][:50])</span>
<span class="c1">##                            if GLOBALID_CAMEL not in att:</span>
<span class="c1">##                                att[GLOBALID_CAMEL] = &#39;f5e0f368-17a1-4062-b848-48eee2dee1d5&#39;</span>
<span class="c1">##                        temp = {k:v for k,v in six.iteritems(att) if k != &#39;data&#39;}</span>
<span class="c1">##                        temp[DATA] = att[&#39;data&#39;][:50]</span>
<span class="c1">##                        print(json.dumps(temp, indent=2))</span>
<span class="c1">##            params[ATTACHMENTS] = attachments</span>
<span class="c1">##            if any([params[ATTACHMENTS].get(k) for k in (ADDS, UPDATES, DELETES)]):</span>
<span class="c1">##                params[USE_GLOBALIDS] = TRUE</span>
        <span class="c1"># add other keyword arguments</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">edits_url</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.addAttachment"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.addAttachment">[docs]</a>    <span class="k">def</span> <span class="nf">addAttachment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds an attachment to a feature service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            oid: OBJECT ID of feature in which to add attachment.</span>
<span class="sd">            attachment: Path to attachment.</span>
<span class="sd">            content_type: Optional html media type for &quot;content_type&quot; header.  </span>
<span class="sd">                If nothing provided, will use a best guess based on file extension </span>
<span class="sd">                (using mimetypes). Defaults to &#39;&#39;.</span>
<span class="sd">            gdbVersion: Optional geodatabase version for attachment. Defaults to &#39;&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: &#39;FeatureLayer &quot;{}&quot; does not support attachments!&#39;</span>
<span class="sd">            </span>
<span class="sd">        Valid content types can be found here @:</span>
<span class="sd">            http://en.wikipedia.org/wiki/Internet_media_type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttachments</span><span class="p">:</span>

            <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_content_type</span><span class="p">(</span><span class="n">attachment</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>

            <span class="c1"># make post request</span>
            <span class="n">att_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/addAttachment&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">oid</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="n">ATTACHMENT</span><span class="p">:</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="n">attachment</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="p">)}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">isAGOL</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gdbVersion</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">GDB_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdbVersion</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">att_url</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">oid</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;FeatureLayer &quot;</span><span class="si">{}</span><span class="s1">&quot; does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.deleteAttachments"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.deleteAttachments">[docs]</a>    <span class="k">def</span> <span class="nf">deleteAttachments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">attachmentIds</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes attachments in a feature layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            oid: OBJECT ID of feature in which to add attachment.</span>
<span class="sd">            attachmentIds: IDs of attachments to be deleted.  If attachmentIds </span>
<span class="sd">                param is set to &quot;All&quot;, all attachments for this feature will be </span>
<span class="sd">                deleted.</span>
<span class="sd">            gdbVersion: Optional arg for geodatabase verison, defaults to &#39;&#39;.</span>
<span class="sd">            kwargs: Optional, additional keyword arguments supported by </span>
<span class="sd">                deleteAttachments method.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: &#39;FeatureLayer &quot;{}&quot; does not support attachments!&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttachments</span><span class="p">:</span>
            <span class="n">att_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/deleteAttachments&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">oid</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attachmentIds</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">attachmentIds</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">attachmentIds</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attachmentIds</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attachmentIds</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
                <span class="n">attachmentIds</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attachments</span><span class="p">(</span><span class="n">oid</span><span class="p">)]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attachmentIds</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">ATTACHMENT_IDS</span><span class="p">:</span> <span class="n">attachmentIds</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">isAGOL</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gdbVersion</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">GDB_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdbVersion</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">att_url</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">oid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;FeatureLayer &quot;</span><span class="si">{}</span><span class="s1">&quot; does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.updateAttachment"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.updateAttachment">[docs]</a>    <span class="k">def</span> <span class="nf">updateAttachment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">attachmentId</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">gdbVersion</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds an attachment to a feature service layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            oid: OBJECT ID of feature in which to add attachment.</span>
<span class="sd">            attachmentId: ID of feature attachment.</span>
<span class="sd">            attachment: Path to attachment.</span>
<span class="sd">            content_type: Optional html media type for &quot;content_type&quot; header. </span>
<span class="sd">                If nothing provided, will use a best guess based on file </span>
<span class="sd">                extension (using mimetypes). Defaults to &#39;&#39;.</span>
<span class="sd">            gdbVersion: Optional, geodatabase version for attachment. </span>
<span class="sd">                Defaults to &#39;&#39;.</span>
<span class="sd">            validate: Optional boolean to check if attachment ID exists within </span>
<span class="sd">                feature first before attempting an update, this adds a small </span>
<span class="sd">                amount of overhead to method because a request to fetch attachments </span>
<span class="sd">                is made prior to updating. Default is False.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: &#39;Attachment with ID &quot;{}&quot; not found in Feature with OID &quot;{}&quot;&#39;</span>
<span class="sd">            NotImplementedError: &#39;FeatureLayer &quot;{}&quot; does not support attachments!&#39;</span>

<span class="sd">        valid content types can be found here @:</span>
<span class="sd">            http://en.wikipedia.org/wiki/Internet_media_type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasAttachments</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_content_type</span><span class="p">(</span><span class="n">attachment</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>

            <span class="c1"># make post request</span>
            <span class="n">att_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/updateAttachment&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">oid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attachmentId</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attachments</span><span class="p">(</span><span class="n">oid</span><span class="p">)]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Attachment with ID &quot;</span><span class="si">{}</span><span class="s1">&quot; not found in Feature with OID &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">attachmentId</span><span class="p">))</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="n">ATTACHMENT</span><span class="p">:</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">attachment</span><span class="p">),</span> <span class="nb">open</span><span class="p">(</span><span class="n">attachment</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">content_type</span><span class="p">)}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">ATTACHMENT_ID</span><span class="p">:</span> <span class="n">attachmentId</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">isAGOL</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gdbVersion</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">GDB_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdbVersion</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__edit_handler</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">att_url</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">(),</span> <span class="n">oid</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;FeatureLayer &quot;</span><span class="si">{}</span><span class="s1">&quot; does not support attachments!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="FeatureLayer.calculate"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureLayer.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;1=1&#39;</span><span class="p">,</span> <span class="n">sqlFormat</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates a field in a Feature Layer.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            exp: Expression as JSON [{&quot;field&quot;: &quot;Street&quot;, &quot;value&quot;: &quot;Main St&quot;},..].</span>
<span class="sd">            where: Optional where clause for field calculator. Defaults to &#39;1=1&#39;.</span>
<span class="sd">            sqlFormat: Optional SQL format for expression (standard|native). </span>
<span class="sd">                Defaults to &#39;standard&#39;.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: &#39;FeatureLayer &quot;{}&quot; does not support field calculations!&#39;</span>
<span class="sd">        </span>
<span class="sd">        Example expressions as JSON:</span>
<span class="sd">            exp : [{&quot;field&quot; : &quot;Quality&quot;, &quot;value&quot; : 3}]</span>
<span class="sd">            exp :[{&quot;field&quot; : &quot;A&quot;, &quot;sqlExpression&quot; : &quot;B*3&quot;}]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SUPPORTS_CALCULATE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">calc_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/calculate&#39;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">WHERE</span><span class="p">:</span> <span class="n">where</span><span class="p">,</span>
                <span class="n">CALC_EXPRESSION</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">SQL_FORMAT</span><span class="p">:</span> <span class="n">sqlFormat</span><span class="p">}</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">calc_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;FeatureLayer &quot;</span><span class="si">{}</span><span class="s1">&quot; does not support field calculations!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__edit_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">feature_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler for edit results.</span>

<span class="sd">        response: Response from edit operation.</span>
<span class="sd">        feature_id: Optional ID for feature, defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">e</span> <span class="o">=</span> <span class="n">EditResult</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">feature_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editResults</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="FeatureTable"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.FeatureTable">[docs]</a><span class="k">class</span> <span class="nc">FeatureTable</span><span class="p">(</span><span class="n">FeatureLayer</span><span class="p">,</span> <span class="n">MapServiceTable</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="GeometryService"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService">[docs]</a><span class="k">class</span> <span class="nc">GeometryService</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles the ArcGIS geometry service.&quot;&quot;&quot;</span>
    <span class="n">linear_units</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">LINEAR_UNITS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">_default_url</span> <span class="o">=</span> <span class="s1">&#39;https://utility.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with login info for arcgis geometry service.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            url: Optional arg for url to service. Defaults to None.</span>
<span class="sd">            usr: Optional arg for username for service. Defaults to None.</span>
<span class="sd">            pw: Optional arg for password for service. Defaults to None.</span>
<span class="sd">            token: Optional arg for token for service, Defaults to None.</span>
<span class="sd">            proxy: Optional arg for proxy for service. Defaults to None.</span>
<span class="sd">            referer: Optional arg for referer. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="c1"># use default arcgis online Geometry Service</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_url</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeometryService</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">referer</span><span class="p">)</span>

<div class="viewcode-block" id="GeometryService.getLinearUnits"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.getLinearUnits">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getLinearUnits</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Returns a Munch() dictionary of linear units.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">LINEAR_UNITS</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryService.getLinearUnitWKID"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.getLinearUnitWKID">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getLinearUnitWKID</span><span class="p">(</span><span class="n">unit_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a well known ID from a unit name.</span>

<span class="sd">        Arg:</span>
<span class="sd">            unit_name: Name of unit to fetch WKID for. It is safe to use this as</span>
<span class="sd">                a filter to ensure a valid WKID is extracted.  if a WKID is passed in,</span>
<span class="sd">                that same value is returned.  This argument is expecting a string </span>
<span class="sd">                from linear_units list.  Valid options can be viewed with </span>
<span class="sd">                GeometryService.linear_units.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">unit_name</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">unit_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">LINEAR_UNITS</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">unit_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">WKID</span><span class="p">])</span></div>

<div class="viewcode-block" id="GeometryService.validateGeometries"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.validateGeometries">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validateGeometries</span><span class="p">(</span><span class="n">geometries</span><span class="p">,</span> <span class="n">use_envelopes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates geometries to be passed into operations that use an</span>
<span class="sd">                array of geometries.</span>

<span class="sd">        Args:</span>
<span class="sd">            geometries: List of geometries. Valid inputs are GeometryCollection()&#39;s, </span>
<span class="sd">                json, FeatureSet()&#39;s, or Geometry()&#39;s.</span>
<span class="sd">            use_envelopes: Optional boolean, determines if method will use envelopes </span>
<span class="sd">                of all the input geometries. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="n">geometries</span><span class="p">,</span> <span class="n">use_envelopes</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryService.buffer"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.buffer">[docs]</a>    <span class="nd">@geometry_passthrough</span>
    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometries</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">use_envelopes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Buffers a single geoemetry or multiple.</span>

<span class="sd">        Args:</span>
<span class="sd">            geometries: Array of geometries to be buffered. The spatial reference </span>
<span class="sd">                of the geometries is specified by inSR. The structure of each </span>
<span class="sd">                geometry in the array is the same as the structure of the JSON </span>
<span class="sd">                geometry objects returned by the ArcGIS REST API.  This should be</span>
<span class="sd">                a restapi.GeometryCollection().</span>
<span class="sd">            distances: The distances that each of the input geometries is buffered. </span>
<span class="sd">                The distance units are specified by unit.</span>
<span class="sd">            units: Optional input units (esriSRUnit_Meter|esriSRUnit_StatuteMile|esriSRUnit_Foot|esriSRUnit_Kilometer|</span>
<span class="sd">                esriSRUnit_NauticalMile|esriSRUnit_USNauticalMile). Defaults to &#39;&#39;.</span>
<span class="sd">            inSR: Optional wkid for input geometry. Default is None.</span>
<span class="sd">            outSR: Optional wkid for output geometry. Default is &#39;&#39;.</span>
<span class="sd">            use_envelopes: Optional arg, not a valid option in ArcGIS REST API, </span>
<span class="sd">                this is an extra argument that will convert the geometries to </span>
<span class="sd">                bounding box envelopes ONLY IF they are restapi.Geometry objects,</span>
<span class="sd">                otherwise this arg is ignored.</span>

<span class="sd">        restapi constants for units:</span>
<span class="sd">            restapi.ESRI_METER</span>
<span class="sd">            restapi.ESRI_MILE</span>
<span class="sd">            restapi.ESRI_FOOT</span>
<span class="sd">            restapi.ESRI_KILOMETER</span>
<span class="sd">            restapi.ESRI_NAUTICAL_MILE</span>
<span class="sd">            restapi.ESRI_US_NAUTICAL_MILE</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">buff_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/buffer&#39;</span>
        <span class="n">geometries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateGeometries</span><span class="p">(</span><span class="n">geometries</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">PJSON</span><span class="p">,</span>
                  <span class="n">GEOMETRIES</span><span class="p">:</span> <span class="n">geometries</span><span class="p">,</span>
                  <span class="n">IN_SR</span><span class="p">:</span> <span class="n">inSR</span> <span class="ow">or</span> <span class="n">geometries</span><span class="o">.</span><span class="n">getSR</span><span class="p">(),</span>
                  <span class="n">DISTANCES</span><span class="p">:</span> <span class="n">distances</span><span class="p">,</span>
                  <span class="n">UNIT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLinearUnitWKID</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="ow">or</span> <span class="n">unit</span><span class="p">,</span>
                  <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span><span class="p">,</span>
                  <span class="n">UNION_RESULTS</span><span class="p">:</span> <span class="n">FALSE</span><span class="p">,</span>
                  <span class="n">GEODESIC</span><span class="p">:</span> <span class="n">TRUE</span><span class="p">,</span>
                  <span class="n">OUT_SR</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">BUFFER_SR</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

        <span class="c1"># add kwargs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">GEOMETRIES</span><span class="p">,</span> <span class="n">DISTANCES</span><span class="p">,</span> <span class="n">UNIT</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># perform operation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;params: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">GEOMETRIES</span><span class="p">}))</span>
        <span class="k">return</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">buff_url</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span>
                                  <span class="n">spatialReference</span><span class="o">=</span><span class="n">outSR</span> <span class="k">if</span> <span class="n">outSR</span> <span class="k">else</span> <span class="n">inSR</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryService.intersect"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.intersect">[docs]</a>    <span class="nd">@geometry_passthrough</span>
    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometries</span><span class="p">,</span> <span class="n">geometry</span><span class="p">,</span> <span class="n">sr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs intersection of input geometries and other geometry.</span>

<span class="sd">        Args:</span>
<span class="sd">            geometries: Input geometries </span>
<span class="sd">                (GeometryCollection|FeatureSet|json|arcpy.mapping.Layer|FeatureClass|Shapefile).</span>
<span class="sd">            geometry: Other geometry to intersect.</span>
<span class="sd">            sr: Optional spatial reference for input geometries, if not specified </span>
<span class="sd">                will be derived from input geometries.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/intersect&#39;</span>
        <span class="n">geometries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateGeometries</span><span class="p">(</span><span class="n">geometries</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">sr</span> <span class="ow">or</span> <span class="n">geometries</span><span class="o">.</span><span class="n">getWKID</span><span class="p">()</span> <span class="ow">or</span> <span class="n">NULL</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geometry</span><span class="p">,</span>
            <span class="n">GEOMETRIES</span><span class="p">:</span> <span class="n">geometries</span><span class="p">,</span>
            <span class="n">SR</span><span class="p">:</span> <span class="n">sr</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">spatialReference</span><span class="o">=</span><span class="n">sr</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryService.union"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.union">[docs]</a>    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometries</span><span class="p">,</span> <span class="n">sr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs union of input geometries.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            geometries: Input geometries </span>
<span class="sd">                (GeometryCollection|FeatureSet|json|arcpy.mapping.Layer|FeatureClass|Shapefile).</span>
<span class="sd">            sr: Optional spatial reference for input geometries, if not specified </span>
<span class="sd">                will be derived from input geometries.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/union&#39;</span>
        <span class="n">geometries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateGeometries</span><span class="p">(</span><span class="n">geometries</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">sr</span> <span class="ow">or</span> <span class="n">geometries</span><span class="o">.</span><span class="n">getWKID</span><span class="p">()</span> <span class="ow">or</span> <span class="n">NULL</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geometries</span><span class="p">,</span>
            <span class="n">GEOMETRIES</span><span class="p">:</span> <span class="n">geometries</span><span class="p">,</span>
            <span class="n">SR</span><span class="p">:</span> <span class="n">sr</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Geometry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">spatialReference</span><span class="o">=</span><span class="n">sr</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryService.findTransformations"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.findTransformations">[docs]</a>    <span class="k">def</span> <span class="nf">findTransformations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inSR</span><span class="p">,</span> <span class="n">outSR</span><span class="p">,</span> <span class="n">extentOfInterest</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">numOfResults</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds and returns the most applicable transformation based on inSR and </span>
<span class="sd">                outSR.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            inSR: Input Spatial Reference (wkid).</span>
<span class="sd">            outSR: Output Spatial Reference (wkid).</span>
<span class="sd">            Args:*</span>
<span class="sd">            extentOfInterest: Optional bounding box of the area of interest </span>
<span class="sd">                specified as a JSON envelope. If provided, the extent of </span>
<span class="sd">                interest is used to return the most applicable geographic </span>
<span class="sd">                transformations for the area. If a spatial reference is </span>
<span class="sd">                not included in the JSON envelope, the inSR is used for the</span>
<span class="sd">                envelope. Defaults to &#39;&#39;.</span>
<span class="sd">            numOfResults: The number of geographic transformations to return. The</span>
<span class="sd">                default value is 1. If numOfResults has a value of 1, all applicable</span>
<span class="sd">                transformations are returned.</span>

<span class="sd">        return looks like this:</span>
<span class="sd">            [</span>
<span class="sd">              {</span>
<span class="sd">                &quot;wkid&quot;: 15851,</span>
<span class="sd">                &quot;latestWkid&quot;: 15851,</span>
<span class="sd">                &quot;name&quot;: &quot;NAD_1927_To_WGS_1984_79_CONUS&quot;</span>
<span class="sd">              },</span>
<span class="sd">              {</span>
<span class="sd">                &quot;wkid&quot;: 8072,</span>
<span class="sd">                &quot;latestWkid&quot;: 1172,</span>
<span class="sd">                &quot;name&quot;: &quot;NAD_1927_To_WGS_1984_3&quot;</span>
<span class="sd">              },</span>
<span class="sd">              {</span>
<span class="sd">                &quot;geoTransforms&quot;: [</span>
<span class="sd">                  {</span>
<span class="sd">                    &quot;wkid&quot;: 108001,</span>
<span class="sd">                    &quot;latestWkid&quot;: 1241,</span>
<span class="sd">                    &quot;transformForward&quot;: true,</span>
<span class="sd">                    &quot;name&quot;: &quot;NAD_1927_To_NAD_1983_NADCON&quot;</span>
<span class="sd">                  },</span>
<span class="sd">                  {</span>
<span class="sd">                    &quot;wkid&quot;: 108190,</span>
<span class="sd">                    &quot;latestWkid&quot;: 108190,</span>
<span class="sd">                    &quot;transformForward&quot;: false,</span>
<span class="sd">                    &quot;name&quot;: &quot;WGS_1984_(ITRF00)_To_NAD_1983&quot;</span>
<span class="sd">                  }</span>
<span class="sd">                ]</span>
<span class="sd">              }</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">IN_SR</span><span class="p">:</span> <span class="n">inSR</span><span class="p">,</span>
                  <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span><span class="p">,</span>
                  <span class="n">EXTENT_OF_INTEREST</span><span class="p">:</span> <span class="n">extentOfInterest</span><span class="p">,</span>
                  <span class="n">NUM_OF_RESULTS</span><span class="p">:</span> <span class="n">numOfResults</span>
                <span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/findTransformations&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">numOfResults</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="GeometryService.project"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GeometryService.project">[docs]</a>    <span class="nd">@geometry_passthrough</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometries</span><span class="p">,</span> <span class="n">inSR</span><span class="p">,</span> <span class="n">outSR</span><span class="p">,</span> <span class="n">transformation</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">transformForward</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Projects a single or group of geometries.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            geometries: Input geometries to project.</span>
<span class="sd">            inSR: Input spatial reference.</span>
<span class="sd">            outSR: Output spatial reference.</span>
<span class="sd">            transformation: Optional arg for transformation. Defaults to &#39;&#39;.</span>
<span class="sd">            trasnformForward: Optional boolean arg that determines if projection </span>
<span class="sd">                is transformed, default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">GEOMETRIES</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validateGeometries</span><span class="p">(</span><span class="n">geometries</span><span class="p">),</span>
                  <span class="n">IN_SR</span><span class="p">:</span> <span class="n">inSR</span><span class="p">,</span>
                  <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span><span class="p">,</span>
                  <span class="n">TRANSFORMATION</span><span class="p">:</span> <span class="n">transformation</span><span class="p">,</span>
                  <span class="n">TRANSFORM_FORWARD</span><span class="p">:</span> <span class="n">transformForward</span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="n">GeometryCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/project&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span>
                                <span class="n">spatialReference</span><span class="o">=</span><span class="n">outSR</span> <span class="k">if</span> <span class="n">outSR</span> <span class="k">else</span> <span class="n">inSR</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;restapi.GeometryService: &#39;</span><span class="si">{}</span><span class="s2">&#39;&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;restapi.GeometryService&gt;&#39;</span></div>

<div class="viewcode-block" id="ImageService"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ImageService">[docs]</a><span class="k">class</span> <span class="nc">ImageService</span><span class="p">(</span><span class="n">BaseService</span><span class="p">):</span>
    <span class="n">geometry_service</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImageService.adjustbbox"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ImageService.adjustbbox">[docs]</a>    <span class="k">def</span> <span class="nf">adjustbbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundingBox</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to adjust bounding box for image clipping to maintain</span>
<span class="sd">                cell size.</span>

<span class="sd">        Arg:</span>
<span class="sd">            boundingBox: Bounding box string (comma separated).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cell_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixelSizeX</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">boundingBox</span> <span class="o">=</span> <span class="n">boundingBox</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cell_size</span><span class="p">),</span> <span class="n">boundingBox</span><span class="p">)))</span></div>

<div class="viewcode-block" id="ImageService.pointIdentify"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ImageService.pointIdentify">[docs]</a>    <span class="k">def</span> <span class="nf">pointIdentify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to get pixel value from x,y coordinates or JSON point object.</span>

<span class="sd">        Arg:</span>
<span class="sd">            geometry: Input restapi.Geometry() object or point as json. Defaults to None.</span>

<span class="sd">        Recognized key word arguments:</span>
<span class="sd">            x: x coordinate</span>
<span class="sd">            y: y coordinate</span>
<span class="sd">            inSR: Input spatial reference.  Should be supplied if spatial</span>
<span class="sd">                reference is different from the Image Service&#39;s projection.</span>

<span class="sd">        geometry example:</span>
<span class="sd">            geometry = {&quot;x&quot;:3.0,&quot;y&quot;:5.0,&quot;spatialReference&quot;:{&quot;wkid&quot;:102100}}</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Pixel value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">IDurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/identify&#39;</span>

<span class="c1">##        if geometry is not None:</span>
<span class="c1">##            if not isinstance(geometry, Geometry):</span>
<span class="c1">##                geometry = Geometry(geometry)</span>
<span class="c1">##</span>
<span class="c1">##        elif GEOMETRY in kwargs:</span>
<span class="c1">##            g = Geometry(kwargs[GEOMETRY])</span>
<span class="c1">##</span>
<span class="c1">##        elif X in kwargs and Y in kwargs:</span>
<span class="c1">##            g = {X: kwargs[X], Y: kwargs[Y]}</span>
<span class="c1">##            if SR in kwargs:</span>
<span class="c1">##                g[SPATIAL_REFERENCE] = {WKID: kwargs[SR]}</span>
<span class="c1">##            elif SPATIAL_REFERENCE in kwargs:</span>
<span class="c1">##                g[SPATIAL_REFERENCE] = {WKID: kwargs[SPATIAL_REFERENCE]}</span>
<span class="c1">##            else:</span>
<span class="c1">##                g[SPATIAL_REFERENCE] = {WKID: self.getSR()}</span>
<span class="c1">##            geometry = Geometry(g)</span>
<span class="c1">##</span>
<span class="c1">##        else:</span>
<span class="c1">##            raise ValueError(&#39;Not a valid input geometry!&#39;)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">GEOMETRY</span><span class="p">:</span> <span class="n">geometry</span><span class="o">.</span><span class="n">dumps</span><span class="p">(),</span>
            <span class="n">GEOMETRY_TYPE</span><span class="p">:</span> <span class="n">geometry</span><span class="o">.</span><span class="n">geometryType</span><span class="p">,</span>
            <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
            <span class="n">RETURN_GEOMETRY</span><span class="p">:</span> <span class="n">FALSE</span><span class="p">,</span>
            <span class="n">RETURN_CATALOG_ITEMS</span><span class="p">:</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">IDurl</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">j</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">VALUE</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageService.exportImage"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ImageService.exportImage">[docs]</a>    <span class="k">def</span> <span class="nf">exportImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">out_raster</span><span class="p">,</span> <span class="n">envelope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rendering_rule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="n">BILINEAR_INTERPOLATION</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to export an AOI from an Image Service.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            poly: Polygon features.</span>
<span class="sd">            out_raster: Output raster image.</span>
<span class="sd">            envelope: Optional boolean to use envelope of polygon, </span>
<span class="sd">                defaults to False.</span>
<span class="sd">            rendering_rule: Optional rendering rule to perform raster functions </span>
<span class="sd">                as JSON. Defaults to None.</span>
<span class="sd">            interp: Optional arg for interpolation, defaults to </span>
<span class="sd">                BILINEAR_INTERPOLATION.</span>
<span class="sd">            nodata: Optional argument, defaults to None.</span>
<span class="sd">            kwargs: Optional key word arguments for other arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_raster</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">):</span>
            <span class="n">out_raster</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_raster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
        <span class="n">query_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">EXPORT_IMAGE</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">):</span>
            <span class="n">in_geom</span> <span class="o">=</span> <span class="n">poly</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">in_geom</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

        <span class="n">sr</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">getSR</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">envelope</span><span class="p">:</span>
            <span class="n">geojson</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">envelope</span><span class="p">()</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">ESRI_ENVELOPE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geojson</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span>
            <span class="n">geometryType</span> <span class="o">=</span> <span class="n">in_geom</span><span class="o">.</span><span class="n">geometryType</span>

<span class="c1">##        if sr != self.spatialReference:</span>
<span class="c1">##            self.geometry_service = GeometryService()</span>
<span class="c1">##            gc = self.geometry_service.project(in_geom, in_geom.spatialReference, self.getSR())</span>
<span class="c1">##            in_geom = gc</span>

        <span class="c1"># The adjust aspect ratio doesn&#39;t seem to fix the clean pixel issue</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjustbbox</span><span class="p">(</span><span class="n">in_geom</span><span class="o">.</span><span class="n">envelope</span><span class="p">())</span>
        <span class="c1">#if not self.compatible_with_version(10.3):</span>
        <span class="c1">#    bbox = self.adjustbbox(in_geom.envelope())</span>
        <span class="c1">#else:</span>
        <span class="c1">#    bbox = in_geom.envelope()</span>

        <span class="c1"># imageSR</span>
        <span class="k">if</span> <span class="n">IMAGE_SR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">imageSR</span> <span class="o">=</span> <span class="n">sr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imageSR</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">IMAGE_SR</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">NO_DATA</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">nodata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">NO_DATA</span><span class="p">]</span>

        <span class="c1"># check for raster function availability</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRasterFunction</span><span class="p">:</span>
            <span class="n">rendering_rule</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># find width and height for image size (round to whole number)</span>
<span class="c1">##        bbox_int = map(int, map(float, bbox.split(&#39;,&#39;)))</span>
<span class="c1">##        width = abs(bbox_int[0] - bbox_int[2])</span>
<span class="c1">##        height = abs(bbox_int[1] - bbox_int[3])</span>
        <span class="n">bbox_int</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">bbox</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bbox_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox_int</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PIXEL_SIZE_X</span><span class="p">))</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bbox_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox_int</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PIXEL_SIZE_Y</span><span class="p">))</span>

        <span class="n">matchType</span> <span class="o">=</span> <span class="n">NO_DATA_MATCH_ANY</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodata</span><span class="p">):</span>
            <span class="n">matchType</span> <span class="o">=</span> <span class="n">NO_DATA_MATCH_ALL</span>

        <span class="c1"># set params</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">PJSON</span><span class="p">,</span>
             <span class="n">RENDERING_RULE</span><span class="p">:</span> <span class="n">rendering_rule</span><span class="p">,</span>
             <span class="n">ADJUST_ASPECT_RATIO</span><span class="p">:</span> <span class="n">TRUE</span><span class="p">,</span>
             <span class="n">BBOX</span><span class="p">:</span> <span class="n">bbox</span><span class="p">,</span>
             <span class="n">FORMAT</span><span class="p">:</span> <span class="n">TIFF</span><span class="p">,</span>
             <span class="n">IMAGE_SR</span><span class="p">:</span> <span class="n">imageSR</span><span class="p">,</span>
             <span class="n">BBOX_SR</span><span class="p">:</span> <span class="n">sr</span><span class="p">,</span>
             <span class="n">SIZE</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">),</span>
             <span class="n">PIXEL_TYPE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixelType</span><span class="p">,</span>
             <span class="n">NO_DATA_INTERPRETATION</span><span class="p">:</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">[</span><span class="s1">&#39;noData=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodata</span><span class="p">)</span> <span class="k">if</span> <span class="n">nodata</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;noDataInterpretation=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="n">matchType</span> <span class="k">if</span> <span class="n">nodata</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">matchType</span><span class="p">]))),</span>
             <span class="n">INTERPOLATION</span><span class="p">:</span> <span class="n">interp</span>
            <span class="p">}</span>

        <span class="c1"># overwrite with kwargs</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SIZE</span><span class="p">,</span> <span class="n">BBOX_SR</span><span class="p">]:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># post request</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">query_url</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">ret_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_raster</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tiff</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Created: &quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_raster</span><span class="p">))</span></div>

<div class="viewcode-block" id="ImageService.clip"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ImageService.clip">[docs]</a>    <span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">out_raster</span><span class="p">,</span> <span class="n">envelope</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">imageSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">noData</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to clip a raster.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            poly: Polygon.</span>
<span class="sd">            out_raster: Output raster.</span>
<span class="sd">            envelope: Optional boolean to use bounding box, defaults to True.</span>
<span class="sd">            imageSR: Optional arg for spatial reference image, defaults to &#39;&#39;.</span>
<span class="sd">            noData: Optional, defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for raster function availability</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowRasterFunction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;This Service does not support Raster Functions!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">envelope</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">):</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            <span class="n">geojson</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">envelopeAsJSON</span><span class="p">()</span>
            <span class="n">geojson</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geojson</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">)</span> <span class="k">else</span> <span class="n">poly</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span>
        <span class="n">ren</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s2">&quot;rasterFunction&quot;</span> <span class="p">:</span> <span class="s2">&quot;Clip&quot;</span><span class="p">,</span>
          <span class="s2">&quot;rasterFunctionArguments&quot;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ClippingGeometry&quot;</span> <span class="p">:</span> <span class="n">geojson</span><span class="p">,</span>
            <span class="s2">&quot;ClippingType&quot;</span><span class="p">:</span> <span class="n">CLIP_INSIDE</span><span class="p">,</span>
            <span class="p">},</span>
          <span class="s2">&quot;variableName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Raster&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exportImage</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">out_raster</span><span class="p">,</span> <span class="n">rendering_rule</span><span class="o">=</span><span class="n">ren</span><span class="p">,</span> <span class="n">noData</span><span class="o">=</span><span class="n">noData</span><span class="p">,</span> <span class="n">imageSR</span><span class="o">=</span><span class="n">imageSR</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageService.arithmetic"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.ImageService.arithmetic">[docs]</a>    <span class="k">def</span> <span class="nf">arithmetic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">out_raster</span><span class="p">,</span> <span class="n">raster_or_constant</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">RASTER_MULTIPLY</span><span class="p">,</span> <span class="n">envelope</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imageSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs arithmetic operations against a raster.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            poly: Input polygon or JSON polygon object.</span>
<span class="sd">            out_raster: Full path to output raster.</span>
<span class="sd">            raster_or_constant: Raster to perform opertion against or constant value.</span>
<span class="sd">            operation: Optional arithmetic operation to use, default is multiply </span>
<span class="sd">                (3) (RASTER_MULTIPLY) all options: (1|2|3). </span>
<span class="sd">            envelope: Optional boolean, if true, will use bounding box of </span>
<span class="sd">                input features.</span>
<span class="sd">            imageSR: Optional output image spatial reference.</span>
<span class="sd">        </span>
<span class="sd">        Operations:</span>
<span class="sd">        1 : esriRasterPlus</span>
<span class="sd">        2 : esriRasterMinus</span>
<span class="sd">        3 : esriRasterMultiply</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ren</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s2">&quot;rasterFunction&quot;</span> <span class="p">:</span> <span class="s2">&quot;Arithmetic&quot;</span><span class="p">,</span>
              <span class="s2">&quot;rasterFunctionArguments&quot;</span> <span class="p">:</span> <span class="p">{</span>
                   <span class="s2">&quot;Raster&quot;</span> <span class="p">:</span> <span class="s2">&quot;$$&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;Raster2&quot;</span><span class="p">:</span> <span class="n">raster_or_constant</span><span class="p">,</span>
                   <span class="s2">&quot;Operation&quot;</span> <span class="p">:</span> <span class="n">operation</span>
                 <span class="p">}</span>
              <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exportImage</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">out_raster</span><span class="p">,</span> <span class="n">rendering_rule</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">imageSR</span><span class="o">=</span><span class="n">imageSR</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="GPService"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GPService">[docs]</a><span class="k">class</span> <span class="nc">GPService</span><span class="p">(</span><span class="n">BaseService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GP Service object.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        url: GP service url</span>
<span class="sd">    Below args only required if security is enabled:</span>
<span class="sd">        usr: Username credentials for ArcGIS Server.</span>
<span class="sd">        pw: Password credentials for ArcGIS Server.</span>
<span class="sd">        token: Token to handle security (alternative to usr and pw).</span>
<span class="sd">        proxy: Optional boolean to use proxy page to handle security, need to </span>
<span class="sd">            provide full path to proxy url. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GPService.task"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GPService.task">[docs]</a>    <span class="k">def</span> <span class="nf">task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a GP Task object.</span>
<span class="sd">        </span>
<span class="sd">        Arg:</span>
<span class="sd">            name: Name of task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GPTask</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">name</span><span class="p">]))</span></div></div>

<div class="viewcode-block" id="GPTask"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GPTask">[docs]</a><span class="k">class</span> <span class="nc">GPTask</span><span class="p">(</span><span class="n">BaseService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GP Service object.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        url: GP service url</span>
<span class="sd">    Below args only required if security is enabled:</span>
<span class="sd">        usr: Username credentials for ArcGIS Server.</span>
<span class="sd">        pw: Password credentials for ArcGIS Server.</span>
<span class="sd">        token: Token to handle security (alternative to usr and pw).</span>
<span class="sd">        proxy: Optional boolean to use proxy page to handle security, need to </span>
<span class="sd">            provide full path to proxy url. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isSynchronous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Task is synchronous.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executionType</span> <span class="o">==</span> <span class="n">SYNCHRONOUS</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isAsynchronous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Task is asynchronous.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">executionType</span> <span class="o">==</span> <span class="n">ASYNCHRONOUS</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the first output parameter (if there is one).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputParameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of all output parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">OUTPUT_PARAMETER</span><span class="p">]</span>


<div class="viewcode-block" id="GPTask.list_parameters"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GPTask.list_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">list_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists the parameter names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span></div>

<div class="viewcode-block" id="GPTask.run"><a class="viewcode-back" href="../../../restapi/#restapi.common_types.GPTask.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_json</span><span class="o">=</span><span class="p">{},</span> <span class="n">outSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">processSR</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">returnZ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs a Syncrhonous/Asynchronous GP task, automatically uses appropriate </span>
<span class="sd">                option.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: Name of task to run.</span>
<span class="sd">            params_json: JSON object with {parameter_name: value, param2: value2, ...}.</span>
<span class="sd">            outSR: Optional spatial reference for output geometries. Defaults to &#39;&#39;.</span>
<span class="sd">            processSR: Optional spatial reference used for geometry opterations. </span>
<span class="sd">                Defaults to &#39;&#39;.</span>
<span class="sd">            returnZ: Optional boolean to return Z values with data if applicable. </span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            returnM: Optional boolean to return M values with data if applicable. </span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            kwargs: Keyword arguments, can substitute this to pass in GP params </span>
<span class="sd">                by name instead of using the params_json dictionary. Only valid </span>
<span class="sd">                if params_json dictionary is not supplied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSynchronous</span><span class="p">:</span>
            <span class="n">runType</span> <span class="o">=</span> <span class="n">EXECUTE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">runType</span> <span class="o">=</span> <span class="n">SUBMIT_JOB</span>
        <span class="n">gp_exe_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">runType</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params_json</span><span class="p">:</span>
            <span class="n">params_json</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">params_json</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">params_json</span><span class="p">[</span><span class="s1">&#39;env:outSR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outSR</span>
        <span class="n">params_json</span><span class="p">[</span><span class="s1">&#39;env:processSR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processSR</span>
        <span class="n">params_json</span><span class="p">[</span><span class="n">RETURN_Z</span><span class="p">]</span> <span class="o">=</span> <span class="n">returnZ</span>
        <span class="n">params_json</span><span class="p">[</span><span class="n">RETURN_M</span><span class="p">]</span> <span class="o">=</span> <span class="n">returnZ</span>
        <span class="n">params_json</span><span class="p">[</span><span class="n">F</span><span class="p">]</span> <span class="o">=</span> <span class="n">JSON</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">gp_exe_url</span><span class="p">,</span> <span class="n">params_json</span><span class="p">,</span> <span class="n">ret_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">gp_elapsed</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">elapsed</span>

        <span class="c1"># get result object as JSON</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="c1"># determine if there&#39;s an output parameter: if feature set, push result value into defaultValue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputParameter</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputParameter</span><span class="o">.</span><span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;GPFeatureRecordSetLayer&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputParameter</span><span class="o">.</span><span class="n">defaultValue</span>
                <span class="n">feature_set</span> <span class="o">=</span> <span class="n">default</span>
                <span class="n">feature_set</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">RESULTS</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">VALUE</span><span class="p">][</span><span class="n">FEATURES</span><span class="p">]</span>
                <span class="n">feature_set</span><span class="p">[</span><span class="n">FIELDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;Fields&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;Fields&#39;</span> <span class="ow">in</span> <span class="n">default</span> <span class="k">else</span> <span class="n">default</span><span class="p">[</span><span class="n">FIELDS</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="n">VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_set</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">RESULTS</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">VALUE</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GP Task &quot;</span><span class="si">{}</span><span class="s1">&quot; completed successfully. (Elapsed time </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">gp_elapsed</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">GPResult</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../">restapi</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../">Documentation overview</a><ul>
  <li><a href="../../">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Caleb Mackey.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>