
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>restapi.rest_utils &#8212; restapi  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for restapi.rest_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Helper functions and base classes for restapi module&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="c1"># from . import requests</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">munch</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">._strings</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">urllib3.exceptions</span> <span class="k">import</span> <span class="n">InsecureRequestWarning</span><span class="p">,</span> <span class="n">InsecurePlatformWarning</span><span class="p">,</span> <span class="n">SNIMissingWarning</span>
<span class="kn">from</span> <span class="nn">urllib3</span> <span class="k">import</span> <span class="n">disable_warnings</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">.six.moves</span> <span class="k">import</span> <span class="n">urllib</span>

<span class="c1"># disable ssl warnings</span>
<span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SNIMissingWarning</span><span class="p">,</span> <span class="n">InsecurePlatformWarning</span><span class="p">,</span> <span class="n">InsecureRequestWarning</span><span class="p">]:</span>
    <span class="n">disable_warnings</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>

<div class="viewcode-block" id="IdentityManager"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.IdentityManager">[docs]</a><span class="k">class</span> <span class="nc">IdentityManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identity Manager for secured services.  This will allow the user to only have</span>
<span class="sd">            to sign in once (until the token expires) when accessing a services </span>
<span class="sd">            directory or individual service on an ArcGIS Server Site.</span>
<span class="sd">            </span>
<span class="sd">    Attributes:</span>
<span class="sd">        tokens: Dictionary of the tokens.</span>
<span class="sd">        proxies: Dictionary of the proxies.</span>
<span class="sd">        portal_tokens: Dictionary of the portal tokens.       </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_portal_tokens</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="IdentityManager.findToken"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.IdentityManager.findToken">[docs]</a>    <span class="k">def</span> <span class="nf">findToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a token for a specific domain from token store if one has been</span>
<span class="sd">                generated for the ArcGIS Server resource.</span>

<span class="sd">        Arg:</span>
<span class="sd">            url: URL for secured resource.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: &#39;Token expired at {}! Please sign in again.&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="c1"># if fnmatch.fnmatch(url, PORTAL_BASE_PATTERN) and not fnmatch.fnmatch(url, PORTAL_SERVICES_PATTERN):</span>
            <span class="c1">#     url = get_portal_base(url)</span>
            <span class="c1"># elif &#39;/admin/&#39; in url:</span>
            <span class="c1">#     url = url.split(&#39;/admin/&#39;)[0] + &#39;/admin&#39;</span>
            <span class="c1"># else:</span>
            <span class="c1">#     url = url.split(&#39;/rest/services&#39;)[0] + &#39;/rest/services&#39;</span>
            <span class="k">for</span> <span class="n">registered_url</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">registered_url</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isExpired</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">token</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Token expired at </span><span class="si">{}</span><span class="s1">! Please sign in again.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">expires</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="IdentityManager.findProxy"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.IdentityManager.findProxy">[docs]</a>    <span class="k">def</span> <span class="nf">findProxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a proxy url for a specific domain from token store if one has been</span>
<span class="sd">                used to access the ArcGIS Server resource</span>

<span class="sd">        Arg:</span>
<span class="sd">            url: URL for secured resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/rest/services&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/rest/services&#39;</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div></div>

<span class="c1"># initialize Identity Manager</span>
<span class="n">ID_MANAGER</span> <span class="o">=</span> <span class="n">IdentityManager</span><span class="p">()</span>

<span class="c1"># temp dir for json outputs</span>
<span class="n">TEMP_DIR</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">TEMP_DIR</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
    <span class="n">TEMP_DIR</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="namedTuple"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.namedTuple">[docs]</a><span class="k">def</span> <span class="nf">namedTuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a named tuple from a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of namedtuple object.</span>
<span class="sd">        pdict: Parameter dictionary that defines the properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">obj</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))):</span>
        <span class="sd">&quot;&quot;&quot;Class to handle {}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">asJSON</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns object as JSON.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">}</span>

    <span class="n">o</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="o">**</span><span class="n">pdict</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="Round"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.Round">[docs]</a><span class="k">def</span> <span class="nf">Round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns integer rounded to nearest n.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        x: Number to be rounded.</span>
<span class="sd">        base: Number to divide and multiply x by.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">base</span><span class="p">))</span></div>

<div class="viewcode-block" id="iter_chunks"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.iter_chunks">[docs]</a><span class="k">def</span> <span class="nf">iter_chunks</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterates an array in chunks.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        iterable: A valid iterable.</span>
<span class="sd">        n = Number of chunks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">moves</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span></div>

<div class="viewcode-block" id="tmp_json_file"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.tmp_json_file">[docs]</a><span class="k">def</span> <span class="nf">tmp_json_file</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a valid path for a temporary json file&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">TEMP_DIR</span>
    <span class="k">if</span> <span class="n">TEMP_DIR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">TEMP_DIR</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEMP_DIR</span><span class="p">,</span> <span class="s1">&#39;restapi_</span><span class="si">{}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="do_post"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.do_post">[docs]</a><span class="k">def</span> <span class="nf">do_post</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">},</span> <span class="n">ret_json</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Post Request to REST Endpoint through query string, to post</span>
<span class="sd">            request with data in body, use requests.post(url, data:{k : v}).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        service: Full path to REST endpoint of service.</span>
<span class="sd">        params: Optional parameters for posting a request. Defaults to {F: JSON}.</span>
<span class="sd">        ret_json: Optional boolean that returns the response as JSON if True.  </span>
<span class="sd">            Default is True.</span>
<span class="sd">        token: Optional token to handle security (only required if security is enabled).</span>
<span class="sd">            Defaults to &#39;&#39;.</span>
<span class="sd">        cookies: Optional arg for cookie object {&#39;agstoken&#39;: &#39;your_token&#39;}.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        proxy: Option to use proxy page to handle security, need to provide</span>
<span class="sd">            full path to proxy url. Defaults to None.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        NameError: &#39;&quot;{0}&quot; service not found!\n{1}&#39;</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The post request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">PROTOCOL</span>
    <span class="k">if</span> <span class="n">PROTOCOL</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">service</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">://</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PROTOCOL</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookies</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">proxy</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">findToken</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">):</span><span class="c1"># and token.domain.lower() in service.lower():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">isExpired</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Token expired at </span><span class="si">{}</span><span class="s1">! Please sign in again.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">expires</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isAGOL</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isAdmin</span><span class="p">:</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="n">AGS_TOKEN</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TOKEN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isAGOL</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isAdmin</span><span class="p">):</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="n">AGS_TOKEN</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">TOKEN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="c1"># auto fill in geometry params if a restapi.Geometry object is passed in (derived from BaseGeometry)</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRY</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRY</span><span class="p">),</span> <span class="n">BaseGeometry</span><span class="p">):</span>
        <span class="n">geometry</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRY</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">GEOMETRY_TYPE</span> <span class="ow">in</span> <span class="n">params</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">GEOMETRY_TYPE</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">GEOMETRY_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">GEOMETRY_TYPE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">IN_SR</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">IN_SR</span><span class="p">]</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">getWKID</span><span class="p">()</span> <span class="ow">or</span> <span class="n">geometry</span><span class="o">.</span><span class="n">getWKT</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">pName</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">pName</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">RestapiEncoder</span><span class="p">)</span>
            
    <span class="c1"># merge in any kwargs</span>
    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">F</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">F</span><span class="p">]</span> <span class="o">=</span> <span class="n">JSON</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">proxy</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">findProxy</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">isAGOL</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">isAdmin</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">stream</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span>

    <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">do_proxy_request</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">referer</span><span class="p">)</span>
        <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="n">service</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/rest&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/rest/services&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">},</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

    <span class="c1"># make sure return</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot; service not found!</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ret_json</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">JSON</span><span class="p">,</span> <span class="n">PJSON</span><span class="p">):</span>
            <span class="n">_json</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">RequestError</span><span class="p">(</span><span class="n">_json</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">_json</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="do_proxy_request"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.do_proxy_request">[docs]</a><span class="k">def</span> <span class="nf">do_proxy_request</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes request against ArcGIS service through a proxy.  This is designed for a</span>
<span class="sd">            proxy page that stores access credentials in the configuration to </span>
<span class="sd">            handle authentication. It is also assumed that the proxy is a standard </span>
<span class="sd">            Esri proxy, i.e. retrieved from their repo on GitHub @:</span>
<span class="sd">            https://github.com/Esri/resourceproxy</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        proxy: Full url to proxy.</span>
<span class="sd">        url: Service url to make request against.</span>
<span class="sd">        params: Optional query parameters, user is responsible for passing in the</span>
<span class="sd">            proper parameters. Defaults to {}.</span>
<span class="sd">        referer: Optional referer, defaults to None.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The HTTP request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">frmat</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">JSON</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">F</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="n">F</span><span class="p">]</span>

    <span class="c1">#p = &#39;&amp;&#39;.join(&#39;{}={}&#39;.format(k,v) for k,v in six.iteritems(params))</span>

    <span class="c1"># probably a better way to do this...</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">referer</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="n">REFERER_HEADER</span><span class="p">]</span> <span class="o">=</span> <span class="n">referer</span>
    <span class="c1">#return requests.post(&#39;{}?{}?f={}&amp;{}&#39;.format(proxy, url, frmat, p).rstrip(&#39;&amp;&#39;), verify=False, headers=headers)</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">?</span><span class="si">{}</span><span class="s1">?f=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">frmat</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span></div>

<div class="viewcode-block" id="guess_proxy_url"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.guess_proxy_url">[docs]</a><span class="k">def</span> <span class="nf">guess_proxy_url</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grade school level hack to see if there is a standard esri proxy available </span>
<span class="sd">            for a domain.</span>

<span class="sd">    Arg:</span>
<span class="sd">        domain: URL to domain to check for proxy.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The proxy URL, if one is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/arcgis&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">domain</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.ashx&#39;</span><span class="p">,</span> <span class="s1">&#39;.jsp&#39;</span><span class="p">,</span> <span class="s1">&#39;.php&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="n">proxy_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">domain</span><span class="p">,</span> <span class="s1">&#39;proxy&#39;</span> <span class="o">+</span> <span class="n">ptype</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">proxy_url</span><span class="p">)</span>
        <span class="c1"># should produce an error in JSON if using esri proxy out of the box</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span> <span class="ow">or</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># try again looking to see if it is in a folder called &quot;proxy&quot;</span>
    <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="n">proxy_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">domain</span><span class="p">,</span> <span class="n">PROXY</span><span class="p">,</span> <span class="n">PROXY</span> <span class="o">+</span> <span class="n">ptype</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">proxy_url</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="validate_name"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.validate_name">[docs]</a><span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates an output name by removing special characters.</span>
<span class="sd">    </span>
<span class="sd">    Arg:</span>
<span class="sd">        file_name: The name of the file to be validated.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The path for the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">string</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#forward slash in name messes up os.path.split()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fix_encoding</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span></div>

<div class="viewcode-block" id="guess_wkid"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.guess_wkid">[docs]</a><span class="k">def</span> <span class="nf">guess_wkid</span><span class="p">(</span><span class="n">wkt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempts to guess a well-known ID from a well-known text imput (WKT).</span>

<span class="sd">    Arg:</span>
<span class="sd">        wkt: Well known text spatial reference</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The well-known ID, if one is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">wkt</span> <span class="ow">in</span> <span class="n">PRJ_STRINGS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PRJ_STRINGS</span><span class="p">[</span><span class="n">wkt</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;PROJCS&#39;</span> <span class="ow">in</span> <span class="n">wkt</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">wkt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;PROJCS[&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;GEOGCS&#39;</span> <span class="ow">in</span> <span class="n">wkt</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">wkt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;GEOGCS[&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">PRJ_NAMES</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PRJ_NAMES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="assign_unique_name"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.assign_unique_name">[docs]</a><span class="k">def</span> <span class="nf">assign_unique_name</span><span class="p">(</span><span class="n">fl</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assigns a unique file name.</span>

<span class="sd">    Arg:</span>
<span class="sd">        fl: Path of file.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The new, unique file name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fl</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fl</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_name</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tail</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_name</span></div>

<div class="viewcode-block" id="mil_to_date"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.mil_to_date">[docs]</a><span class="k">def</span> <span class="nf">mil_to_date</span><span class="p">(</span><span class="n">mil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Date items from REST services are reported in milliseconds,</span>
<span class="sd">            this function will convert milliseconds to datetime objects.</span>

<span class="sd">    Arg:</span>
<span class="sd">        mil: Time in milliseconds.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Datetime object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mil</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">mil</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mil</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">mil</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="p">(</span><span class="n">mil</span><span class="o">/</span><span class="mi">1000</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># safely cast, to avoid being out of range for platform local time</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">mil</span> <span class="o">/</span><span class="mf">1000.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">struct</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mil</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="date_to_mil"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.date_to_mil">[docs]</a><span class="k">def</span> <span class="nf">date_to_mil</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts datetime.datetime() object to milliseconds.</span>
<span class="sd">    </span>
<span class="sd">    Arg:</span>
<span class="sd">        date: datetime.datetime() object</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Time in milliseconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">date</span> <span class="o">-</span> <span class="n">epoch</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">)</span></div>

<div class="viewcode-block" id="fix_encoding"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.fix_encoding">[docs]</a><span class="k">def</span> <span class="nf">fix_encoding</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fixes unicode by treating as ascii and ignoring errors.</span>
<span class="sd">    </span>
<span class="sd">    Arg:</span>
<span class="sd">        s: Unicode string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="generate_token"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.generate_token">[docs]</a><span class="k">def</span> <span class="nf">generate_token</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">expiration</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a token to handle ArcGIS Server Security, this is</span>
<span class="sd">            different from generating a token from the admin side. Meant</span>
<span class="sd">            for external use.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: URL to services directory or individual map service.</span>
<span class="sd">        user: Username credentials for ArcGIS Server.</span>
<span class="sd">        pw: Password credentials for ArcGIS Server.</span>
<span class="sd">        expiration: Optional arg for time (in minutes) for token lifetime. </span>
<span class="sd">            Max is 100. Defaults to 60.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The token for security.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;/rest/info&#39;</span>
    <span class="n">isAdmin</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;/admin/&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">isAdmin</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;/rest/admin/&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">infoUrl</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/rest/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">infoUrl</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">suffix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">infoUrl</span> <span class="o">=</span>  <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/rest&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">suffix</span>
    <span class="c1"># print(&#39;infoUrl is: &quot;{}&quot;&#39;.format(infoUrl))</span>
    <span class="n">infoResp</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="n">infoUrl</span><span class="p">)</span>
    <span class="n">is_agol</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_portal</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">PORTAL_BASE_PATTERN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">AUTH_INFO</span> <span class="ow">in</span> <span class="n">infoResp</span> <span class="ow">and</span> <span class="n">TOKEN_SERVICES_URL</span> <span class="ow">in</span> <span class="n">infoResp</span><span class="p">[</span><span class="n">AUTH_INFO</span><span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">infoResp</span><span class="p">[</span><span class="n">AUTH_INFO</span><span class="p">][</span><span class="n">TOKEN_SERVICES_URL</span><span class="p">]</span>
        <span class="n">is_agol</span> <span class="o">=</span> <span class="n">AGOL_BASE</span> <span class="ow">in</span> <span class="n">base</span>
        <span class="k">if</span> <span class="n">is_agol</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">AGOL_TOKEN_SERVICE</span>

        <span class="k">global</span> <span class="n">PROTOCOL</span>
        <span class="n">PROTOCOL</span> <span class="o">=</span>  <span class="n">base</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set PROTOCOL to &quot;</span><span class="si">{}</span><span class="s1">&quot; from generate token&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PROTOCOL</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shortLived</span> <span class="o">=</span> <span class="n">infoResp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">AUTH_INFO</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SHORT_LIVED_TOKEN_VALIDITY</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">60</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">shortLived</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/rest/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/tokens&#39;</span>
        <span class="n">shortLived</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
              <span class="n">USER_NAME</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
              <span class="n">PASSWORD</span><span class="p">:</span> <span class="n">pw</span><span class="p">,</span>
              <span class="n">CLIENT</span><span class="p">:</span> <span class="n">REQUEST_IP</span><span class="p">,</span>
              <span class="n">EXPIRATION</span><span class="p">:</span> <span class="nb">max</span><span class="p">([</span><span class="n">expiration</span><span class="p">,</span> <span class="n">shortLived</span><span class="p">])}</span>

    <span class="k">if</span> <span class="n">is_agol</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">REFERER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">REFERER</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGOL_BASE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">REFERER</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">REFERER</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="n">CLIENT</span><span class="p">]</span>
    
    <span class="k">elif</span> <span class="n">REFERER</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CLIENT</span><span class="p">)</span> <span class="o">==</span> <span class="n">REFERER</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">CLIENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">REFERER</span>
        <span class="n">params</span><span class="p">[</span><span class="n">REFERER</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">REFERER</span><span class="p">)</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">org_resp</span><span class="p">,</span> <span class="n">portal_resp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_agol</span><span class="p">:</span>
        <span class="c1"># now call portal sharing</span>
        <span class="n">portal_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">TOKEN</span><span class="p">:</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">)}</span>
        <span class="n">org_resp</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="n">AGOL_PORTAL_SELF</span><span class="p">,</span> <span class="n">portal_params</span><span class="p">)</span>
        <span class="n">org_referer</span> <span class="o">=</span> <span class="n">org_resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL_KEY</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ORG_MAPS</span>
        <span class="n">params</span><span class="p">[</span><span class="n">REFERER</span><span class="p">]</span><span class="o">=</span> <span class="n">org_referer</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="n">AGOL_TOKEN_SERVICE</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">PORTAL_INFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">org_resp</span>
        <span class="c1"># print(&#39;PORTAL RESP (AGOL): &#39;, org_resp)</span>

    <span class="k">if</span> <span class="n">is_portal</span><span class="p">:</span>
        <span class="c1"># print(&#39;url before: &quot;{}&quot;&#39;.format(url))</span>
        <span class="n">portalBase</span> <span class="o">=</span> <span class="n">get_portal_base</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># print(&#39;portal_base is: &quot;{}&quot;&#39;.format(portalBase))</span>
        <span class="n">portal_url</span> <span class="o">=</span> <span class="n">portalBase</span> <span class="o">+</span> <span class="s1">&#39;/rest/portals/self&#39;</span>
        <span class="c1"># print(&#39;portal self url: &quot;{}&quot;&#39;.format(portal_url))</span>
        <span class="n">portal_resp</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="n">portal_url</span><span class="p">,</span> <span class="p">{</span><span class="n">TOKEN</span><span class="p">:</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">)})</span>
        <span class="c1"># print(&#39;PORTAL RESP (ENT): &#39;, portal_resp)</span>
        <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">PORTAL_INFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">portal_resp</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">portalBase</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">PORTAL_INFO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s1">&#39;/services/&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/services/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/services&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;/admin/&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/admin&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">DOMAIN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
            <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
    <span class="n">resp</span><span class="p">[</span><span class="n">IS_AGOL</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_agol</span>
    <span class="n">resp</span><span class="p">[</span><span class="n">IS_PORTAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_portal</span>
    <span class="n">resp</span><span class="p">[</span><span class="n">IS_ADMIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">isAdmin</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_portal</span><span class="p">:</span>
        <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">_portal_tokens</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>

    <span class="c1"># also register portal or org services domain</span>
    <span class="k">for</span> <span class="n">p_resp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">org_resp</span><span class="p">,</span> <span class="n">portal_resp</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_resp</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">org_id</span> <span class="o">=</span> <span class="n">p_resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">org_id</span><span class="p">:</span>
                <span class="c1"># print(&#39;setting portal token: https://services2.arcgis.com/{}/arcgis/rest/services&#39;.format(org_id))</span>
                <span class="n">token_copy</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">({})</span>
                <span class="n">token_copy</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
                <span class="n">serv_url</span> <span class="o">=</span> <span class="s1">&#39;https://services2.arcgis.com/</span><span class="si">{}</span><span class="s1">/arcgis/rest/services&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_id</span><span class="p">)</span>
                <span class="n">token_copy</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">serv_url</span>
                <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">serv_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">token_copy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="get_portal_base"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.get_portal_base">[docs]</a><span class="k">def</span> <span class="nf">get_portal_base</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the portal base URL.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">url</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/sharing&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/sharing/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/sharing&#39;</span> </div>

<div class="viewcode-block" id="generate_elevated_portal_token"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.generate_elevated_portal_token">[docs]</a><span class="k">def</span> <span class="nf">generate_elevated_portal_token</span><span class="p">(</span><span class="n">server_url</span><span class="p">,</span> <span class="n">user_token</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates an elevated portal token.</span>

<span class="sd">    Args:</span>
<span class="sd">        server_url: URL for the server.</span>
<span class="sd">        user_token: User token.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        The elevated portal token.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">TOKEN</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_token</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="k">else</span> <span class="n">user_token</span><span class="p">,</span>
        <span class="s2">&quot;serverURL&quot;</span><span class="p">:</span> <span class="n">server_url</span><span class="p">,</span>
        <span class="n">EXPIRATION</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXPIRATION</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1440</span><span class="p">,</span>
        <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s1">&#39;getToken&#39;</span><span class="p">,</span>
        <span class="n">REFERER</span><span class="p">:</span> <span class="s1">&#39;http&#39;</span>
    <span class="p">}</span>

    <span class="c1"># first get portal info</span>
    <span class="n">portalBase</span> <span class="o">=</span> <span class="n">get_portal_base</span><span class="p">(</span><span class="n">server_url</span><span class="p">)</span>
    <span class="n">token_url</span> <span class="o">=</span> <span class="n">portalBase</span> <span class="o">+</span> <span class="s1">&#39;/rest/generateToken&#39;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="n">token_url</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">PORTAL_INFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">_portal_tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">portalBase</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">PORTAL_INFO</span><span class="p">)</span>

    <span class="c1"># set domain and other token props</span>
    <span class="k">if</span> <span class="s1">&#39;/services/&#39;</span> <span class="ow">in</span> <span class="n">server_url</span><span class="p">:</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/services/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/services&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;/admin/&#39;</span> <span class="ow">in</span> <span class="n">server_url</span><span class="p">:</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/admin/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/admin&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span><span class="p">[</span><span class="n">DOMAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_url</span>
    <span class="n">resp</span><span class="p">[</span><span class="n">IS_PORTAL</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">resp</span><span class="p">[</span><span class="n">IS_AGOL</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resp</span><span class="p">[</span><span class="n">IS_ADMIN</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="RestapiEncoder"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RestapiEncoder">[docs]</a><span class="k">class</span> <span class="nc">RestapiEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encoder for restapi objects to make serializeable for JSON.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="RestapiEncoder.default"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RestapiEncoder.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encodes object for JSON.</span>
<span class="sd">        </span>
<span class="sd">        Arg:</span>
<span class="sd">            o: Object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TRUE</span>
        <span class="k">if</span> <span class="n">o</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FALSE</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">date_to_mil</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">JSON</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">JSON</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">o</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span></div></div>

<div class="viewcode-block" id="NameEncoder"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.NameEncoder">[docs]</a><span class="k">class</span> <span class="nc">NameEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;encoder for restapi objects to make serializeable for JSON&quot;&quot;&quot;</span>
<div class="viewcode-block" id="NameEncoder.default"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.NameEncoder.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encodes object for JSON.</span>
<span class="sd">        </span>
<span class="sd">        Arg:</span>
<span class="sd">            o: Object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></div></div>

<div class="viewcode-block" id="JsonGetter"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.JsonGetter">[docs]</a><span class="k">class</span> <span class="nc">JsonGetter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overrides getters to also check its json property.&quot;&quot;&quot;</span>
    <span class="n">json</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="JsonGetter.get"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.JsonGetter.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets an attribute from json.</span>

<span class="sd">        Arg:</span>
<span class="sd">            name: Name of attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonGetter.dump"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.JsonGetter.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump as JSON file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            out_json_file: The path for the output json file.</span>
<span class="sd">            indent: Optional arg for amount to indent by in JSON. Default is 2.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The outpath for the JSON.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out_json_file</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">out_json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_json_file</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_json_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tail</span> <span class="o">==</span> <span class="s1">&#39;.json&#39;</span><span class="p">:</span>
                <span class="n">out_json_file</span> <span class="o">=</span> <span class="n">head</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_json_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cls&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RestapiEncoder</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_json_file</span></div>

<div class="viewcode-block" id="JsonGetter.dumps"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.JsonGetter.dumps">[docs]</a>    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump as string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cls&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RestapiEncoder</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensure_ascii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dict like access to json definition.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets normal class attributes and those from json response.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># it is a class attribute</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># it is in the json definition, abstract it to the class level</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">RestapiEncoder</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">NameEncoder</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RESTEndpoint"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RESTEndpoint">[docs]</a><span class="k">class</span> <span class="nc">RESTEndpoint</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base REST Endpoint Object to handle credentials and get JSON response.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">raw_response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">json</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_cookie</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_proxy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_referer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with login info for service URL.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: Service url.</span>
<span class="sd">        Below args only required if security is enabled:</span>
<span class="sd">            usr: Username credentials for ArcGIS Server.</span>
<span class="sd">            pw: Password credentials for ArcGIS Server.</span>
<span class="sd">            token: Token to handle security (alternative to usr and pw).</span>
<span class="sd">            proxy: Option to use proxy page to handle security, need to provide</span>
<span class="sd">                full path to proxy url.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">PROTOCOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">PROTOCOL</span> <span class="o">+</span> <span class="s1">&#39;://&#39;</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">PROTOCOL</span><span class="p">)</span> <span class="k">else</span> <span class="n">url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># print(&#39;checking url: &#39;, url, fnmatch.fnmatch(url, PORTAL_BASE_PATTERN + &#39;/*&#39;))</span>
        <span class="c1"># if not fnmatch.fnmatch(self.url, PORTAL_SERVICES_PATTERN) and fnmatch.fnmatch(self.url, PORTAL_BASE_PATTERN + &#39;/*&#39;):</span>
        <span class="c1">#     self.url = get_portal_base(self.url) + &#39;/rest&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">BASE_PATTERN</span><span class="p">):</span>
            <span class="n">_plus_services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/arcgis/rest/services&#39;</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">_plus_services</span><span class="p">,</span> <span class="n">BASE_PATTERN</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">_plus_services</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">RequestError</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:{</span><span class="s1">&#39;URL Error&#39;</span><span class="p">:</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; is an invalid ArcGIS REST Endpoint!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)}})</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        
        <span class="c1"># first try to find token based on domain</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="c1"># print(&#39;no token passed, but is there one?&#39;)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">findToken</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># print(&#39;token is now: {}&#39;.format(token))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_referer</span> <span class="o">=</span> <span class="n">referer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">usr</span> <span class="ow">and</span> <span class="n">pw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">findToken</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">isExpired</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Token expired at </span><span class="si">{}</span><span class="s1">! Please sign in again.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">expires</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">isExpired</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">isExpired</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">domain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Token expired at </span><span class="si">{}</span><span class="s1">! Please sign in again.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">expires</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">_cookie</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span> <span class="o">=</span> <span class="p">{</span><span class="n">AGS_TOKEN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">token</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="ow">in</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">proxies</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span> <span class="o">=</span> <span class="n">ID_MANAGER</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">]</span>

        <span class="c1"># fetch url if this is a portal item</span>
        <span class="c1"># if portalId:</span>

        <span class="c1"># make sure token is passed in query string if agol or portal</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">Token</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">IS_AGOL</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">IS_PORTAL</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_response</span> <span class="o">=</span> <span class="n">do_post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">ret_json</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_referer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_response</span><span class="o">.</span><span class="n">elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
        <span class="n">RequestError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>

<div class="viewcode-block" id="RESTEndpoint.compatible_with_version"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RESTEndpoint.compatible_with_version">[docs]</a>    <span class="k">def</span> <span class="nf">compatible_with_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if ArcGIS Server version is compatible with input version. A</span>
<span class="sd">                service is compatible with the version if it is greater than or </span>
<span class="sd">                equal to the input version.</span>

<span class="sd">        Arg:</span>
<span class="sd">            version: Minimum version compatibility as float (ex: 10.3 or 10.31).</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            True if the version is compatible, False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">validate_version</span><span class="p">(</span><span class="n">ver</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">ver</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ver</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ver</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># we want an exception here if it does not match the format</span>
                    <span class="n">whole</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">ver</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">ver</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">whole</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dec</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])]))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">validate_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentVersion</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">validate_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RESTEndpoint.request"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RESTEndpoint.request">[docs]</a>    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper for request to automatically pass in credentials.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">({</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="s1">&#39;token&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cookies&#39;</span><span class="p">:</span> <span class="s1">&#39;_cookie&#39;</span><span class="p">,</span>
            <span class="s1">&#39;proxy&#39;</span><span class="p">:</span> <span class="s1">&#39;_proxy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;referer&#39;</span><span class="p">:</span> <span class="s1">&#39;_referer&#39;</span>
        <span class="p">}):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">do_post</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RESTEndpoint.refresh"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RESTEndpoint.refresh">[docs]</a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refreshes the service.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__get_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_cls</span><span class="p">()</span><span class="o">.</span><span class="vm">__bases__</span>
        <span class="k">while</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
                <span class="n">atts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">bases</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="vm">__bases__</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="n">atts</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpatialReferenceMixin"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.SpatialReferenceMixin">[docs]</a><span class="k">class</span> <span class="nc">SpatialReferenceMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin to allow convenience methods for grabbing the spatial reference from a service.&quot;&quot;&quot;</span>
    <span class="n">json</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_find_wkid</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">in_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursivly search for WKID in a dict/json structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">in_json</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">in_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_find_wkid</span><span class="p">(</span><span class="n">in_json</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">in_json</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">SPATIAL_REFERENCE</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">v</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_find_wkid</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="n">LATEST_WKID</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="n">WKID</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="n">CRS</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PROPERTIES</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="s1">&#39;factoryCode&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="s1">&#39;factoryCode&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spatialReference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWKID</span><span class="p">()</span>

    <span class="nd">@spatialReference</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spatialReference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wkid</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wkid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">WKID</span><span class="p">:</span> <span class="n">wkid</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wkid</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span> <span class="o">=</span> <span class="n">wkid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_spatialReference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the spatial reference dict.&quot;&quot;&quot;</span>
        <span class="n">resp_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">SPATIAL_REFERENCE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">resp_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">EXTENT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">SPATIAL_REFERENCE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">EXTENT</span><span class="p">]:</span>
            <span class="n">resp_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">EXTENT</span><span class="p">][</span><span class="n">SPATIAL_REFERENCE</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">GEOMETRIES</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRIES</span><span class="p">,</span> <span class="p">[])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">resp_d</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SPATIAL_REFERENCE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">CRS</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">resp_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CRS</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">resp_d</span><span class="p">)</span>

<div class="viewcode-block" id="SpatialReferenceMixin.getSR"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.SpatialReferenceMixin.getSR">[docs]</a>    <span class="k">def</span> <span class="nf">getSR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the spatial reference.&quot;&quot;&quot;</span>
        <span class="n">sr_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatialReference</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_wkid</span><span class="p">(</span><span class="n">sr_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sr_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">sr_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WKT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sr</span></div>


<div class="viewcode-block" id="SpatialReferenceMixin.getWKID"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.SpatialReferenceMixin.getWKID">[docs]</a>    <span class="k">def</span> <span class="nf">getWKID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the well known id for service spatial reference.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_wkid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatialReference</span><span class="p">)</span></div>
<span class="c1">##        resp_d = self._spatialReference</span>
<span class="c1">##        for key in [LATEST_WKID, WKID]:</span>
<span class="c1">##            if key in resp_d:</span>
<span class="c1">##                return resp_d[key]</span>

<div class="viewcode-block" id="SpatialReferenceMixin.getWKT"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.SpatialReferenceMixin.getWKT">[docs]</a>    <span class="k">def</span> <span class="nf">getWKT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the well known text (if it exists) for a service.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatialReference</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WKT</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FieldsMixin"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.FieldsMixin">[docs]</a><span class="k">class</span> <span class="nc">FieldsMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">json</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">OIDFieldName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the OID field name if it exists in feature set.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OBJECTID_FIELD</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OBJECTID_FIELD</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OBJECTID_FIELD</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OID</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
           <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ShapeFieldName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the Shape field name if it exists in feature set.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SHAPE</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
           <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">GlobalIdFieldName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the Global ID field name if it exists in feature set.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">GLOBALID_FIELD</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">GLOBALID</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
           <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fieldLookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience property for field lookups.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>

<div class="viewcode-block" id="FieldsMixin.list_fields"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.FieldsMixin.list_fields">[docs]</a>    <span class="k">def</span> <span class="nf">list_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of field names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="FeatureSetBase"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.FeatureSetBase">[docs]</a><span class="k">class</span> <span class="nc">FeatureSetBase</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">,</span> <span class="n">SpatialReferenceMixin</span><span class="p">,</span> <span class="n">FieldsMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Class for feature set.&quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns for if it has geometry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRY</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns total number of records in Cursor (user queried).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Supports grabbing feature by index and json keys by name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Feature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Feature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">feature</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1"> (count: </span><span class="si">{}</span><span class="s1">)&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span></div>


<div class="viewcode-block" id="FeatureSet"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.FeatureSet">[docs]</a><span class="k">class</span> <span class="nc">FeatureSet</span><span class="p">(</span><span class="n">FeatureSetBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles feature sets.&quot;&quot;&quot;</span>
    <span class="n">_format</span> <span class="o">=</span> <span class="n">ESRI_JSON_FORMAT</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits Class with input JSON for feature set.</span>

<span class="sd">        Arg:</span>
<span class="sd">            in_json: Input json response from request.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: &#39;Not a valid Feature Set!&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_json</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_json</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">in_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">in_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">in_json</span><span class="o">.</span><span class="n">json</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">[</span><span class="n">FIELDS</span><span class="p">,</span> <span class="n">FEATURES</span><span class="p">])):</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a valid Feature Set!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="FeatureSet.extend"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.FeatureSet.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combines features from another FeatureSet with this one.</span>

<span class="sd">        Arg:</span>
<span class="sd">            other: Other FeatureSet to combine with this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">FeatureSet</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">otherCopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="c1"># get max oid</span>
        <span class="n">oidF</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OID_FIELD_NAME</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OID_FIELD_NAME</span><span class="p">)</span> <span class="k">else</span> <span class="n">OBJECTID</span>
        <span class="n">nextOID</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">ft</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oidF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fields</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">list_fields</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">otherCopy</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ft</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oidF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nextOID</span><span class="p">:</span>
                    <span class="n">ft</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">oidF</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextOID</span>
                    <span class="n">nextOID</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">otherCopy</span><span class="o">.</span><span class="n">features</span><span class="p">)</span></div>

<div class="viewcode-block" id="FeatureSet.getEmptyCopy"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.FeatureSet.getEmptyCopy">[docs]</a>    <span class="k">def</span> <span class="nf">getEmptyCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets an empty copy of a feature set.&quot;&quot;&quot;</span>
        <span class="n">fsd</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">Munch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">FIELDS</span><span class="p">:</span>
                <span class="n">fsd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">FEATURES</span><span class="p">:</span>
                <span class="n">fsd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">fsd</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">FeatureSet</span><span class="p">(</span><span class="n">fsd</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GeoJSONFeatureSet"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeoJSONFeatureSet">[docs]</a><span class="k">class</span> <span class="nc">GeoJSONFeatureSet</span><span class="p">(</span><span class="n">FeatureSetBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles Geo JSON feature set.&quot;&quot;&quot;</span>
    <span class="n">_format</span> <span class="o">=</span> <span class="n">GEOJSON_FORMAT</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with JSON as geo feature set.</span>

<span class="sd">        Arg:</span>
<span class="sd">            in_json: Input json response from request.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_json</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">in_json</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">in_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">in_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">in_json</span><span class="o">.</span><span class="n">json</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_json</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>


<div class="viewcode-block" id="GeoJSONFeatureSet.extend"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeoJSONFeatureSet.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combines features from another FeatureSet with this one.</span>

<span class="sd">        Arg:</span>
<span class="sd">            other: Other FeatureSet to combine with this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GeoJSONFeatureSet</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">GeoJSONFeatureSet</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">otherCopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="c1"># get max oid</span>
        <span class="n">oidF</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OID_FIELD_NAME</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">OID_FIELD_NAME</span><span class="p">)</span> <span class="k">else</span> <span class="n">OBJECTID</span>
        <span class="n">nextOID</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">ft</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oidF</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_fields</span><span class="p">())</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">list_fields</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">otherCopy</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ft</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oidF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nextOID</span><span class="p">:</span>
                    <span class="n">ft</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">oidF</span><span class="p">]</span> <span class="o">=</span> <span class="n">nextOID</span>
                    <span class="n">nextOID</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">otherCopy</span><span class="o">.</span><span class="n">features</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoJSONFeatureSet.getEmptyCopy"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeoJSONFeatureSet.getEmptyCopy">[docs]</a>    <span class="k">def</span> <span class="nf">getEmptyCopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets an empty copy of a feature set.&quot;&quot;&quot;</span>
        <span class="n">fsd</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">Munch</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">FEATURES</span><span class="p">:</span>
                <span class="n">fsd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">fsd</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">GeoJSONFeatureSet</span><span class="p">(</span><span class="n">fsd</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Feature"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.Feature">[docs]</a><span class="k">class</span> <span class="nc">Feature</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that represents a single feature.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits the class with a feature.</span>

<span class="sd">        Arg:</span>
<span class="sd">            feature: Input json for feature.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

<div class="viewcode-block" id="Feature.get"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.Feature.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns/gets an attribute from the feature.</span>

<span class="sd">        Arg:</span>
<span class="sd">            field: Name of field for which to get attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ATTRIBUTES</span><span class="p">,</span> <span class="n">GEOMETRY</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ATTRIBUTES</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span></div>

<div class="viewcode-block" id="RelatedRecords"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RelatedRecords">[docs]</a><span class="k">class</span> <span class="nc">RelatedRecords</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">,</span> <span class="n">SpatialReferenceMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles related records response.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        json: JSON object</span>
<span class="sd">        geometryType: Type of geometry form JSON.</span>
<span class="sd">        spatialReference: Spatial reference from JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with json for query related records.</span>

<span class="sd">        Arg:</span>
<span class="sd">            in_json: json response for query related records operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">in_json</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometryType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">GEOMETRY_TYPE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatialReference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SPATIAL_REFERENCE</span><span class="p">)</span>

<div class="viewcode-block" id="RelatedRecords.list_related_OIDs"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RelatedRecords.list_related_OIDs">[docs]</a>    <span class="k">def</span> <span class="nf">list_related_OIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all related object IDs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;objectId&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span></div>

<div class="viewcode-block" id="RelatedRecords.get_related_records"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RelatedRecords.get_related_records">[docs]</a>    <span class="k">def</span> <span class="nf">get_related_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the related records for an object id.</span>

<span class="sd">        Arg:</span>
<span class="sd">            oid: Object ID for related records.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            The related records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">oid</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;objectId&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">Feature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="n">RELATED_RECORDS</span><span class="p">]]</span></div>

<div class="viewcode-block" id="RelatedRecords.toFeatureSet"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RelatedRecords.toFeatureSet">[docs]</a>    <span class="k">def</span> <span class="nf">toFeatureSet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts to feature set.&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">RELATED_RECORDS</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">FeatureSet</span><span class="p">({</span><span class="n">FIELDS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">FEATURES</span><span class="p">:</span> <span class="n">features</span><span class="p">})</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">RELATED_RECORD_GROUPS</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="n">group</span></div>

<div class="viewcode-block" id="BaseService"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.BaseService">[docs]</a><span class="k">class</span> <span class="nc">BaseService</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">,</span> <span class="n">SpatialReferenceMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all services.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">referer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with login info for service.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: URL of service.</span>
<span class="sd">            usr: Username for service. Defaults to &#39;&#39;.</span>
<span class="sd">            pw: Password for service. Defaults to &#39;&#39;.</span>
<span class="sd">            token: Token for service. Defaults to &#39;&#39;.</span>
<span class="sd">            proxy: Optional proxy for service. Defaults to None.</span>
<span class="sd">            referer: Optional referer from request, defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseService</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">usr</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">referer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with service name.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qualified_name</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/services/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">qualified_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="OrderedDict2"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.OrderedDict2">[docs]</a><span class="k">class</span> <span class="nc">OrderedDict2</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for OrderedDict.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We want it to look like a dictionary.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="PortalInfo"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.PortalInfo">[docs]</a><span class="k">class</span> <span class="nc">PortalInfo</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that handles portal info.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with response from server.</span>
<span class="sd">        </span>
<span class="sd">        Arg:</span>
<span class="sd">            response: The response from server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">response</span>
        <span class="c1">#super(PortalInfo, self).__init__(response)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER_NAME</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fullName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FULL_NAME</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL_KEY</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ORG_MAPS</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">org</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL_KEY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;PortaInfo: </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span></div>

<div class="viewcode-block" id="Token"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.Token">[docs]</a><span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle token authentication.&quot;&quot;&quot;</span>
    <span class="n">_portal</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Response JSON object from generate_token.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span> <span class="o">=</span> <span class="p">{</span><span class="n">AGS_TOKEN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_portal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PORTAL_INFO</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;_portalInfo&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">_portalInfo</span>
<span class="c1">##        self.isAGOL = self.json.get(IS_AGOL, False)</span>
<span class="c1">##        self.isAdmin = self.json.get(IS_ADMIN, False)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">portalInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PortalInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_portal</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">portalUser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">portalInfo</span><span class="p">,</span> <span class="n">PortalInfo</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">portalInfo</span><span class="o">.</span><span class="n">username</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_expires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mil_to_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expires</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isExpired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean value for expired or not.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_expires</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns token as string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span></div>

<div class="viewcode-block" id="RequestError"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.RequestError">[docs]</a><span class="k">class</span> <span class="nc">RequestError</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle restapi request errors.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>

<div class="viewcode-block" id="Folder"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.Folder">[docs]</a><span class="k">class</span> <span class="nc">Folder</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle ArcGIS REST Folder.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the folder name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="Folder.list_services"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.Folder.list_services">[docs]</a>    <span class="k">def</span> <span class="nf">list_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to list services.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns number of services in folder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if services are present.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="GPResult"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GPResult">[docs]</a><span class="k">class</span> <span class="nc">GPResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle GP Result.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler for GP result.</span>

<span class="sd">        response: JSON response from GP Task execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="n">RequestError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">RESULTS</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
           <span class="k">return</span> <span class="p">[</span><span class="n">namedTuple</span><span class="p">(</span><span class="s1">&#39;Result&#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="n">RESULTS</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a value (if any) from results.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">VALUE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="n">VALUE</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns messages as JSON.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;messages&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">namedTuple</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="GPResult.print_messages"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GPResult.print_messages">[docs]</a>    <span class="k">def</span> <span class="nf">print_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints all the GP messages.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Message Type: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Description: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">description</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns length of results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns result at index, usually will only be 1.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="GeocodeResult"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeocodeResult">[docs]</a><span class="k">class</span> <span class="nc">GeocodeResult</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">,</span> <span class="n">SpatialReferenceMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle Reverse Geocode Result.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_dict</span><span class="p">,</span> <span class="n">geo_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Geocode response object.</span>

<span class="sd">        Args:</span>
<span class="sd">            res_dict: JSON response from geocode request</span>
<span class="sd">            geo_type: Type of geocode operation </span>
<span class="sd">                (reverseGeocode|findAddressCandidates|geocodeAddresses).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">RequestError</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeocodeResult</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">res_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;esri_&#39;</span> <span class="o">+</span> <span class="n">geo_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns list of result objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;esri_findAddressCandidates&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidates</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;esri_reverseGeocode&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">LOCATIONS</span><span class="p">,</span> <span class="p">[])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the top result.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows for indexing of results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns count of results.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterator for results (as generator).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if results are returned.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> match</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;es&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EditResult"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.EditResult">[docs]</a><span class="k">class</span> <span class="nc">EditResult</span><span class="p">(</span><span class="n">JsonGetter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle Edit operation results.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_dict</span><span class="p">,</span> <span class="n">feature_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inits class with response</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            res_dict: Dictionary of response. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">RequestError</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">munch</span><span class="o">.</span><span class="n">munchify</span><span class="p">(</span><span class="n">res_dict</span><span class="p">)</span>

<div class="viewcode-block" id="EditResult.success_count"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.EditResult.success_count">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">success_count</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns number of successful attempts.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SUCCESS_STATUS</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)])</span></div>

<div class="viewcode-block" id="EditResult.summary"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.EditResult.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints summary of edit operation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ADD_RESULTS</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Added </span><span class="si">{}</span><span class="s1"> feature(s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ADD_RESULTS</span><span class="p">))))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">UPDATE_RESULTS</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated </span><span class="si">{}</span><span class="s1"> feature(s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">UPDATE_RESULTS</span><span class="p">))))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DELETE_RESULTS</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleted </span><span class="si">{}</span><span class="s1"> feature(s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DELETE_RESULTS</span><span class="p">))))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ATTACHMENTS</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attachment Edits: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_count</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ATTACHMENTS</span><span class="p">))))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ADD_ATTACHMENT_RESULT</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ADD_ATTACHMENT_RESULT</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Added attachment &#39;</span><span class="si">{}</span><span class="s2">&#39; for feature </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="c1"># should never happen?</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Added 1 attachment&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">DELETE_ATTACHMENT_RESULTS</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DELETE_ATTACHMENT_RESULTS</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SUCCESS_STATUS</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleted attachment &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RESULT_OBJECT_ID</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to Delete attachment &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RESULT_OBJECT_ID</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="c1"># should never happen?</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleted </span><span class="si">{}</span><span class="s1"> attachment(s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DELETE_ATTACHMENT_RESULT</span><span class="p">))))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">UPDATE_ATTACHMENT_RESULT</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updated attachment &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">UPDATE_ATTACHMENT_RESULT</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">RESULT_OBJECT_ID</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="c1"># should never happen?</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated 1 attachment&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="BaseGeometry"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.BaseGeometry">[docs]</a><span class="k">class</span> <span class="nc">BaseGeometry</span><span class="p">(</span><span class="n">SpatialReferenceMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base geometry obect.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BaseGeometry.dumps"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.BaseGeometry.dumps">[docs]</a>    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns JSON as a string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;ensure_ascii&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensure_ascii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BaseGeometryCollection"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.BaseGeometryCollection">[docs]</a><span class="k">class</span> <span class="nc">BaseGeometryCollection</span><span class="p">(</span><span class="n">SpatialReferenceMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Geometry Collection.&quot;&quot;&quot;</span>
    <span class="n">geometries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">json</span> <span class="o">=</span> <span class="p">{</span><span class="n">GEOMETRIES</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">geometryType</span> <span class="o">=</span> <span class="n">NULL</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="BaseGeometryCollection.dumps"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.BaseGeometryCollection.dumps">[docs]</a>    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns JSON as a string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;ensure_ascii&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensure_ascii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometries</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">geometry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometries</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">geometry</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geometries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;restapi.GeometryCollection (</span><span class="si">{}</span><span class="s1">): [</span><span class="si">{}</span><span class="s1">]&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometryType</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeocodeService"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeocodeService">[docs]</a><span class="k">class</span> <span class="nc">GeocodeService</span><span class="p">(</span><span class="n">RESTEndpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to handle Geocode Service.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GeocodeService.geocodeAddresses"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeocodeService.geocodeAddresses">[docs]</a>    <span class="k">def</span> <span class="nf">geocodeAddresses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">outSR</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span> <span class="n">address_field</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Geocodes a list of addresses.  If there is a singleLineAddress field </span>
<span class="sd">                present in the geocoding service, the only input required is a </span>
<span class="sd">                list of addresses.  Otherwise, a record set an be passed in for </span>
<span class="sd">                the &quot;recs&quot; parameter.  See formatting example at bottom.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            recs: JSON object for fields as record set if no SingleLine field </span>
<span class="sd">                available. If singleLineAddress is present a list of full addresses </span>
<span class="sd">                can be passed in.</span>
<span class="sd">            outSR: Optional output spatial refrence for geocoded addresses.</span>
<span class="sd">            address_field: Name of address field or Single Line address field.</span>
<span class="sd">        </span>
<span class="sd">        # recs param examples</span>
<span class="sd">        # preferred option as record set (from esri help docs):</span>
<span class="sd">        recs = {</span>
<span class="sd">            &quot;records&quot;: [</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;attributes&quot;: {</span>
<span class="sd">                        &quot;OBJECTID&quot;: 1,</span>
<span class="sd">                        &quot;STREET&quot;: &quot;440 Arguello Blvd&quot;,</span>
<span class="sd">                        &quot;ZONE&quot;: &quot;94118&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                },</span>
<span class="sd">           {</span>
<span class="sd">                    &quot;attributes&quot;: {</span>
<span class="sd">                        &quot;OBJECTID&quot;: 2,</span>
<span class="sd">                        &quot;STREET&quot;: &quot;450 Arguello Blvd&quot;,</span>
<span class="sd">                        &quot;ZONE&quot;: &quot;94118&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>
<span class="sd">        # full address list option if singleLineAddressField is present</span>
<span class="sd">        recs = [&#39;100 S Riverfront St, Mankato, MN 56001&#39;,..]</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: &#39;Not a valid input for &quot;recs&quot; parameter!&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            The geocode result.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">geo_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/geocodeAddresses&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">addr_list</span> <span class="o">=</span> <span class="n">recs</span><span class="p">[:]</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="p">{</span><span class="n">RECORDS</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">address_field</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;singleLineAddressField&#39;</span><span class="p">):</span>
                    <span class="n">address_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleLineAddressField</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">address_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addressFields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning, no singleLineAddressField found...Using &quot;</span><span class="si">{}</span><span class="s1">&quot; field&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address_field</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">addr_list</span><span class="p">):</span>
                <span class="n">recs</span><span class="p">[</span><span class="n">RECORDS</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">ATTRIBUTES</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;OBJECTID&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">address_field</span><span class="p">:</span> <span class="n">addr</span><span class="p">}})</span>

        <span class="c1"># validate recs, make sure OBECTID is present</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">RECORDS</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="n">RECORDS</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">OBJECTID</span> <span class="ow">in</span> <span class="n">atts</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">]:</span>
                    <span class="n">atts</span><span class="p">[</span><span class="n">ATTRIBUTES</span><span class="p">][</span><span class="n">OBJECTID</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">#do not start at 0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a valid input for &quot;recs&quot; parameter!&#39;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">ADDRESSES</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                      <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span><span class="p">,</span>
                      <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">GeocodeResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">geo_url</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">geo_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="GeocodeService.reverseGeocode"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeocodeService.reverseGeocode">[docs]</a>    <span class="k">def</span> <span class="nf">reverseGeocode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">outSR</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span> <span class="n">returnIntersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">langCode</span><span class="o">=</span><span class="s1">&#39;eng&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reverse geocodes an address by x, y coordinates.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            location: Input point object as JSON</span>
<span class="sd">            distance: Distance in meters from given location which a matching </span>
<span class="sd">                address will be found. Default is 100.</span>
<span class="sd">            outSR: WKID for output address. Default is 4326.</span>
<span class="sd">            langCode: Optional language code, default is eng </span>
<span class="sd">                (only used for StreMap Premium locators).</span>
<span class="sd">            returnIntersection: Optional boolean, if True, will return an </span>
<span class="sd">                intersection. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">geo_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/reverseGeocode&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">LOCATION</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
                  <span class="n">DISTANCE</span><span class="p">:</span> <span class="n">distance</span><span class="p">,</span>
                  <span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span><span class="p">,</span>
                  <span class="n">RETURN_INTERSECTION</span><span class="p">:</span> <span class="n">returnIntersection</span><span class="p">,</span>
                  <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">GeocodeResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">geo_url</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">geo_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="GeocodeService.findAddressCandidates"><a class="viewcode-back" href="../../../restapi/#restapi.rest_utils.GeocodeService.findAddressCandidates">[docs]</a>    <span class="k">def</span> <span class="nf">findAddressCandidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">outSR</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span> <span class="n">outFields</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">returnIntersection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds address candidates for an anddress.</span>

<span class="sd">        Args:</span>
<span class="sd">            address: Full address (380 New York Street, Redlands, CA 92373).</span>
<span class="sd">            outFields: List of fields for output. Default is * for all fields. Will</span>
<span class="sd">                accept either list of fields [], or comma separated string.</span>
<span class="sd">            outSR: wkid for output address. Defaults to 4326.</span>
<span class="sd">            **kwargs: key word arguments to use for Address, City, State, etc </span>
<span class="sd">                fields if no SingleLine field.</span>
<span class="sd">            returnIntersection: Optional boolean, if True, will return an </span>
<span class="sd">                intersection. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">geo_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/findAddressCandidates&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">OUT_SR</span><span class="p">:</span> <span class="n">outSR</span><span class="p">,</span>
                  <span class="n">OUT_FIELDS</span><span class="p">:</span> <span class="n">outFields</span><span class="p">,</span>
                  <span class="n">RETURN_INTERSECTION</span><span class="p">:</span> <span class="n">returnIntersection</span><span class="p">,</span>
                  <span class="n">F</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;singleLineAddressField&#39;</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">singleLineAddressField</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">addressFields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fld_name</span><span class="p">,</span> <span class="n">fld_query</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">params</span><span class="p">[</span><span class="n">fld_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fld_query</span>

        <span class="k">return</span> <span class="n">GeocodeResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">geo_url</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">geo_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation with service name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;GeocodeService: </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/services/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../">restapi</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../">Documentation overview</a><ul>
  <li><a href="../../">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Caleb Mackey.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>